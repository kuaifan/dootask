import{m as g,a as q}from"./vuex.cc7cb26e.js";import{n as u,b as z,U as P,c as W,i as H}from"./app.267f43a2.js";import{l as $}from"./le5le-store.b40f9152.js";import{l as w}from"./longpress.5305f240.js";import{D as Q}from"./index.1e2af562.js";import{Q as v}from"./quill-hi.b7c37d93.js";import"./quill-mention-hi.f348056f.js";import{o as K}from"./vue-jsonp.be27271b.js";import{V as G}from"./vue.c448ed56.js";import{i as Y}from"./view-design-hi.1da2501e.js";import{V as J}from"./vue-virtual-scroll-list-hi.295e5d02.js";import{I as B}from"./ImgUpload.91168865.js";import X from"./details.b8812ae3.js";import{U as Z}from"./tip.133279ce.js";var tt=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{staticClass:"common-circle",style:t.style,attrs:{"data-id":t.percent}},[e("svg",{attrs:{viewBox:"0 0 28 28"}},[e("g",{attrs:{fill:"none","fill-rule":"evenodd"}},[e("path",{staticClass:"common-circle-path",attrs:{d:"M-500-100h997V48h-997z"}}),e("g",{attrs:{"fill-rule":"nonzero"}},[e("path",{staticClass:"common-circle-g-path-ring",attrs:{"stroke-width":"3",d:"M14 25.5c6.351 0 11.5-5.149 11.5-11.5S20.351 2.5 14 2.5 2.5 7.649 2.5 14 7.649 25.5 14 25.5z"}}),e("path",{staticClass:"common-circle-g-path-core",attrs:{d:t.arc(t.args)}})])])])])},et=[];const st={name:"WCircle",props:{percent:{type:Number,default:0},size:{type:Number,default:120}},computed:{style(){let{size:t}=this;return this.isNumeric(t)&&(t+="px"),{width:t,height:t}},args(){const{percent:t}=this;let i=Math.min(360,360/100*t);return i==360?i=0:i==0&&(i=360),{x:14,y:14,r:14,start:360,end:i}}},methods:{isNumeric(t){return t!==""&&!isNaN(parseFloat(t))&&isFinite(t)},point(t,i,e,s){return[(t+Math.sin(s)*e).toFixed(2),(i-Math.cos(s)*e).toFixed(2)]},full(t,i,e,s){return s<=0?`M ${t-e} ${i} A ${e} ${e} 0 1 1 ${t+e} ${i} A ${e} ${e} 1 1 1 ${t-e} ${i} Z`:`M ${t-e} ${i} A ${e} ${e} 0 1 1 ${t+e} ${i} A ${e} ${e} 1 1 1 ${t-e} ${i} M ${t-s} ${i} A ${s} ${s} 0 1 1 ${t+s} ${i} A ${s} ${s} 1 1 1 ${t-s} ${i} Z`},part(t,i,e,s,a,o){const[r,n]=[a/360*2*Math.PI,o/360*2*Math.PI],l=[this.point(t,i,s,r),this.point(t,i,e,r),this.point(t,i,e,n),this.point(t,i,s,n)],d=n-r>Math.PI?"1":"0";return`M ${l[0][0]} ${l[0][1]} L ${l[1][0]} ${l[1][1]} A ${e} ${e} 0 ${d} 1 ${l[2][0]} ${l[2][1]} L ${l[3][0]} ${l[3][1]} A ${s} ${s}  0 ${d} 0 ${l[0][0]} ${l[0][1]} Z`},arc(t){const{x:i=0,y:e=0}=t;let{R:s=0,r:a=0,start:o,end:r}=t;return[s,a]=[Math.max(s,a),Math.min(s,a)],s<=0?"":o!==+o||r!==+r?this.full(i,e,s,a):Math.abs(o-r)<1e-6?"":Math.abs(o-r)%360<1e-6?this.full(i,e,s,a):([o,r]=[o%360,r%360],o>r&&(r+=360),this.part(i,e,s,a,o,r))}}},y={};var it=u(st,tt,et,!1,at,null,null,null);function at(t){for(let i in y)this[i]=y[i]}var ot=function(){return it.exports}();var rt=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{staticClass:"markdown-body",domProps:{innerHTML:t._s(t.html)},on:{click:t.onCLick}})},nt=[];const lt={name:"DialogMarkdown",props:{text:{type:String,default:""}},data(){return{mdi:null}},mounted(){this.copyCodeBlock()},updated(){this.copyCodeBlock()},computed:{html({text:t}){return z(t)}},methods:{copyCodeBlock(){this.$el.querySelectorAll(".code-block-wrapper").forEach(i=>{const e=i.querySelector(".code-block-header__copy"),s=i.querySelector(".code-block-body");e&&s&&e.getAttribute("data-copy")!=="click"&&(e.setAttribute("data-copy","click"),e.addEventListener("click",()=>{var a,o,r;(a=navigator.clipboard)!=null&&a.writeText?navigator.clipboard.writeText((o=s.textContent)!=null?o:""):this.copyContent({text:(r=s.textContent)!=null?r:"",origin:!0})}))})},copyContent(t){const i={origin:!0,...t};let e;i.origin?e=document.createElement("textarea"):e=document.createElement("input"),e.setAttribute("readonly","readonly"),e.value=i.text,document.body.appendChild(e),e.select(),document.execCommand("copy")&&document.execCommand("copy"),document.body.removeChild(e)},onCLick(t){this.$emit("click",t)}}},C={};var dt=u(lt,rt,nt,!1,ct,null,null,null);function ct(t){for(let i in C)this[i]=C[i]}var ht=function(){return dt.exports}(),ut=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{staticClass:"dialog-view",class:t.viewClass,attrs:{"data-id":t.msgData.id}},[t.dialogType==="group"?e("div",{staticClass:"dialog-username"},[e("UserAvatar",{attrs:{userid:t.msgData.userid,"show-icon":!1,"show-name":!0,"click-open-dialog":""}})],1):t._e(),e("div",{directives:[{name:"longpress",rawName:"v-longpress",value:{callback:t.handleLongpress,delay:300},expression:"{callback: handleLongpress, delay: 300}"}],staticClass:"dialog-head",class:t.headClass,on:{click:t.handleClick}},[!t.hideReply&&t.msgData.reply_id&&t.showReplyData(t.msgData.msg.reply_data)?e("div",{staticClass:"dialog-reply no-dark-content",on:{click:t.viewReply}},[e("div",{staticClass:"reply-avatar"},[e("UserAvatar",{attrs:{userid:t.msgData.msg.reply_data.userid,"show-icon":!1,"show-name":!0}})],1),e("div",{staticClass:"reply-desc",domProps:{innerHTML:t._s(t.$A.getMsgSimpleDesc(t.msgData.msg.reply_data,"image-preview"))}})]):t._e(),!t.hideForward&&t.msgData.forward_id&&t.showForwardData(t.msgData.msg.forward_data)?e("div",{staticClass:"dialog-reply no-dark-content",on:{click:function(s){return t.openDialog(t.msgData.msg.forward_data.userid)}}},[e("div",{staticClass:"reply-avatar"},[e("UserAvatar",{attrs:{userid:t.msgData.msg.forward_data.userid,"show-icon":!1,"show-name":!0}})],1)]):t._e(),e("div",{ref:"content",staticClass:"dialog-content",class:t.contentClass},[t.msgData.type==="text"?e("div",{staticClass:"content-text no-dark-content"},[t.msgData.msg.type==="md"?e("DialogMarkdown",{attrs:{text:t.msgData.msg.text},on:{click:t.viewText}}):e("pre",{domProps:{innerHTML:t._s(t.$A.formatTextMsg(t.msgData.msg.text,t.userId))},on:{click:t.viewText}})],1):t.msgData.type==="file"?e("div",{class:`content-file ${t.msgData.msg.type}`},[e("div",{staticClass:"dialog-file"},[t.msgData.msg.type==="img"?e("img",{staticClass:"file-img",style:t.imageStyle(t.msgData.msg),attrs:{src:t.msgData.msg.thumb},on:{click:t.viewFile}}):t.isVideoFile(t.msgData.msg)?e("div",{staticClass:"file-video",style:t.imageStyle(t.msgData.msg),on:{click:t.viewFile}},[t.msgData.msg.thumb?e("img",{attrs:{src:t.msgData.msg.thumb}}):e("video",{attrs:{width:t.imageStyle(t.msgData.msg,"width"),height:t.imageStyle(t.msgData.msg,"height")}},[e("source",{attrs:{src:t.msgData.msg.path,type:"video/mp4"}})]),t._m(0)]):e("div",{staticClass:"file-box",on:{click:t.downFile}},[e("img",{staticClass:"file-thumb",attrs:{src:t.msgData.msg.thumb}}),e("div",{staticClass:"file-info"},[e("div",{staticClass:"file-name"},[t._v(t._s(t.msgData.msg.name))]),e("div",{staticClass:"file-size"},[t._v(t._s(t.$A.bytesToSize(t.msgData.msg.size)))])])]),t.msgData.msg.percentage?e("div",{staticClass:"file-percentage"},[e("span",{style:t.fileStyle(t.msgData.msg.percentage)})]):t._e()])]):t.msgData.type==="record"?e("div",{staticClass:"content-record no-dark-content"},[e("div",{staticClass:"dialog-record",class:{playing:t.audioPlaying===t.msgData.msg.path},style:t.recordStyle(t.msgData.msg),on:{click:t.playRecord}},[e("div",{staticClass:"record-time"},[t._v(t._s(t.recordDuration(t.msgData.msg.duration)))]),e("div",{staticClass:"record-icon taskfont"})]),t.msgData.msg.text?e("div",{staticClass:"dialog-record-text"},[t._v(" "+t._s(t.msgData.msg.text)+" ")]):t._e()]):t.msgData.type==="meeting"?e("div",{staticClass:"content-meeting no-dark-content"},[e("ul",{staticClass:"dialog-meeting",class:{"meeting-end":!!t.msgData.msg.end_at}},[e("li",[e("em",[t._v(t._s(t.$L("\u4F1A\u8BAE\u4E3B\u9898")))]),t._v(" "+t._s(t.msgData.msg.name)+" ")]),e("li",[e("em",[t._v(t._s(t.$L("\u4F1A\u8BAE\u521B\u5EFA\u4EBA")))]),e("UserAvatar",{attrs:{userid:t.msgData.msg.userid,"show-icon":!1,"show-name":!0}})],1),e("li",[e("em",[t._v(t._s(t.$L("\u9891\u9053ID")))]),t._v(" "+t._s(t.msgData.msg.meetingid.replace(/^(.{3})(.{3})(.*)$/,"$1 $2 $3"))+" ")]),t.msgData.msg.end_at?e("li",{staticClass:"meeting-operation"},[t._v(" "+t._s(t.$L("\u4F1A\u8BAE\u5DF2\u7ED3\u675F"))+" ")]):e("li",{staticClass:"meeting-operation",on:{click:t.openMeeting}},[t._v(" "+t._s(t.$L("\u70B9\u51FB\u52A0\u5165\u4F1A\u8BAE"))+" "),e("i",{staticClass:"taskfont"},[t._v("\uE68B")])])])]):t.msgData.type==="word-chain"?e("div",{staticClass:"content-text content-word-chain no-dark-content"},[e("pre",{domProps:{innerHTML:t._s(t.$A.formatTextMsg(t.msgData.msg.text,t.userId))}}),e("ul",{class:{expand:t.unfoldWordChainData.indexOf(t.msgData.id)!==-1}},[t._l((t.msgData.msg.list||[]).filter(function(s){return s.type=="case"}),function(s){return e("li",[t._v(" "+t._s(t.$L("\u4F8B"))+" "+t._s(s.text)+" ")])}),t._l((t.msgData.msg.list||[]).filter(function(s){return s.type!="case"&&s.text}),function(s,a){return e("li",[a==2&&t.msgData.msg.list.length>4?e("span",{staticClass:"expand",on:{click:function(o){return t.unfoldWordChain(t.msgData)}}},[t._v(" ..."+t._s(t.$L("\u5C55\u5F00"))+"... ")]):t._e(),e("span",{class:{shrink:a>=2&&t.msgData.msg.list.length>4}},[t._v(" "+t._s(a+1)+". "+t._s(s.text)+" ")])])}),e("li",{staticClass:"participate",on:{click:t.onWordChain}},[t._v(" "+t._s(t.$L("\u53C2\u4E0E\u63A5\u9F99"))+" "),e("i",{staticClass:"taskfont"},[t._v("\uE703")])])],2)]):t.msgData.type==="vote"?e("div",{staticClass:"content-text content-word-vote no-dark-content"},[e("div",{staticClass:"vote-msg-head"},[e("i",{staticClass:"taskfont"},[t._v("\uE7FD")]),e("em",[t._v(t._s(t.$L("\u6295\u7968")))]),e("span",[t._v(t._s(t.msgData.msg.multiple==1?t.$L("\u591A\u9009"):t.$L("\u5355\u9009")))]),e("span",[t._v(t._s(t.msgData.msg.anonymous==1?t.$L("\u533F\u540D"):t.$L("\u5B9E\u540D")))])]),e("pre",{domProps:{innerHTML:t._s(t.$A.formatTextMsg(t.msgData.msg.text,t.userId))}}),(t.msgData.msg.votes||[]).filter(function(s){return s.userid==t.userId}).length==0?[t.msgData.msg.multiple==0?e("RadioGroup",{attrs:{vertical:""},model:{value:t.voteData[t.msgData.msg.uuid],callback:function(s){t.$set(t.voteData,t.msgData.msg.uuid,s)},expression:"voteData[msgData.msg.uuid]"}},t._l(t.msgData.msg.list||[],function(s,a){return e("Radio",{key:a,attrs:{label:s.id}},[t._v(" "+t._s(s.text)+" ")])}),1):e("CheckboxGroup",{model:{value:t.voteData[t.msgData.msg.uuid],callback:function(s){t.$set(t.voteData,t.msgData.msg.uuid,s)},expression:"voteData[msgData.msg.uuid]"}},t._l(t.msgData.msg.list||[],function(s,a){return e("Checkbox",{key:a,attrs:{label:s.id}},[t._v(" "+t._s(s.text)+" ")])}),1),e("div",{staticClass:"btn-row"},[(t.voteData[t.msgData.msg.uuid]||[]).length==0?e("Button",{staticClass:"ivu-btn-grey",attrs:{disabled:""}},[t._v(t._s(t.$L("\u8BF7\u9009\u62E9\u540E\u6295\u7968")))]):e("Button",{staticClass:"no-dark-content",attrs:{type:"warning",loading:t.msgData.msg._loadIng>0},on:{click:function(s){return t.onVote("vote",t.msgData)}}},[t._v(t._s(t.$L("\u7ACB\u5373\u6295\u7968")))])],1)]:[e("div",{staticClass:"vote-result-body"},[e("ul",t._l(t.msgData.msg.list||[],function(s){return e("li",[e("div",{staticClass:"vote-option-title"},[t._v(t._s(s.text))]),e("div",{staticClass:"ticket-num"},[e("span",[t._v(t._s(t.getVoteProgress(t.msgData.msg,s.id).num)+t._s(t.$L("\u7968")))]),e("span",[t._v(t._s(t.getVoteProgress(t.msgData.msg,s.id).progress+"%"))])]),e("Progress",{attrs:{percent:Number(t.getVoteProgress(t.msgData.msg,s.id).progress),"stroke-width":5,"hide-info":""}}),t.msgData.msg.anonymous==0?e("div",{staticClass:"avatar-row"},[t._l((t.msgData.msg.votes||[]).filter(function(a){return a.votes.indexOf(s.id)!=-1}),function(a){return[e("UserAvatar",{attrs:{userid:a.userid,size:18}})]})],2):t._e()],1)}),0)]),t.msgData.msg.state==1&&t.msgData.msg.userid==t.userId?e("div",{staticClass:"btn-row"},[e("Button",{attrs:{type:"warning",loading:t.msgData.msg._loadIng>0},on:{click:function(s){return t.onVote("again",t.msgData)}}},[t._v(t._s(t.$L("\u518D\u6B21\u53D1\u9001")))]),e("Button",{attrs:{type:"warning",loading:t.msgData.msg._loadIng>0},on:{click:function(s){return t.onVote("finish",t.msgData)}}},[t._v(t._s(t.$L("\u7ED3\u675F\u6295\u7968")))])],1):t._e()]],2):t.msgData.type==="loading"?e("div",{staticClass:"content-loading"},[t.msgData.error===!0?e("Icon",{attrs:{type:"ios-alert-outline"}}):e("Loading")],1):e("div",{staticClass:"content-unknown"},[t._v(t._s(t.$L("\u672A\u77E5\u7684\u6D88\u606F\u7C7B\u578B")))])]),t.$A.arrayLength(t.msgData.emoji)>0?e("ul",{staticClass:"dialog-emoji"},t._l(t.msgData.emoji,function(s,a){return e("li",{key:a,class:{hasme:s.userids.includes(t.userId)}},[e("div",{staticClass:"emoji-symbol no-dark-content",on:{click:function(o){return t.onEmoji(s.symbol)}}},[t._v(t._s(s.symbol))]),e("div",{staticClass:"emoji-users",on:{click:function(o){return t.onShowEmojiUser(s)}}},[e("ul",[t._l(s.userids,function(o,r){return[r<t.emojiUsersNum?e("li",{class:{bold:o==t.userId}},[e("UserAvatar",{attrs:{userid:o,"show-name":"","show-icon":!1}})],1):r==t.emojiUsersNum?e("li",[t._v("+"+t._s(s.userids.length-t.emojiUsersNum)+"\u4F4D")]):t._e()]})],2)])])}),0):t._e()]),e("div",{staticClass:"dialog-foot"},[!t.hideReply&&t.msgData.reply_num>0?e("div",{staticClass:"reply",on:{click:t.replyList}},[e("i",{staticClass:"taskfont"},[t._v("\uE6EB")]),t._v(" "+t._s(t.msgData.reply_num)+"\u6761\u56DE\u590D ")]):t._e(),t.msgData.tag?e("div",{staticClass:"tag"},[e("i",{staticClass:"taskfont"},[t._v("\uE61E")])]):t._e(),t.msgData.todo?e("div",{staticClass:"todo",on:{click:t.openTodo}},[e("EPopover",{ref:"todo",attrs:{"popper-class":"dialog-wrapper-read-poptip",placement:t.isRightMsg?"bottom-end":"bottom-start"},model:{value:t.todoShow,callback:function(s){t.todoShow=s},expression:"todoShow"}},[e("div",{staticClass:"read-poptip-content"},[e("Scrollbar",{attrs:{"class-name":"read"}},[e("div",{staticClass:"read-title"},[e("em",[t._v(t._s(t.todoDoneList.length))]),t._v(" "+t._s(t.$L("\u5B8C\u6210"))+" ")]),e("ul",t._l(t.todoDoneList,function(s){return e("li",[e("UserAvatar",{attrs:{userid:s.userid,size:26,showName:""}})],1)}),0)]),e("Scrollbar",{attrs:{"class-name":"unread"}},[e("div",{staticClass:"read-title"},[e("em",[t._v(t._s(t.todoUndoneList.length))]),t._v(" "+t._s(t.$L("\u5F85\u529E"))+" "),e("span",{staticClass:"space"}),e("Button",{attrs:{type:"primary",size:"small"},on:{click:t.handleTodoAdd}},[t._v(t._s(t.$L("\u6DFB\u52A0")))])],1),e("ul",t._l(t.todoUndoneList,function(s){return e("li",[e("UserAvatar",{attrs:{userid:s.userid,size:26,showName:""}})],1)}),0)])],1),e("div",{staticClass:"popover-reference",attrs:{slot:"reference"},slot:"reference"})]),t.todoLoad>0?e("Loading"):e("i",{staticClass:"taskfont"},[t._v("\uE7B7")])],1):t._e(),t.msgData.modify?e("div",{staticClass:"modify"},[e("i",{staticClass:"taskfont"},[t._v("\uE779")])]):t._e(),t.msgData.error===!0?e("div",{staticClass:"error",on:{click:t.onError}},[e("Icon",{attrs:{type:"ios-alert"}})],1):t.isLoading?e("Loading",{attrs:{delay:300}}):[t.timeShow?e("div",{staticClass:"time",on:{click:function(s){t.timeShow=!1}}},[t._v(t._s(t.msgData.created_at))]):e("div",{staticClass:"time",attrs:{title:t.msgData.created_at},on:{click:function(s){t.timeShow=!0}}},[t._v(t._s(t.$A.formatTime(t.msgData.created_at)))]),t.hidePercentage?t._e():[t.msgData.send>1||t.dialogType==="group"?e("div",{staticClass:"percent",on:{click:t.openReadPercentage}},[e("EPopover",{ref:"percent",attrs:{"popper-class":"dialog-wrapper-read-poptip",placement:t.isRightMsg?"bottom-end":"bottom-start"},model:{value:t.percentageShow,callback:function(s){t.percentageShow=s},expression:"percentageShow"}},[e("div",{staticClass:"read-poptip-content"},[e("Scrollbar",{attrs:{"class-name":"read"}},[e("div",{staticClass:"read-title"},[e("em",[t._v(t._s(t.readList.length))]),t._v(" "+t._s(t.$L("\u5DF2\u8BFB"))+" ")]),e("ul",t._l(t.readList,function(s){return e("li",[e("UserAvatar",{attrs:{userid:s.userid,size:26,showName:""}})],1)}),0)]),e("Scrollbar",{attrs:{"class-name":"unread"}},[e("div",{staticClass:"read-title"},[e("em",[t._v(t._s(t.unreadList.length))]),t._v(" "+t._s(t.$L("\u672A\u8BFB"))+" ")]),e("ul",t._l(t.unreadList,function(s){return e("li",[e("UserAvatar",{attrs:{userid:s.userid,size:26,showName:""}})],1)}),0)])],1),e("div",{staticClass:"popover-reference",attrs:{slot:"reference"},slot:"reference"})]),t.percentageLoad>0?e("Loading"):e("WCircle",{attrs:{percent:t.msgData.percentage,size:14}})],1):t.msgData.percentage===100?e("Icon",{staticClass:"done",attrs:{type:"md-done-all"}}):e("Icon",{staticClass:"done",attrs:{type:"md-checkmark"}})]]],2)])},pt=[function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{staticClass:"file-play"},[e("div",{staticClass:"play-icon"},[e("i",{staticClass:"taskfont"},[t._v("\uE745")])])])}];const mt={name:"DialogView",components:{DialogMarkdown:ht,WCircle:ot},directives:{longpress:w},props:{msgData:{type:Object,default:()=>({})},dialogType:{type:String,default:""},hidePercentage:{type:Boolean,default:!1},hideReply:{type:Boolean,default:!1},hideForward:{type:Boolean,default:!1},operateVisible:{type:Boolean,default:!1},operateAction:{type:Boolean,default:!1},isRightMsg:{type:Boolean,default:!1}},data(){return{timeShow:!1,operateEnter:!1,percentageLoad:0,percentageShow:!1,percentageList:[],todoLoad:0,todoShow:!1,todoList:[],emojiUsersNum:5,voteData:{},dotClicks:[],unfoldWordChainData:[]}},mounted(){this.emojiUsersNum=Math.min(6,Math.max(2,Math.floor((this.windowWidth-180)/52))),Object.keys(this.voteData).length===0&&(this.voteData=JSON.parse(window.localStorage.getItem("__cache:vote__"))||{}),this.unfoldWordChainData.length===0&&(this.unfoldWordChainData=JSON.parse(window.localStorage.getItem("__cache:unfoldWordChain__"))||[])},beforeDestroy(){var t;this.$store.dispatch("audioStop",(t=this.msgData.msg)==null?void 0:t.path)},computed:{...g(["loads","audioPlaying"]),...q(["isLoad"]),isLoading(){return this.msgData.created_at?this.isLoad(`msg-${this.msgData.id}`):!0},viewClass(){const{msgData:t,operateAction:i,operateEnter:e}=this,s=[];return t.type&&s.push(t.type),i&&(s.push("operate-action"),e&&s.push("operate-enter")),s},readList(){return this.percentageList.filter(({read_at:t})=>t)},unreadList(){return this.percentageList.filter(({read_at:t})=>!t)},todoDoneList(){return this.todoList.filter(({done_at:t})=>t)},todoUndoneList(){return this.todoList.filter(({done_at:t})=>!t)},headClass(){const{id:t,reply_id:i,type:e,msg:s,emoji:a,dot:o}=this.msgData,r=[];return o&&!this.dotClicks.includes(t)&&r.push("dot"),i===0&&$A.arrayLength(a)===0&&e==="text"&&(/^<img\s+class="emoticon"[^>]*?>$/.test(s.text)||/^\s*<p>\s*([\uD800-\uDBFF][\uDC00-\uDFFF]){1,3}\s*<\/p>\s*$/.test(s.text))&&r.push("transparent"),r},contentClass(){const{type:t,msg:i}=this.msgData,e=[];return t==="text"&&(/^<img\s+class="emoticon"[^>]*?>$/.test(i.text)?e.push("an-emoticon"):/^\s*<p>\s*([\uD800-\uDBFF][\uDC00-\uDFFF]){3}\s*<\/p>\s*$/.test(i.text)?e.push("three-emoji"):/^\s*<p>\s*([\uD800-\uDBFF][\uDC00-\uDFFF]){2}\s*<\/p>\s*$/.test(i.text)?e.push("two-emoji"):/^\s*<p>\s*[\uD800-\uDBFF][\uDC00-\uDFFF]\s*<\/p>\s*$/.test(i.text)&&e.push("an-emoji")),e}},watch:{operateAction(t){this.operateEnter=!1,t&&setTimeout(i=>this.operateEnter=!0,500)},voteData:{handler(t){const i=JSON.parse(window.localStorage.getItem("__cache:vote__"))||{};for(const e in t)i[e]=t[e];Object.keys(i).length>0&&window.localStorage.setItem("__cache:vote__",JSON.stringify(i))},deep:!0}},methods:{handleLongpress(t,i){this.$emit("on-longpress",{event:t,el:i,msgData:this.msgData})},handleClick(){this.msgData.dot&&(this.dotClicks.push(this.msgData.id),this.$store.dispatch("dialogMsgDot",this.msgData))},openTodo(){if(!(this.todoLoad>0)){if(this.todoShow){this.todoShow=!1;return}this.todoLoad++,this.$store.dispatch("call",{url:"dialog/msg/todolist",data:{msg_id:this.msgData.id}}).then(({data:t})=>{this.todoList=t}).catch(()=>{this.todoList=[]}).finally(t=>{setTimeout(()=>{this.todoLoad--,this.todoShow=!0},100)})}},handleTodoAdd(){this.$refs.todo.doClose(),this.$emit("on-other",{event:"todoAdd",data:{msg_id:this.msgData.id,userids:this.todoList.map(({userid:t})=>t)}})},openReadPercentage(){if(!(this.percentageLoad>0)){if(this.percentageShow){this.percentageShow=!1;return}this.percentageLoad++,this.$store.dispatch("call",{url:"dialog/msg/readlist",data:{msg_id:this.msgData.id}}).then(({data:t})=>{this.percentageList=t}).catch(()=>{this.percentageList=[]}).finally(t=>{setTimeout(()=>{this.percentageLoad--,this.percentageShow=!0},100)})}},recordStyle(t){const{duration:i}=t;return{width:50+Math.min(180,Math.floor(i/200))+"px"}},recordDuration(t){const i=Math.floor(t/6e4),e=Math.floor(t/1e3)%60;return i>0?`${i}:${e}\u2033`:`${Math.max(1,e)}\u2033`},fileStyle(t){return t?{width:`${t}%`}:{}},imageStyle(t,i="style"){const{width:e,height:s}=t;if(e&&s){let a=220,o=220,r=e,n=s;return(e>a||s>o)&&(e>s?(r=a,n=s*(a/e)):(r=e*(o/s),n=o)),i==="width"?r:i==="height"?n:{width:r+"px",height:n+"px"}}return i==="width"||i==="height"?0:{}},isVideoFile(t){return t.type==="file"&&t.ext==="mp4"&&t.width>0&&t.height>0},playRecord(){this.operateVisible||!this.msgData.created_at||this.$store.dispatch("audioPlay",this.msgData.msg.path)},openMeeting(){this.operateVisible||$.Store.set("addMeeting",{type:"join",name:this.msgData.msg.name,meetingid:this.msgData.msg.meetingid,meetingdisabled:!0})},openDialog(t){this.$store.dispatch("openDialogUserid",t).then(i=>{this.goForward({name:"manage-messenger"})}).catch(({msg:i})=>{$A.modalError(i)})},showReplyData(t){return $A.isJson(t)?t.userid:!1},showForwardData(t){return $A.isJson(t)?t.show&&t.userid:!1},viewReply(){this.$emit("on-view-reply",{msg_id:this.msgData.id,reply_id:this.msgData.reply_id})},viewText(t){this.$emit("on-view-text",t,this.$refs.content)},viewFile(){!this.msgData.created_at||this.$emit("on-view-file",this.msgData)},downFile(){!this.msgData.created_at||this.$emit("on-down-file",this.msgData)},replyList(){this.$emit("on-reply-list",{msg_id:this.msgData.id})},onError(){this.$emit("on-error",this.msgData)},onEmoji(t){this.$emit("on-emoji",{msg_id:this.msgData.id,symbol:t})},onShowEmojiUser(t){this.$emit("on-show-emoji-user",t)},onWordChain(){this.$store.state.dialogDroupWordChain={type:"participate",dialog_id:this.msgData.dialog_id,msgData:this.msgData}},unfoldWordChain(t){if(this.unfoldWordChainData.indexOf(t.id)==-1){const i=JSON.parse(window.localStorage.getItem("__cache:unfoldWordChain__"))||[];i.push(t.id),window.localStorage.setItem("__cache:unfoldWordChain__",JSON.stringify(i)),this.unfoldWordChainData.push(t.id)}},onVote(t,i){if(t!="vote"){$A.modalConfirm({content:t=="finish"?"\u786E\u5B9A\u7ED3\u675F\u6295\u7968\uFF1F":"\u518D\u6B21\u53D1\u9001\u6295\u7968\uFF1F",cancelText:"\u53D6\u6D88",okText:"\u786E\u5B9A",onOk:()=>{this.vote(t,i)}});return}this.vote(t,i)},vote(t,i){this.$set(i.msg,"_loadIng",1),this.$store.dispatch("call",{url:"dialog/msg/vote",method:"post",data:{dialog_id:i.dialog_id,uuid:i.msg.uuid,vote:this.voteData[i.msg.uuid]||[],type:t}}).then(({data:e})=>{t=="again"&&$A.messageSuccess("\u5DF2\u53D1\u9001"),e.forEach(s=>{this.$store.dispatch("saveDialogMsg",s)})}).catch(({msg:e})=>{$A.modalError(e)}).finally(e=>{this.$set(i.msg,"_loadIng",0)})},getVoteProgress(t,i){const e=t.votes.filter(a=>(a.votes||"").indexOf(i)!=-1).length,s=e?(e/t.votes.length*100).toFixed(2):"0.00";return{num:e,progress:s}}}},D={};var gt=u(mt,ut,pt,!1,ft,null,null,null);function ft(t){for(let i in D)this[i]=D[i]}var _t=function(){return gt.exports}(),vt=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{class:t.classArray},[t.isUnreadStart?e("div",{staticClass:"dialog-unread-label"},[e("em"),e("span",[t._v(t._s(t.$L("\u4EE5\u4E0B\u4E3A\u65B0\u6D88\u606F")))]),e("em")]):t._e(),t.source.type==="tag"?e("div",{staticClass:"dialog-tag",on:{click:t.onViewTag}},[e("div",{staticClass:"tag-user"},[e("UserAvatar",{attrs:{userid:t.source.userid,"show-name":!0,"show-icon":!1}})],1),t._v(" "+t._s(t.$L(t.source.msg.action==="remove"?"\u53D6\u6D88\u6807\u6CE8":"\u6807\u6CE8\u4E86"))+' "'+t._s(t.$A.getMsgSimpleDesc(t.source.msg.data))+'" ')]):t.source.type==="top"?e("div",{staticClass:"dialog-top",on:{click:t.onViewTag}},[e("div",{staticClass:"tag-user"},[e("UserAvatar",{attrs:{userid:t.source.userid,"show-name":!0,"show-icon":!1}})],1),t._v(" "+t._s(t.$L(t.source.msg.action==="remove"?"\u53D6\u6D88\u7F6E\u9876":"\u7F6E\u9876\u4E86"))+' "'+t._s(t.$A.getMsgSimpleDesc(t.source.msg.data))+'" ')]):t.source.type==="todo"?e("div",{staticClass:"dialog-todo",on:{click:t.onViewTodo}},[e("div",{staticClass:"todo-user"},[e("UserAvatar",{attrs:{userid:t.source.userid,"show-name":!0,"show-icon":!1}})],1),t._v(" "+t._s(t.$L(t.source.msg.action==="remove"?"\u53D6\u6D88\u5F85\u529E":t.source.msg.action==="done"?"\u5B8C\u6210":"\u8BBE\u5F85\u529E"))+' "'+t._s(t.$A.getMsgSimpleDesc(t.source.msg.data))+'" '),t.formatTodoUser(t.source.msg.data).length>0?e("div",{staticClass:"todo-users"},[e("span",[t._v(t._s(t.$L("\u7ED9")))]),t._l(t.formatTodoUser(t.source.msg.data),function(s,a){return[a<3?e("div",{staticClass:"todo-user"},[e("UserAvatar",{attrs:{userid:s,"show-name":!0,"show-icon":!1}})],1):a==3?e("div",{staticClass:"todo-user"},[t._v("+"+t._s(t.formatTodoUser(t.source.msg.data).length-3))]):t._e()]})],2):t._e()]):t.source.type==="notice"?e("div",{staticClass:"dialog-notice"},[t._v(" "+t._s(t.source.msg.notice)+" ")]):[e("div",{staticClass:"dialog-avatar"},[e("UserAvatar",{directives:[{name:"longpress",rawName:"v-longpress",value:{callback:t.onMention,delay:300},expression:"{callback: onMention, delay: 300}"}],attrs:{userid:t.source.userid,size:30},on:{"open-dialog":t.onOpenDialog}})],1),e("DialogView",{attrs:{"msg-data":t.source,"dialog-type":t.dialogData.type,"hide-percentage":t.hidePercentage,"hide-reply":t.hideReply,"hide-forward":t.hideForward,"operate-visible":t.operateVisible,"operate-action":t.operateVisible&&t.source.id===t.operateItem.id,"is-right-msg":t.isRightMsg},on:{"on-longpress":t.onLongpress,"on-view-reply":t.onViewReply,"on-view-text":t.onViewText,"on-view-file":t.onViewFile,"on-down-file":t.onDownFile,"on-reply-list":t.onReplyList,"on-error":t.onError,"on-emoji":t.onEmoji,"on-other":t.onOther,"on-show-emoji-user":t.onShowEmojiUser}})]],2)},$t=[];const wt={name:"DialogItem",components:{DialogView:_t},directives:{longpress:w},props:{source:{type:Object,default(){return{}}},dialogData:{type:Object,default(){return{}}},operateVisible:{type:Boolean,default:!1},operateItem:{type:Object,default(){return{}}},simpleView:{type:Boolean,default:!1},isMyDialog:{type:Boolean,default:!1},msgId:{type:Number,default:0},unreadOne:{type:Number,default:0},scrollIng:{type:Number,default:0},readEnabled:{type:Boolean,default:!1}},computed:{...g(["userId"]),isRightMsg(){return this.source.userid==this.$store.state.userId},isReply(){return this.simpleView||this.msgId===this.source.id},isNoRead(){return this.isRightMsg||this.source.read_at},isUnreadStart(){return this.unreadOne===this.source.id},hidePercentage(){return this.simpleView||this.isMyDialog||this.isReply},hideReply(){return this.simpleView||this.msgId>0},hideForward(){return this.simpleView||this.msgId>0},classArray(){return{"dialog-item":!0,"reply-item":this.isReply,"unread-start":this.isUnreadStart,self:this.isRightMsg}}},watch:{readEnabled(){this.msgRead()},windowActive(){this.msgRead()},scrollIng(){this.msgRead()}},methods:{msgRead(){var t;this.isNoRead||!this.readEnabled||!this.windowActive||!((t=this.$el)!=null&&t.parentNode.classList.contains("item-enter"))||this.$store.dispatch("dialogMsgRead",this.source)},formatTodoUser(t){if($A.isJson(t)){const{userids:i}=t;if(i)return i.split(",")}return[]},onViewTag(){this.onViewReply({msg_id:this.source.id,reply_id:this.source.msg.data.id})},onViewTodo(){this.onViewReply({msg_id:this.source.id,reply_id:this.source.msg.data.id})},onOpenDialog(t){this.dialogData.type=="group"&&this.$store.dispatch("openDialogUserid",t).then(i=>{this.goForward({name:"manage-messenger"})}).catch(({msg:i})=>{$A.modalError(i)})},onMention(){this.dispatch("on-mention",this.source)},onLongpress(t){this.dispatch("on-longpress",t)},onViewReply(t){this.dispatch("on-view-reply",t)},onViewText(t,i){this.dispatch("on-view-text",t,i)},onViewFile(t){this.dispatch("on-view-file",t)},onDownFile(t){this.dispatch("on-down-file",t)},onReplyList(t){this.dispatch("on-reply-list",t)},onError(t){this.dispatch("on-error",t)},onEmoji(t){this.dispatch("on-emoji",t)},onOther(t){this.dispatch("on-other",t)},onShowEmojiUser(t){this.dispatch("on-show-emoji-user",t)},dispatch(t,...i){if(this.isReply){this.$emit(t,...i);return}let e=this.$parent,s=e.$options.name;for(;e&&(!s||s!=="virtual-list");)e=e.$parent,e&&(s=e.$options.name);e&&e.$emit(t,...i)}}},k={};var yt=u(wt,vt,$t,!1,Ct,null,null,null);function Ct(t){for(let i in k)this[i]=k[i]}var b=function(){return yt.exports}(),Dt=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("Upload",{ref:"upload",attrs:{name:"files",action:t.actionUrl,headers:t.headers,data:t.params,multiple:"",format:t.uploadFormat,"show-upload-list":!1,"max-size":t.maxSize,"before-upload":t.handleBeforeUpload,"on-progress":t.handleProgress,"on-success":t.handleSuccess,"on-format-error":t.handleFormatError,"on-exceeded-size":t.handleMaxSize}})},kt=[];const bt={name:"DialogUpload",props:{dialogId:{type:Number,default:0},maxSize:{type:Number,default:1024e3}},data(){return{fileMsgCaches:{},uploadFormat:[],actionUrl:$A.apiUrl("dialog/msg/sendfile")}},computed:{...g(["cacheDialogs"]),headers(){return{fd:$A.getSessionStorageString("userWsFd"),token:this.userToken}},params(){return{dialog_id:this.dialogId,reply_id:this.dialogData.extra_quote_id||0}},dialogData(){return this.cacheDialogs.find(({id:t})=>t==this.dialogId)||{}}},methods:{fileMsgName(t){return`${t.name}::${t.size}`},fileMsgData(t,i=void 0){const e=this.fileMsgName(t);if($A.isJson(i)){this.fileMsgCaches[e]=Object.assign(this.fileMsgCaches[e]||{},i);return}i={type:"file",thumb:null,width:-1,height:-1,name:t.name,size:t.size,ext:t.name.split(".").pop()};let{ext:s}=i;s==="docx"?s="doc":s==="xlsx"?s="xls":s==="pptx"&&(s="ppt"),["ai","avi","bmp","cdr","doc","eps","gif","mov","mp3","mp4","pdf","ppt","pr","psd","rar","svg","tif","txt","xls","zip"].includes(s)?i.thumb=$A.mainUrl(`images/ext/${s}.png`):i.thumb=$A.mainUrl("images/ext/file.png"),this.fileMsgCaches[e]=i},handleBeforeUpload(t){return new Promise(i=>{if(this.fileMsgData(t),/\.(jpe?g|webp|png|gif)$/i.test(t.name)){this.$store.dispatch("showSpinner",600),this.imageFileToObject(t).then(e=>{this.fileMsgData(t,e),i()}).finally(()=>{this.$store.dispatch("hiddenSpinner")});return}i()})},handleProgress(t,i){if(i.tempId===void 0){this.$parent.$options.name==="DialogWrapper"?i.tempId=this.$parent.getTempId():i.tempId=$A.randNum(1e9,9999999999),i.msg={};const e=this.fileMsgName(i);this.fileMsgCaches[e]&&(i.msg=this.fileMsgCaches[e],delete this.fileMsgCaches[e])}this.$emit("on-progress",i)},handleSuccess(t,i){t.ret===1?(i.data=t.data,this.$emit("on-success",i),t.data.task_id&&this.$store.dispatch("getTaskFiles",t.data.task_id)):($A.modalWarning({title:"\u53D1\u9001\u5931\u8D25",content:"\u6587\u4EF6 "+i.name+" \u53D1\u9001\u5931\u8D25\uFF0C"+t.msg}),this.$emit("on-error",i),this.$refs.upload.fileList.pop())},handleFormatError(t){$A.modalWarning({title:"\u6587\u4EF6\u683C\u5F0F\u4E0D\u6B63\u786E",content:"\u6587\u4EF6 "+t.name+" \u683C\u5F0F\u4E0D\u6B63\u786E\uFF0C\u4EC5\u652F\u6301\u53D1\u9001\uFF1A"+this.uploadFormat.join(",")})},handleMaxSize(t){$A.modalWarning({title:"\u8D85\u51FA\u6587\u4EF6\u5927\u5C0F\u9650\u5236",content:"\u6587\u4EF6 "+t.name+" \u592A\u5927\uFF0C\u4E0D\u80FD\u53D1\u9001\u8D85\u8FC7"+$A.bytesToSize(this.maxSize*1024)+"\u3002"})},handleClick(){this.$refs.upload.handleClick()},upload(t){this.$refs.upload.upload(t)},cancel(t){return this.$refs.upload.cancel(t)},imageFileToObject(t){return new Promise((i,e)=>{const s=new FileReader;s.onload=({target:a})=>{const o=new Image;o.onload=()=>{const r=document.createElement("canvas"),n=r.getContext("2d"),l=o.width,d=o.height,c=500,h=500;let m=l,_=d;(l>c||d>h)&&(l/d>c/h?(m=c,_=Math.round(c*(d/l))):(_=h,m=Math.round(h*(l/d)))),r.width=m,r.height=_,n.clearRect(0,0,m,_),n.drawImage(o,0,0,m,_),i({type:"img",thumb:r.toDataURL("image/webp",.92),width:r.width,height:r.height})},o.onerror=()=>{e()},o.src=a.result},s.onerror=()=>{e()},s.readAsDataURL(t)})}}},L={};var Lt=u(bt,Dt,kt,!1,St,null,null,null);function St(t){for(let i in L)this[i]=L[i]}var It=function(){return Lt.exports}(),xt=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{staticClass:"dialog-group-info"},[e("div",{staticClass:"group-info-title"},[t._v(t._s(t.$L("\u7FA4\u540D")))]),e("div",{staticClass:"group-info-value"},[e("QuickEdit",{attrs:{value:t.dialogData.name,disabled:t.dialogData.owner_id!=t.userId},on:{"on-update":t.updateName}},[t._v(t._s(t.dialogData.name))])],1),e("div",{staticClass:"group-info-title"},[t._v(t._s(t.$L("\u7FA4\u7C7B\u578B")))]),e("div",{staticClass:"group-info-value"},[t._v(t._s(t.$L(t.groupType)))]),e("div",{staticClass:"group-info-search"},[e("Input",{attrs:{prefix:"ios-search",placeholder:t.$L("\u641C\u7D22\u6210\u5458"),clearable:""},model:{value:t.searchKey,callback:function(s){t.searchKey=s},expression:"searchKey"}})],1),e("div",{staticClass:"group-info-user"},[e("ul",[t._l(t.userList,function(s,a){return e("li",{key:a,on:{click:function(o){return t.openUser(s.userid)}}},[e("UserAvatar",{attrs:{userid:s.userid,size:32,showName:""}}),s.userid===t.dialogData.owner_id?e("div",{staticClass:"user-tag"},[t._v(t._s(t.$L("\u7FA4\u4E3B")))]):t.operableExit(s)?e("div",{staticClass:"user-exit",on:{click:function(o){return o.stopPropagation(),t.onExit(s)}}},[e("Icon",{attrs:{type:"md-exit"}})],1):t._e()],1)}),t.userList.length===0?e("li",{staticClass:"no"},[t.loadIng>0?e("Loading"):e("span",[t._v(t._s(t.$L("\u6CA1\u6709\u7B26\u5408\u6761\u4EF6\u7684\u6570\u636E")))])],1):t._e()],2)]),t.operableAdd?e("div",{staticClass:"group-info-button"},[t.dialogData.owner_id==t.userId||t.dialogData.owner_id==0?e("Button",{attrs:{type:"primary",icon:"md-add"},on:{click:t.openAdd}},[t._v(t._s(t.$L("\u6DFB\u52A0\u6210\u5458")))]):t._e()],1):t._e(),e("Modal",{attrs:{title:t.$L("\u6DFB\u52A0\u7FA4\u6210\u5458"),"mask-closable":!1},model:{value:t.addShow,callback:function(s){t.addShow=s},expression:"addShow"}},[e("Form",{attrs:{model:t.addData,"label-width":"auto"},nativeOn:{submit:function(s){s.preventDefault()}}},[e("FormItem",{attrs:{prop:"userids",label:t.$L("\u65B0\u589E\u6210\u5458")}},[e("UserSelect",{attrs:{disabledChoice:t.addData.disabledChoice,"multiple-max":100,"show-bot":"",title:t.$L("\u9009\u62E9\u6210\u5458")},model:{value:t.addData.userids,callback:function(s){t.$set(t.addData,"userids",s)},expression:"addData.userids"}}),t.dialogData.group_type==="department"?e("div",{staticClass:"form-tip"},[t._v(t._s(t.$L("\u6B64\u64CD\u4F5C\u4EC5\u52A0\u5165\u7FA4\u6210\u5458\u5E76\u4E0D\u4F1A\u52A0\u5165\u90E8\u95E8")))]):t.dialogData.group_type==="project"?e("div",{staticClass:"form-tip"},[t._v(t._s(t.$L("\u6B64\u64CD\u4F5C\u4EC5\u52A0\u5165\u7FA4\u6210\u5458\u5E76\u4E0D\u4F1A\u52A0\u5165\u9879\u76EE")))]):t.dialogData.group_type==="task"?e("div",{staticClass:"form-tip"},[t._v(t._s(t.$L("\u6B64\u64CD\u4F5C\u4EC5\u52A0\u5165\u7FA4\u6210\u5458\u5E76\u4E0D\u4F1A\u52A0\u5165\u4EFB\u52A1\u8D1F\u8D23\u4EBA")))]):t._e()],1)],1),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(s){t.addShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.addLoad>0},on:{click:t.onAdd}},[t._v(t._s(t.$L("\u786E\u5B9A\u6DFB\u52A0")))])],1)],1)],1)},Mt=[];const Tt={name:"DialogGroupInfo",components:{UserSelect:P},props:{dialogId:{type:Number,default:0}},data(){return{searchKey:"",loadIng:0,dialogUser:[],addShow:!1,addData:{},addLoad:0,openIng:!1}},computed:{...g(["cacheDialogs","cacheUserBasic","userIsAdmin"]),dialogData(){return this.cacheDialogs.find(({id:t})=>t==this.dialogId)||{}},groupType(){const{group_type:t}=this.dialogData;return t==="department"?"\u90E8\u95E8\u7FA4\u7EC4":t==="project"?"\u9879\u76EE\u7FA4\u7EC4":t==="task"?"\u4EFB\u52A1\u7FA4\u7EC4":t==="user"?"\u4E2A\u4EBA\u7FA4\u7EC4":t==="all"?"\u5168\u5458\u7FA4\u7EC4":t==="okr"?"OKR\u7FA4\u7EC4":"\u672A\u77E5"},userList(){const{dialogUser:t,searchKey:i,cacheUserBasic:e,dialogData:s}=this;return t.map(o=>{const r=e.find(n=>n.userid==o.userid);return r&&(o.nickname=r.nickname,o.email=r.email),o}).filter(o=>!(i&&o.nickname&&!$A.strExists(o.nickname,i)&&!$A.strExists(o.email,i))).sort((o,r)=>o.userid===s.owner_id||r.userid===s.owner_id?(o.userid===s.owner_id?0:1)-(r.userid===s.owner_id?0:1):$A.Date(o.created_at)-$A.Date(r.created_at))}},watch:{dialogId:{handler(){this.getDialogUser()},immediate:!0}},methods:{updateName(t,i){if(!t){i();return}this.$store.dispatch("call",{url:"dialog/group/edit",data:{dialog_id:this.dialogId,chat_name:t}}).then(({data:e})=>{this.$store.dispatch("saveDialog",e),i()}).catch(({msg:e})=>{$A.modalError(e),i()})},getDialogUser(){this.dialogId<=0||(this.loadIng++,this.$store.dispatch("call",{url:"dialog/user",data:{dialog_id:this.dialogId}}).then(({data:t})=>{this.dialogUser=t,this.$store.dispatch("saveDialog",{id:this.dialogId,people:t.length})}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.loadIng--}))},operableAdd(){const{owner_id:t,group_type:i}=this.dialogData;return i=="all"?this.userIsAdmin:[0,this.userId].includes(t)},openAdd(){this.addData={dialog_id:this.dialogId,userids:[],disabledChoice:this.dialogUser.map(t=>t.userid)},this.addShow=!0},onAdd(){this.addLoad++,this.$store.dispatch("call",{url:"dialog/group/adduser",data:this.addData}).then(({msg:t})=>{$A.messageSuccess(t),this.addShow=!1,this.addData={},this.getDialogUser()}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.addLoad--})},operableExit(t){const{owner_id:i,group_type:e}=this.dialogData;return e=="all"?this.userIsAdmin:i==this.userId||t.inviter==this.userId},onExit(t){let i="\u4F60\u786E\u5B9A\u8981\u9000\u51FA\u7FA4\u7EC4\u5417\uFF1F",e=[];$A.isJson(t)&&t.userid!=this.userId&&(i=`\u4F60\u786E\u5B9A\u8981\u5C06\u3010${t.nickname}\u3011\u79FB\u51FA\u7FA4\u7EC4\u5417\uFF1F`,e=[t.userid]),$A.modalConfirm({content:i,loading:!0,onOk:()=>new Promise((s,a)=>{this.$store.dispatch("call",{url:"dialog/group/deluser",data:{dialog_id:this.dialogId,userids:e}}).then(({msg:o})=>{s(o),e.length>0?this.getDialogUser():(this.$store.dispatch("forgetDialog",this.dialogId),this.goForward({name:"manage-messenger"}))}).catch(({msg:o})=>{a(o)})})})},openUser(t){this.openIng||(this.openIng=!0,this.$store.dispatch("openDialogUserid",t).then(i=>{this.$emit("on-close")}).catch(({msg:i})=>{$A.modalError(i)}).finally(i=>{this.openIng=!1}))}}},S={};var At=u(Tt,xt,Mt,!1,Et,null,null,null);function Et(t){for(let i in S)this[i]=S[i]}var jt=function(){return At.exports}(),Ft=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{staticClass:"dialog-respond"},[e("div",{staticClass:"respond-title"},[e("em",{staticClass:"no-dark-content"},[t._v(t._s(t.respondData.symbol))]),t._v(t._s(t.$L("\u56DE\u5E94\u8BE6\u60C5"))+" ("+t._s(t.respondData.userids.length)+")")]),e("div",{staticClass:"respond-user"},[e("ul",t._l(t.respondData.userids,function(s,a){return e("li",{key:a,on:{click:function(o){return t.openUser(s)}}},[e("UserAvatar",{attrs:{userid:s,size:32,showName:""}})],1)}),0)])])},Rt=[];const Vt={name:"DialogRespond",props:{respondData:{type:Object,default:()=>({})}},data(){return{openIng:!1}},methods:{openUser(t){this.openIng||(this.openIng=!0,this.$store.dispatch("openDialogUserid",t).then(i=>{this.$emit("on-close")}).catch(({msg:i})=>{$A.modalError(i)}).finally(i=>{this.openIng=!1}))}}},I={};var Ot=u(Vt,Ft,Rt,!1,qt,null,null,null);function qt(t){for(let i in I)this[i]=I[i]}var Pt=function(){return Ot.exports}(),Bt=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{staticClass:"chat-emoji-wrapper"},[e("div",{staticClass:"chat-emoji-box"},[t.type==="emosearch"?e("div",{staticClass:"chat-emoji-emosearch"},[e("Input",{attrs:{clearable:"",placeholder:t.$L("\u641C\u7D22\u8868\u60C5")},model:{value:t.emosearchKey,callback:function(s){t.emosearchKey=s},expression:"emosearchKey"}},[e("Icon",{class:{"icon-loading":t.emosearchLoad},attrs:{slot:"prefix",type:t.emosearchLoad?"ios-loading":"ios-search"},slot:"prefix"})],1)],1):t.type==="emoji"?e("div",{staticClass:"chat-emoji-nav"},t._l(t.emojiNavList,function(s){var a;return e("div",{key:s.type,class:(a={},a[`i-${s.name}`]=!0,a.active=s.type===t.emojiNavActive,a),domProps:{innerHTML:t._s(s.content)},on:{click:function(o){t.emojiNavActive=s.type}}})}),0):t._e(),e("Scrollbar",[e("ul",{class:[t.type,"no-dark-content"]},t._l(t.list,function(s){return e("li",{on:{click:function(a){return t.onSelect(a,s)}}},[s.type==="emoticon"?e("img",{attrs:{src:s.src,title:s.name,alt:s.name}}):e("span",{attrs:{title:s.name},domProps:{innerHTML:t._s(s.html)}})])}),0)])],1),t.onlyEmoji?t._e():e("ul",{ref:"chatEmojiMenuRef",staticClass:"chat-emoji-menu",style:t.chatEmojiMenuStyle,on:{scroll:t.onHandleScroll}},[t.showEmojiMenuScrollLeftBtn?e("li",{staticClass:"left-btn",on:{click:function(s){return t.onEmojiMenuScroll("left")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE72D")])]):t._e(),e("li",{class:{active:t.type==="emosearch"},on:{click:function(s){t.type="emosearch"}}},[e("i",{staticClass:"taskfont"},[t._v("\uE6F8")])]),e("li",{class:{active:t.type==="emoji"},on:{click:function(s){t.type="emoji"}}},[e("span",{staticClass:"no-dark-content"},[t._v("\u{1F600}")])]),t._l(t.emoticonData,function(s){return e("li",{class:{active:t.type==="emoticon"&&t.emoticonPath==s.path},on:{click:function(a){return t.onEmoticon(s.path)}}},[e("img",{attrs:{title:s.name,alt:s.name,src:s.src}})])}),t.showEmojiMenuScrollRightBtn?e("li",{staticClass:"right-btn",on:{click:function(s){return t.onEmojiMenuScroll("right")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE733")])]):t._e()],2)])},Ut=[];const Nt={name:"ChatEmoji",props:{searchKey:{type:String,default:""},onlyEmoji:{type:Boolean,default:!1}},data(){return{type:"emoji",emojiNavActive:"p",emojiNavList:[{type:"p",name:"people",content:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M0 256C0 114.6 114.6 0 256 0C397.4 0 512 114.6 512 256C512 397.4 397.4 512 256 512C114.6 512 0 397.4 0 256zM256 432C332.1 432 396.2 382 415.2 314.1C419.1 300.4 407.8 288 393.6 288H118.4C104.2 288 92.92 300.4 96.76 314.1C115.8 382 179.9 432 256 432V432zM176.4 160C158.7 160 144.4 174.3 144.4 192C144.4 209.7 158.7 224 176.4 224C194 224 208.4 209.7 208.4 192C208.4 174.3 194 160 176.4 160zM336.4 224C354 224 368.4 209.7 368.4 192C368.4 174.3 354 160 336.4 160C318.7 160 304.4 174.3 304.4 192C304.4 209.7 318.7 224 336.4 224z" /></svg>'},{type:"n",name:"nature",content:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M332.7 19.85C334.6 8.395 344.5 0 356.1 0C363.6 0 370.6 3.52 375.1 9.502L392 32H444.1C456.8 32 469.1 37.06 478.1 46.06L496 64H552C565.3 64 576 74.75 576 88V112C576 156.2 540.2 192 496 192H426.7L421.6 222.5L309.6 158.5L332.7 19.85zM448 64C439.2 64 432 71.16 432 80C432 88.84 439.2 96 448 96C456.8 96 464 88.84 464 80C464 71.16 456.8 64 448 64zM416 256.1V480C416 497.7 401.7 512 384 512H352C334.3 512 320 497.7 320 480V364.8C295.1 377.1 268.8 384 240 384C211.2 384 184 377.1 160 364.8V480C160 497.7 145.7 512 128 512H96C78.33 512 64 497.7 64 480V249.8C35.23 238.9 12.64 214.5 4.836 183.3L.9558 167.8C-3.331 150.6 7.094 133.2 24.24 128.1C41.38 124.7 58.76 135.1 63.05 152.2L66.93 167.8C70.49 182 83.29 191.1 97.97 191.1H303.8L416 256.1z" /></svg>
`},{type:"d",name:"food",content:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M481.9 270.1C490.9 279.1 496 291.3 496 304C496 316.7 490.9 328.9 481.9 337.9C472.9 346.9 460.7 352 448 352H64C51.27 352 39.06 346.9 30.06 337.9C21.06 328.9 16 316.7 16 304C16 291.3 21.06 279.1 30.06 270.1C39.06 261.1 51.27 256 64 256H448C460.7 256 472.9 261.1 481.9 270.1zM475.3 388.7C478.3 391.7 480 395.8 480 400V416C480 432.1 473.3 449.3 461.3 461.3C449.3 473.3 432.1 480 416 480H96C79.03 480 62.75 473.3 50.75 461.3C38.74 449.3 32 432.1 32 416V400C32 395.8 33.69 391.7 36.69 388.7C39.69 385.7 43.76 384 48 384H464C468.2 384 472.3 385.7 475.3 388.7zM50.39 220.8C45.93 218.6 42.03 215.5 38.97 211.6C35.91 207.7 33.79 203.2 32.75 198.4C31.71 193.5 31.8 188.5 32.99 183.7C54.98 97.02 146.5 32 256 32C365.5 32 457 97.02 479 183.7C480.2 188.5 480.3 193.5 479.2 198.4C478.2 203.2 476.1 207.7 473 211.6C469.1 215.5 466.1 218.6 461.6 220.8C457.2 222.9 452.3 224 447.3 224H64.67C59.73 224 54.84 222.9 50.39 220.8zM372.7 116.7C369.7 119.7 368 123.8 368 128C368 131.2 368.9 134.3 370.7 136.9C372.5 139.5 374.1 141.6 377.9 142.8C380.8 143.1 384 144.3 387.1 143.7C390.2 143.1 393.1 141.6 395.3 139.3C397.6 137.1 399.1 134.2 399.7 131.1C400.3 128 399.1 124.8 398.8 121.9C397.6 118.1 395.5 116.5 392.9 114.7C390.3 112.9 387.2 111.1 384 111.1C379.8 111.1 375.7 113.7 372.7 116.7V116.7zM244.7 84.69C241.7 87.69 240 91.76 240 96C240 99.16 240.9 102.3 242.7 104.9C244.5 107.5 246.1 109.6 249.9 110.8C252.8 111.1 256 112.3 259.1 111.7C262.2 111.1 265.1 109.6 267.3 107.3C269.6 105.1 271.1 102.2 271.7 99.12C272.3 96.02 271.1 92.8 270.8 89.88C269.6 86.95 267.5 84.45 264.9 82.7C262.3 80.94 259.2 79.1 256 79.1C251.8 79.1 247.7 81.69 244.7 84.69V84.69zM116.7 116.7C113.7 119.7 112 123.8 112 128C112 131.2 112.9 134.3 114.7 136.9C116.5 139.5 118.1 141.6 121.9 142.8C124.8 143.1 128 144.3 131.1 143.7C134.2 143.1 137.1 141.6 139.3 139.3C141.6 137.1 143.1 134.2 143.7 131.1C144.3 128 143.1 124.8 142.8 121.9C141.6 118.1 139.5 116.5 136.9 114.7C134.3 112.9 131.2 111.1 128 111.1C123.8 111.1 119.7 113.7 116.7 116.7L116.7 116.7z" /></svg>'},{type:"s",name:"symbols",content:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M500.3 7.251C507.7 13.33 512 22.41 512 31.1V175.1C512 202.5 483.3 223.1 447.1 223.1C412.7 223.1 383.1 202.5 383.1 175.1C383.1 149.5 412.7 127.1 447.1 127.1V71.03L351.1 90.23V207.1C351.1 234.5 323.3 255.1 287.1 255.1C252.7 255.1 223.1 234.5 223.1 207.1C223.1 181.5 252.7 159.1 287.1 159.1V63.1C287.1 48.74 298.8 35.61 313.7 32.62L473.7 .6198C483.1-1.261 492.9 1.173 500.3 7.251H500.3zM74.66 303.1L86.5 286.2C92.43 277.3 102.4 271.1 113.1 271.1H174.9C185.6 271.1 195.6 277.3 201.5 286.2L213.3 303.1H239.1C266.5 303.1 287.1 325.5 287.1 351.1V463.1C287.1 490.5 266.5 511.1 239.1 511.1H47.1C21.49 511.1-.0019 490.5-.0019 463.1V351.1C-.0019 325.5 21.49 303.1 47.1 303.1H74.66zM143.1 359.1C117.5 359.1 95.1 381.5 95.1 407.1C95.1 434.5 117.5 455.1 143.1 455.1C170.5 455.1 191.1 434.5 191.1 407.1C191.1 381.5 170.5 359.1 143.1 359.1zM440.3 367.1H496C502.7 367.1 508.6 372.1 510.1 378.4C513.3 384.6 511.6 391.7 506.5 396L378.5 508C372.9 512.1 364.6 513.3 358.6 508.9C352.6 504.6 350.3 496.6 353.3 489.7L391.7 399.1H336C329.3 399.1 323.4 395.9 321 389.6C318.7 383.4 320.4 376.3 325.5 371.1L453.5 259.1C459.1 255 467.4 254.7 473.4 259.1C479.4 263.4 481.6 271.4 478.7 278.3L440.3 367.1zM116.7 219.1L19.85 119.2C-8.112 90.26-6.614 42.31 24.85 15.34C51.82-8.137 93.26-3.642 118.2 21.83L128.2 32.32L137.7 21.83C162.7-3.642 203.6-8.137 231.6 15.34C262.6 42.31 264.1 90.26 236.1 119.2L139.7 219.1C133.2 225.6 122.7 225.6 116.7 219.1H116.7z" /></svg>'},{type:"a",name:"activity",content:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M16.17 337.5c0 44.98 7.565 83.54 13.98 107.9C35.22 464.3 50.46 496 174.9 496c9.566 0 19.59-.4707 29.84-1.271L17.33 307.3C16.53 317.6 16.17 327.7 16.17 337.5zM495.8 174.5c0-44.98-7.565-83.53-13.98-107.9c-4.688-17.54-18.34-31.23-36.04-35.95C435.5 27.91 392.9 16 337 16c-9.564 0-19.59 .4707-29.84 1.271l187.5 187.5C495.5 194.4 495.8 184.3 495.8 174.5zM26.77 248.8l236.3 236.3c142-36.1 203.9-150.4 222.2-221.1L248.9 26.87C106.9 62.96 45.07 177.2 26.77 248.8zM256 335.1c0 9.141-7.474 16-16 16c-4.094 0-8.188-1.564-11.31-4.689L164.7 283.3C161.6 280.2 160 276.1 160 271.1c0-8.529 6.865-16 16-16c4.095 0 8.189 1.562 11.31 4.688l64.01 64C254.4 327.8 256 331.9 256 335.1zM304 287.1c0 9.141-7.474 16-16 16c-4.094 0-8.188-1.564-11.31-4.689L212.7 235.3C209.6 232.2 208 228.1 208 223.1c0-9.141 7.473-16 16-16c4.094 0 8.188 1.562 11.31 4.688l64.01 64.01C302.5 279.8 304 283.9 304 287.1zM256 175.1c0-9.141 7.473-16 16-16c4.094 0 8.188 1.562 11.31 4.688l64.01 64.01c3.125 3.125 4.688 7.219 4.688 11.31c0 9.133-7.468 16-16 16c-4.094 0-8.189-1.562-11.31-4.688l-64.01-64.01C257.6 184.2 256 180.1 256 175.1z" /></svg>'},{type:"t",name:"travel",content:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M39.61 196.8L74.8 96.29C88.27 57.78 124.6 32 165.4 32H346.6C387.4 32 423.7 57.78 437.2 96.29L472.4 196.8C495.6 206.4 512 229.3 512 256V448C512 465.7 497.7 480 480 480H448C430.3 480 416 465.7 416 448V400H96V448C96 465.7 81.67 480 64 480H32C14.33 480 0 465.7 0 448V256C0 229.3 16.36 206.4 39.61 196.8V196.8zM109.1 192H402.9L376.8 117.4C372.3 104.6 360.2 96 346.6 96H165.4C151.8 96 139.7 104.6 135.2 117.4L109.1 192zM96 256C78.33 256 64 270.3 64 288C64 305.7 78.33 320 96 320C113.7 320 128 305.7 128 288C128 270.3 113.7 256 96 256zM416 320C433.7 320 448 305.7 448 288C448 270.3 433.7 256 416 256C398.3 256 384 270.3 384 288C384 305.7 398.3 320 416 320z" /></svg>'},{type:"o",name:"objects",content:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M112.1 454.3c0 6.297 1.816 12.44 5.284 17.69l17.14 25.69c5.25 7.875 17.17 14.28 26.64 14.28h61.67c9.438 0 21.36-6.401 26.61-14.28l17.08-25.68c2.938-4.438 5.348-12.37 5.348-17.7L272 415.1h-160L112.1 454.3zM191.4 .0132C89.44 .3257 16 82.97 16 175.1c0 44.38 16.44 84.84 43.56 115.8c16.53 18.84 42.34 58.23 52.22 91.45c.0313 .25 .0938 .5166 .125 .7823h160.2c.0313-.2656 .0938-.5166 .125-.7823c9.875-33.22 35.69-72.61 52.22-91.45C351.6 260.8 368 220.4 368 175.1C368 78.61 288.9-.2837 191.4 .0132zM192 96.01c-44.13 0-80 35.89-80 79.1C112 184.8 104.8 192 96 192S80 184.8 80 176c0-61.76 50.25-111.1 112-111.1c8.844 0 16 7.159 16 16S200.8 96.01 192 96.01z" /></svg>'},{type:"f",name:"flags",content:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M64 496C64 504.8 56.75 512 48 512h-32C7.25 512 0 504.8 0 496V32c0-17.75 14.25-32 32-32s32 14.25 32 32V496zM476.3 0c-6.365 0-13.01 1.35-19.34 4.233c-45.69 20.86-79.56 27.94-107.8 27.94c-59.96 0-94.81-31.86-163.9-31.87C160.9 .3055 131.6 4.867 96 15.75v350.5c32-9.984 59.87-14.1 84.85-14.1c73.63 0 124.9 31.78 198.6 31.78c31.91 0 68.02-5.971 111.1-23.09C504.1 355.9 512 344.4 512 332.1V30.73C512 11.1 495.3 0 476.3 0z" /></svg>'}],emoticonPath:"",emosearchKey:"",emosearchCache:null,emosearchLoad:!1,emosearchTimer:null,emosearchList:[],emojiData:[],emoticonData:[],emojiMenuScrollLeft:0}},mounted(){this.initData(),this.$store.state.windowPortrait||this.onMonitorWheel()},watch:{type(){this.onEmosearch()},emosearchKey(){this.onEmosearch()},searchKey:{handler(t){this.emosearchKey=t},immediate:!0}},computed:{list(){if(this.type==="emoji")return this.emojiData.filter(t=>t.category===this.emojiNavActive);if(this.type==="emosearch")return this.emosearchList;if(this.type==="emoticon"){const t=this.emoticonData.find(({path:i})=>i===this.emoticonPath);if(t)return t.list}return[]},chatEmojiMenuStyle(){return{paddingLeft:this.showEmojiMenuScrollLeftBtn?"34px":0,paddingRight:this.showEmojiMenuScrollRightBtn?"34px":0}},showEmojiMenuScrollLeftBtn(){return this.emojiMenuScrollLeft>34},showEmojiMenuScrollRightBtn(){var e;const t=this.$refs.chatEmojiMenuRef,i=((e=t==null?void 0:t.querySelector("li"))==null?void 0:e.offsetWidth)||48;return this.emojiMenuScrollLeft<this.emoticonData.length*i-(this.$store.state.windowPortrait?34:0)}},methods:{initData(){$A.loadScriptS(["js/emoji.all.js","js/emoticon.all.js"]).then(t=>{const i=$A.mainUrl("images/emoticon");$A.isArray(window.emojiData)&&(this.emojiData=window.emojiData.sort(function(e,s){return e.emoji_order-s.emoji_order}).map(e=>({type:"emoji",name:e.name,category:e.category,html:e.code_decimal}))),$A.isArray(window.emoticonData)&&(this.emoticonData=window.emoticonData.map(e=>Object.assign(e,{src:`${i}/${e.path}/${e.icon}`,list:e.list.map(s=>Object.assign(s,{type:"emoticon",asset:`images/emoticon/${e.path}/${s.path}`,src:`${i}/${e.path}/${s.path}`}))})))})},onEmosearch(){this.type!=="emosearch"||this.emosearchCache===this.emosearchKey||(this.emosearchCache=this.emosearchKey,this.emosearchLoad=!0,this.emosearchTimer&&clearTimeout(this.emosearchTimer),this.emosearchTimer=setTimeout(t=>{K("https://pic.sogou.com/napi/wap/pic",{query:this.emosearchKey+" \u8868\u60C5"}).then(i=>{if(this.emosearchList=[],i.status===0){const e=i.data.items;e.length>0&&(this.emosearchList=e.map(s=>({type:"emoticon",asset:"emosearch",name:s.title,src:s.thumbUrl,height:s.thumbHeight,width:s.thumbWidth})))}this.emosearchList.length===0&&$A.noticeWarning("\u6CA1\u6709\u641C\u7D22\u5230\u4EFB\u4F55\u8868\u60C5")}).catch(i=>{this.emosearchList=[],$A.noticeWarning("\u641C\u7D22\u7ED3\u679C\u4E3A\u7A7A")}).finally(i=>{this.emosearchLoad=!1})},300))},onEmoticon(t){this.type="emoticon",this.emoticonPath=t},onSelect(t,i){i.type==="emoji"?this.$emit("on-select",{type:"emoji",text:t.target.innerText}):this.$emit("on-select",i)},onMonitorWheel(){const t=this.$refs.chatEmojiMenuRef;t==null||t.addEventListener("wheel",i=>{i.preventDefault(),t.scrollLeft=t.scrollLeft+i.deltaY})},onEmojiMenuScroll(t){const i=this.$refs.chatEmojiMenuRef,e=i.offsetWidth-68,s=t=="right"?i.scrollLeft+e:i.scrollLeft-e;i.scrollTo({left:s,behavior:"smooth"})},onHandleScroll(t){this.emojiMenuScrollLeft=t.target.scrollLeft}}},x={};var zt=u(Nt,Bt,Ut,!1,Wt,null,null,null);function Wt(t){for(let i in x)this[i]=x[i]}var U=function(){return zt.exports}();const M="ontouchend"in document;var Ht={bind(t,i){let e=!1;t.__touchEvent__={start:s=>{s.preventDefault(),e=!0,i.value("down",s)},move:s=>{e&&i.value("move",s)},end:s=>{e&&(e=!1,i.value("up"))},click:s=>{i.value("click",s)}},M?(t.addEventListener("touchstart",t.__touchEvent__.start),t.addEventListener("touchmove",t.__touchEvent__.move),t.addEventListener("touchend",t.__touchEvent__.end)):(t.addEventListener("mousedown",t.__touchEvent__.start,{passive:!1}),document.addEventListener("mousemove",t.__touchEvent__.move),document.addEventListener("mouseup",t.__touchEvent__.end)),t.addEventListener("click",t.__touchEvent__.click)},update(){},unbind(t){M?(t.removeEventListener("touchstart",t.__touchEvent__.start),t.removeEventListener("touchmove",t.__touchEvent__.move),t.removeEventListener("touchend",t.__touchEvent__.end)):(t.removeEventListener("mousedown",t.__touchEvent__.start),document.removeEventListener("mousemove",t.__touchEvent__.move),document.removeEventListener("mouseup",t.__touchEvent__.end)),t.removeEventListener("click",t.__touchEvent__.click),delete t.__touchEvent__}};const T="ontouchend"in document;var N={bind(t,i){if(T){const e={move:!1,time:0,x:0,y:0};t.__touchEvent__={start:s=>{s.preventDefault(),e.move=!1,e.time=new Date().getTime(),e.x=s.touches?s.touches[0].clientX:s.clientX,e.y=s.touches?s.touches[0].clientY:s.clientY},move:s=>{if(e.time>0){const a=s.touches?s.touches[0].clientX:s.clientX,o=s.touches?s.touches[0].clientY:s.clientY;(Math.abs(a-e.x)>5||Math.abs(o-e.y)>5)&&(e.move=!0)}},end:s=>{e.time>0&&(!e.move&&new Date().getTime()-e.time<300&&i.value(),e.time=0)}},t.addEventListener("touchstart",t.__touchEvent__.start),t.addEventListener("touchmove",t.__touchEvent__.move),t.addEventListener("touchend",t.__touchEvent__.end)}else t.__clickEvent__=e=>{e.preventDefault(),i.value()},t.addEventListener("click",t.__clickEvent__)},update(){},unbind(t){T?(t.removeEventListener("touchstart",t.__touchEvent__.start),t.removeEventListener("touchmove",t.__touchEvent__.move),t.removeEventListener("touchend",t.__touchEvent__.end),delete t.__touchEvent__):(t.removeEventListener("click",t.__clickEvent__),delete t.__clickEvent__)}};function f(t){return t===void 0&&(t=document.body),t===!0?document.body:t instanceof window.Node?t:document.querySelector(t)}const Qt={inserted(t,{value:i},e){if(t.dataset&&t.dataset.transfer!=="true")return!1;t.className=t.className?t.className+" v-transfer-dom":"v-transfer-dom";const s=t.parentNode;if(!s)return;const a=document.createComment("");let o=!1;i!==!1&&(s.replaceChild(a,t),f(i).appendChild(t),o=!0),t.__transferDomData||(t.__transferDomData={parentNode:s,home:a,target:f(i),hasMovedOut:o})},componentUpdated(t,{value:i}){if(t.dataset&&t.dataset.transfer!=="true")return!1;const e=t.__transferDomData;if(!e)return;const s=e.parentNode,a=e.home,o=e.hasMovedOut;!o&&i?(s.replaceChild(a,t),f(i).appendChild(t),t.__transferDomData=Object.assign({},t.__transferDomData,{hasMovedOut:!0,target:f(i)})):o&&i===!1?(s.replaceChild(t,a),t.__transferDomData=Object.assign({},t.__transferDomData,{hasMovedOut:!1,target:f(i)})):i&&f(i).appendChild(t)},unbind(t){if(t.dataset&&t.dataset.transfer!=="true")return!1;t.className=t.className.replace("v-transfer-dom",""),t.__transferDomData&&(t.__transferDomData.hasMovedOut===!0&&t.__transferDomData.parentNode&&t.__transferDomData.parentNode.appendChild(t),t.__transferDomData=null)}},p={};function A(t,i){!t||typeof p[t]=="undefined"?p[t]=[]:p[t]=p[t].filter(e=>e!==i),p[t].push(i)}function E(t,i){!t||typeof p[t]=="undefined"||(p[t]=p[t].filter(e=>e!==i))}function Kt(t,i){return typeof p[t]=="undefined"?!1:p[t][p[t].length-1]===i}function Gt(){return new Promise(t=>{const i=new G({render(a){return a(Y.exports.Modal,{class:"chat-emoji-one-modal",props:{fullscreen:!0,footerHide:!0},on:{"on-visible-change":o=>{o||setTimeout(r=>{document.body.removeChild(this.$el)},500)}}},[a(U,{attrs:{onlyEmoji:!0},on:{"on-select":o=>{this.$children[0].visible=!1,o.type==="emoji"&&t(o.text)}}})])}}),e=i.$mount();document.body.appendChild(e.$el);const s=i.$children[0];s.visible=!0,s.$el.lastChild.addEventListener("click",({target:a})=>{a.classList.contains("ivu-modal-body")&&(s.visible=!1)})})}var Yt=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{directives:[{name:"clickoutside",rawName:"v-clickoutside",value:t.hidePopover,expression:"hidePopover"}],staticClass:"chat-input-box",class:t.boxClass},[e("div",{staticClass:"chat-input-quick-emoji"},[e("EPopover",{ref:"emojiQuickRef",attrs:{visibleArrow:!1,transition:"",placement:"top-end",popperClass:"chat-quick-emoji-popover"},model:{value:t.emojiQuickShow,callback:function(s){t.emojiQuickShow=s},expression:"emojiQuickShow"}},[e("div",{attrs:{slot:"reference"},slot:"reference"}),e("Scrollbar",{ref:"emojiWrapper",attrs:{tag:"ul","enable-x":!0,"enable-y":!1,"touch-content-blur":!1,"class-name":"chat-quick-emoji-wrapper scrollbar-hidden"}},t._l(t.emojiQuickItems,function(s){return e("li",{on:{click:function(a){return t.onEmojiQuick(s)}}},[e("img",{attrs:{title:s.name,alt:s.name,src:s.src}})])}),0)],1)],1),e("div",{ref:"inputWrapper",staticClass:"chat-input-wrapper",on:{click:function(s){return s.stopPropagation(),t.focus.apply(null,arguments)}}},[t.quoteData?e("div",{staticClass:"chat-quote"},[t.quoteUpdate?e("div",{staticClass:"quote-label"},[t._v(t._s(t.$L("\u7F16\u8F91\u6D88\u606F")))]):e("UserAvatar",{attrs:{userid:t.quoteData.userid,userResult:t.onQuoteUserResult,"show-icon":!1,"show-name":!0}}),e("div",{staticClass:"quote-desc no-dark-content"},[t._v(t._s(t.$A.getMsgSimpleDesc(t.quoteData)))]),e("i",{directives:[{name:"touchclick",rawName:"v-touchclick",value:t.cancelQuote,expression:"cancelQuote"}],staticClass:"taskfont"},[t._v("\uE6E5")])],1):t._e(),e("div",{ref:"editor",staticClass:"no-dark-content",on:{click:function(s){return s.stopPropagation(),t.onClickEditor.apply(null,arguments)},paste:t.handlePaste}}),e("div",{staticClass:"chat-space"},[e("input",{staticClass:"space-input",on:{focus:t.onSpaceInputFocus}})]),e("ul",{staticClass:"chat-toolbar",on:{click:function(s){s.stopPropagation()}}},[e("li",[t.emojiBottom?e("ETooltip",{ref:"emojiTip",attrs:{disabled:t.$isEEUiApp||t.windowTouch||t.showEmoji,placement:"top",enterable:!1,content:t.$L("\u8868\u60C5")}},[e("i",{staticClass:"taskfont",on:{click:function(s){t.showEmoji=!t.showEmoji}}},[t._v("\uE7AD")])]):e("EPopover",{ref:"emoji",attrs:{visibleArrow:!1,placement:"top",popperClass:"chat-input-emoji-popover"},model:{value:t.showEmoji,callback:function(s){t.showEmoji=s},expression:"showEmoji"}},[e("ETooltip",{ref:"emojiTip",attrs:{slot:"reference",disabled:t.$isEEUiApp||t.windowTouch||t.showEmoji,placement:"top",enterable:!1,content:t.$L("\u8868\u60C5")},slot:"reference"},[e("i",{staticClass:"taskfont"},[t._v("\uE7AD")])]),t.showEmoji?e("ChatEmoji",{attrs:{searchKey:t.emojiQuickKey},on:{"on-select":t.onSelectEmoji}}):t._e()],1)],1),e("li",[e("ETooltip",{attrs:{placement:"top",disabled:t.$isEEUiApp||t.windowTouch,enterable:!1,content:t.$L("\u9009\u62E9\u6210\u5458")}},[e("i",{staticClass:"taskfont",on:{click:function(s){return t.onToolbar("user")}}},[t._v("\uE78F")])])],1),e("li",[e("ETooltip",{attrs:{placement:"top",disabled:t.$isEEUiApp||t.windowTouch,enterable:!1,content:t.$L("\u9009\u62E9\u4EFB\u52A1")}},[e("i",{staticClass:"taskfont",on:{click:function(s){return t.onToolbar("task")}}},[t._v("\uE7D6")])])],1),e("li",[e("EPopover",{ref:"more",attrs:{visibleArrow:!1,placement:"top",popperClass:"chat-input-more-popover"},model:{value:t.showMore,callback:function(s){t.showMore=s},expression:"showMore"}},[e("ETooltip",{ref:"moreTip",attrs:{slot:"reference",disabled:t.$isEEUiApp||t.windowTouch||t.showMore,placement:"top",enterable:!1,content:t.$L("\u5C55\u5F00")},slot:"reference"},[e("i",{staticClass:"taskfont"},[t._v("\uE790")])]),t.recordReady?e("div",{staticClass:"chat-input-popover-item",on:{click:function(s){return t.onToolbar("meeting")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE7C1")]),t._v(" "+t._s(t.$L("\u65B0\u4F1A\u8BAE"))+" ")]):t._e(),t.canCall?e("div",{staticClass:"chat-input-popover-item",on:{click:function(s){return t.onToolbar("call")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE7BA")]),t._v(" "+t._s(t.$L("\u62E8\u6253\u7535\u8BDD"))+" ")]):t._e(),e("div",{staticClass:"chat-input-popover-item",on:{click:function(s){return t.onToolbar("image")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE7BC")]),t._v(" "+t._s(t.$L("\u53D1\u9001\u56FE\u7247"))+" ")]),e("div",{staticClass:"chat-input-popover-item",on:{click:function(s){return t.onToolbar("file")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE7C0")]),t._v(" "+t._s(t.$L("\u4E0A\u4F20\u6587\u4EF6"))+" ")]),t.canAnon?e("div",{staticClass:"chat-input-popover-item",on:{click:function(s){return t.onToolbar("anon")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE690")]),t._v(" "+t._s(t.$L("\u533F\u540D\u6D88\u606F"))+" ")]):t._e(),t.dialogData.type=="group"?e("div",{staticClass:"chat-input-popover-item",on:{click:function(s){return t.onToolbar("word-chain")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE80A")]),t._v(" "+t._s(t.$L("\u53D1\u8D77\u63A5\u9F99"))+" ")]):t._e(),t.dialogData.type=="group"?e("div",{staticClass:"chat-input-popover-item",on:{click:function(s){return t.onToolbar("vote")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE7FD")]),t._v(" "+t._s(t.$L("\u53D1\u8D77\u6295\u7968"))+" ")]):t._e(),e("div",{staticClass:"chat-input-popover-item",on:{click:function(s){return t.onToolbar("full")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE6A7")]),t._v(" "+t._s(t.$L("\u5168\u5C4F\u8F93\u5165"))+" ")])],1)],1),e("li",{directives:[{name:"touchmouse",rawName:"v-touchmouse",value:t.clickSend,expression:"clickSend"},{name:"longpress",rawName:"v-longpress",value:{callback:t.onShowMenu,delay:300},expression:"{callback: onShowMenu, delay: 300}"}],ref:"chatSend",staticClass:"chat-send",class:t.sendClass},[e("EPopover",{ref:"menu",attrs:{visibleArrow:!1,trigger:"manual",placement:"top",popperClass:"chat-input-more-popover"},model:{value:t.showMenu,callback:function(s){t.showMenu=s},expression:"showMenu"}},[e("ETooltip",{ref:"sendTip",attrs:{slot:"reference",placement:"top",disabled:t.$isEEUiApp||t.windowTouch||t.showMenu,enterable:!1,content:t.$L(t.sendContent)},slot:"reference"},[t.loading?e("div",[e("div",{staticClass:"chat-load"},[e("Loading")],1)]):e("div",[e("transition",{attrs:{name:"mobile-send"}},[t.sendClass==="recorder"?e("i",{staticClass:"taskfont"},[t._v("\uE609")]):t._e()]),e("transition",{attrs:{name:"mobile-send"}},[t.sendClass!=="recorder"?e("i",{staticClass:"taskfont"},[t._v("\uE606")]):t._e()])],1)]),e("div",{staticClass:"chat-input-popover-item",on:{click:function(s){return t.onSend("silence")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE7D7")]),t._v(" "+t._s(t.$L("\u65E0\u58F0\u53D1\u9001"))+" ")]),e("div",{staticClass:"chat-input-popover-item",on:{click:function(s){return t.onSend("md")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE647")]),t._v(" "+t._s(t.$L("MD \u683C\u5F0F\u53D1\u9001"))+" ")]),e("div",{staticClass:"chat-input-popover-item",on:{click:function(s){return t.onSend("normal")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE71B")]),t._v(" "+t._s(t.$L("\u666E\u901A\u683C\u5F0F\u53D1\u9001"))+" ")])],1)],1)]),e("div",{staticClass:"chat-record"},[e("div",{ref:"recwave"})]),e("div",{staticClass:"chat-cover",on:{click:function(s){return s.stopPropagation(),t.onClickCover.apply(null,arguments)}}})]),t.emojiBottom&&t.showEmoji?e("ChatEmoji",{attrs:{searchKey:t.emojiQuickKey},on:{"on-select":t.onSelectEmoji}}):t._e(),e("transition",{attrs:{name:"fade"}},[["ready","ing"].includes(t.recordState)?e("div",{directives:[{name:"transfer-dom",rawName:"v-transfer-dom"}],staticClass:"chat-input-record-transfer",class:{cancel:t.touchLimitY},style:t.recordTransferStyle,attrs:{"data-transfer":!0},on:{click:t.stopRecord}},[t.recordDuration>0?e("div",{staticClass:"record-duration"},[t._v(t._s(t.recordFormatDuration))]):e("div",{staticClass:"record-loading"},[e("Loading",{attrs:{type:"pure"}})],1),e("div",{staticClass:"record-cancel",on:{click:function(s){return s.stopPropagation(),t.stopRecord(!0)}}},[t._v(t._s(t.$L(t.touchLimitY?"\u677E\u5F00\u53D6\u6D88":"\u5411\u4E0A\u6ED1\u52A8\u53D6\u6D88")))])]):t._e()]),e("Modal",{attrs:{"mask-closable":!1,beforeClose:t.onFullBeforeClose,"class-name":"chat-input-full-input","footer-hide":"",fullscreen:""},model:{value:t.fullInput,callback:function(s){t.fullInput=s},expression:"fullInput"}},[e("div",{staticClass:"chat-input-box"},[e("div",{staticClass:"chat-input-wrapper"},[e("div",{ref:"editorFull",staticClass:"no-dark-content"})])]),e("i",{staticClass:"taskfont",attrs:{slot:"close"},slot:"close"},[t._v("\uE6AB")])])],1)},Jt=[];const Xt={name:"ChatInput",components:{ChatEmoji:U},directives:{touchmouse:Ht,touchclick:N,TransferDom:Qt,clickoutside:W,longpress:w},props:{value:{type:[String,Number],default:""},dialogId:{type:Number,default:0},taskId:{type:Number,default:0},placeholder:{type:String,default:""},disabled:{type:Boolean,default:!1},disabledRecord:{type:Boolean,default:!1},loading:{type:Boolean,default:!1},emojiBottom:{type:Boolean,default:!1},sendMenu:{type:Boolean,default:!0},simpleMode:{type:Boolean,default:!1},options:{type:Object,default:()=>({})},toolbar:{type:Array,default:()=>["bold","strike","italic","underline","blockquote","link",{list:"ordered"},{list:"bullet"},{list:"check"}]},maxlength:{type:Number},defaultMenuOrientation:{type:String,default:"top"},replyMsgAutoMention:{type:Boolean,default:!0}},data(){return{quill:null,isFocus:!1,rangeIndex:0,_content:"",_options:{},mentionMode:"",userList:null,userCache:null,taskList:null,fileList:{},showMenu:!1,showMore:!1,showEmoji:!1,emojiQuickShow:!1,emojiQuickKey:"",emojiQuickItems:[],recordReady:!1,recordRec:null,recordBlob:null,recordWave:null,recordInter:null,recordState:"stop",recordDuration:0,touchStart:{},touchFocus:!1,touchLimitX:!1,touchLimitY:!1,pasteClean:!0,changeLoad:0,isSpecVersion:this.checkIOSVersion(),emojiTimer:null,scrollTimer:null,textTimer:null,fileTimer:null,moreTimer:null,selectTimer:null,selectRange:null,fullInput:!1,fullQuill:null}},created(){A(this.dialogId,this._uid)},mounted(){this.init(),this.recordInter=setInterval(t=>{this.recordState==="ing"&&(this.__recordDuration&&this.__recordDuration===this.recordDuration?(this.__recordDuration=null,this.stopRecord(!0),$A.messageWarning("\u5F55\u97F3\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5")):this.__recordDuration=this.recordDuration)},1e3),this.$isEEUiApp&&(window.__onPermissionRequest=(t,i)=>{t==="recordAudio"&&i===!1&&this.stopRecord(!0)}),$A.loadScript("js/emoticon.all.js")},beforeDestroy(){var t;E(this.dialogId,this._uid),this.quill&&((t=this.quill.getModule("mention"))==null||t.hideMentionList(),this.quill=null),this.recordRec&&(this.recordRec=null),this.recordInter&&clearInterval(this.recordInter)},computed:{...g(["cacheProjects","cacheTasks","cacheUserBasic","cacheDialogs","dialogMsgs","cacheKeyboard"]),isEnterSend({cacheKeyboard:t}){return this.$isEEUiApp?t.send_button_app==="enter":t.send_button_desktop==="enter"},canCall(){return this.dialogData.type==="user"&&!this.dialogData.bot&&this.$isEEUiApp},canAnon(){return this.dialogData.type==="user"&&!this.dialogData.bot},recordTransferStyle(){const{windowScrollY:t}=this;return t>0?{marginTop:t/2+"px"}:null},boxClass(){const t=[];return["ready","ing"].includes(this.recordState)&&(this.recordState==="ing"&&this.recordDuration>0?t.push("record-progress"):t.push("record-ready")),this.simpleMode&&t.push("simple-mode"),this.showMenu&&t.push("show-menu"),this.showMore&&t.push("show-more"),this.showEmoji&&t.push("show-emoji"),this.mentionMode&&t.push(this.mentionMode),t},sendClass(){return this.filterInvalidLine(this.value)?"sender":this.recordReady?"recorder":""},sendContent(){const{sendTip:t}=this.$refs;return t&&t.$refs.popper&&(t.$refs.popper.style.visibility="hidden",t.showPopper=!1,setTimeout(i=>{t.$refs.popper&&(t.$refs.popper.style.visibility="visible")},300)),this.sendClass==="recorder"?"\u957F\u6309\u5F55\u97F3":"\u53D1\u9001"},recordFormatDuration(){const{recordDuration:t}=this;let i=Math.floor(t/6e4),e=Math.floor(t/1e3)%60,s=("00"+t%1e3).substr(-2);return i<10&&(i=`0${i}`),e<10&&(e=`0${e}`),`${i}:${e}\u2033${s}`},dialogData(){return this.dialogId>0?this.cacheDialogs.find(({id:t})=>t==this.dialogId)||{}:{}},quoteUpdate(){return this.dialogData.extra_quote_type==="update"},quoteData(){const{extra_quote_id:t}=this.dialogData;return t?this.dialogMsgs.find(i=>i.id===t):null}},watch:{value(t){this.quill&&(t&&t!==this._content?(this._content=t,this.setContent(t)):t||this.quill.setText("")),this.simpleMode||this.$store.dispatch("saveDialogDraft",{id:this.dialogId,extra_draft_content:this.filterInvalidLine(t)})},disabled(t){var i;(i=this.quill)==null||i.enable(!t)},dialogId(t,i){this.userList=null,this.userCache=null,this.taskList=null,this.fileList={},this.loadInputDraft(),A(t,this._uid),E(i,this._uid)},taskId(){this.userList=null,this.userCache=null,this.taskList=null,this.fileList={},this.loadInputDraft()},"dialogData.extra_draft_content"(){this.isFocus||this.loadInputDraft()},showMenu(t){t&&(this.showMore=!1,this.showEmoji=!1,this.emojiQuickShow=!1)},showMore(t){t&&(this.showMenu=!1,this.showEmoji=!1,this.emojiQuickShow=!1)},showEmoji(t){if(this.emojiBottom&&(t?this.quill.enable(!1):this.disabled||this.quill.enable(!0)),t){let i=this.value.replace(/&nbsp;/g," ").replace(/<[^>]+>/g,"");if(i&&i.indexOf(" ")===-1&&i.length>=1&&i.length<=8?this.emojiQuickKey=i:this.emojiQuickKey="",this.showMenu=!1,this.showMore=!1,this.emojiQuickShow=!1,this.quill){const e=this.quill.selection.savedRange;this.rangeIndex=e?e.index:0}}else this.rangeIndex>0&&this.quill.setSelection(this.rangeIndex)},emojiQuickShow(t){t&&(this.showMenu=!1,this.showMore=!1,this.showEmoji=!1)},isFocus(t){this.scrollTimer&&clearInterval(this.scrollTimer),t?(this.$emit("on-focus"),this.hidePopover(),this.isSpecVersion||this.windowPortrait&&(this.scrollTimer=setInterval(()=>{var i;(i=this.quill)!=null&&i.hasFocus()?this.windowScrollY>0&&$A.scrollIntoViewIfNeeded(this.$refs.editor):clearInterval(this.scrollTimer)},200))):this.$emit("on-blur")},recordState(t){t==="ing"?this.recordWave=window.Recorder.FrequencyHistogramView({elem:this.$refs.recwave,lineCount:90,position:0,minHeight:1,stripeEnable:!1}):(this.recordWave=null,this.$refs.recwave.innerHTML=""),this.$emit("on-record-state",t)},fullInput(t){var i;(i=this.quill)==null||i.enable(!t)}},methods:{init(){this._options=Object.assign({theme:"bubble",bubbleTooltipTop:!0,formats:["bold","strike","italic","underline","blockquote","list","link","image","mention"],readOnly:!1,placeholder:this.placeholder,modules:{toolbar:this.$isEEUiApp||this.windowTouch?!1:this.toolbar,keyboard:this.simpleMode?{}:{bindings:{"short enter":{key:"Enter",shortKey:!0,handler:t=>this.isEnterSend?!0:(this.onSend(),!1)},enter:{key:"Enter",shiftKey:!1,handler:t=>this.isEnterSend?(this.onSend(),!1):!0},esc:{key:"Escape",shiftKey:!1,handler:t=>this.emojiQuickShow?(this.emojiQuickShow=!1,!1):!0}}},mention:this.quillMention()}},this.options),this.quill=new v(this.$refs.editor,this._options),this.quill.enable(!this.disabled),this.value?this.setContent(this.value):this.loadInputDraft(),this.quill.on("selection-change",t=>{if(t)this.selectRange=t;else if(this.selectRange&&document.activeElement&&/(ql-editor|ql-clipboard)/.test(document.activeElement.className)){this.selectTimer&&clearTimeout(this.selectTimer),this.selectTimer=setTimeout(i=>{this.quill.setSelection(this.selectRange.index,this.selectRange.length)},100);return}this.isFocus=!!t}),this.quill.on("text-change",t=>{this.textTimer?clearTimeout(this.textTimer):this.changeLoad++,this.textTimer=setTimeout(i=>{this.textTimer=null,this.changeLoad--,this.maxlength>0&&this.quill.getLength()>this.maxlength&&this.quill.deleteText(this.maxlength,this.quill.getLength());let e=this.$refs.editor.firstChild.innerHTML;this.updateEmojiQuick(e),this._content=e,this.$emit("input",this._content),this.$nextTick(s=>{const a=this.quill.getSelection();if(a){const o=this.quill.getText(a.index);/^\n\n$/.test(o)&&this.quill.deleteText(a.index,1)}})},100)}),this.quill.clipboard.addMatcher(Node.ELEMENT_NODE,(t,i)=>(this.pasteClean&&(i.ops=i.ops.map(e=>{const s={insert:e.insert};try{typeof s.insert.mention=="object"&&t.innerHTML&&(s.insert=t.innerHTML.replace(/<[^>]+>/g,""))}catch{}return e.attributes&&["bold","strike","italic","underline","list","blockquote","link"].some(a=>{e.attributes[a]&&(typeof s.attributes=="undefined"&&(s.attributes={}),s.attributes[a]=e.attributes[a])}),s})),i)),this.$nextTick(t=>{this.quill.root.addEventListener("keydown",i=>{if(i.key==="\r\r"&&i.keyCode===229){const{index:e}=this.quill.getSelection(!0);this.quill.insertText(e,`\r
`),this.keyTimer&&clearTimeout(this.keyTimer),this.keyTimer=setTimeout(s=>{this.$refs.editor.firstChild.childNodes.forEach(a=>{/^\r+/.test(a.innerHTML)&&(a.innerHTML=a.innerHTML.replace(/^\r+/,"")||"<br>")})},200)}}),this.$isEEUiApp&&this.cacheKeyboard.send_button_app==="enter"&&this.quill.root.setAttribute("enterkeyhint","send")}),this.$emit("on-ready",this.quill),this.disabledRecord||$A.loadScriptS(["js/recorder/recorder.mp3.min.js","js/recorder/lib.fft.js","js/recorder/frequency.histogram.view.js"]).then(t=>{typeof window.Recorder=="function"&&(this.recordRec=window.Recorder({type:"mp3",bitRate:64,sampleRate:32e3,audioTrackSet:null,disableEnvInFix:!1,onProcess:(i,e,s,a,o,r)=>{var n;(n=this.recordWave)==null||n.input(i[i.length-1],e,a),this.recordDuration=s,s>=3*60*1e3&&this.stopRecord(!1)}}),window.Recorder.Support()&&(this.recordReady=!0))})},quillMention(){return{allowedChars:/^\S*$/,mentionDenotationChars:["@","#","~"],defaultMenuOrientation:this.defaultMenuOrientation,isolateCharacter:!0,positioningStrategy:"fixed",renderItem:t=>{if(t.disabled===!0)return`<div class="mention-item-disabled">${t.value}</div>`;if(t.id===0)return`<div class="mention-item-at">@</div><div class="mention-item-name">${t.value}</div><div class="mention-item-tip">${t.tip}</div>`;if(t.avatar){const i=t.bot?'<div class="taskfont mention-item-bot">&#xe68c;</div>':"";return`<div class="mention-item-img${t.online?" online":""}"><img src="${t.avatar}"/><em></em></div>${i}<div class="mention-item-name">${t.value}</div>`}return t.tip?`<div class="mention-item-name" title="${t.value}">${t.value}</div><div class="mention-item-tip">${t.tip}</div>`:`<div class="mention-item-name" title="${t.value}">${t.value}</div>`},renderLoading:()=>"Loading...",source:(t,i,e)=>{const s=e=="@"?"user-mention":e=="#"?"task-mention":"file-mention",a=document.getElementsByClassName("ql-mention-list-container");for(let r=0;r<a.length;r++)a[r].classList.remove("user-mention"),a[r].classList.remove("task-mention"),a[r].classList.remove("file-mention"),a[r].classList.add(s),$A.scrollPreventThrough(a[r]);let o=null;this.getMentionSource(e,t,r=>{const n=[];r.some(l=>{let d=l.list;t&&(d=d.filter(({value:c})=>$A.strExists(c,t))),d.length>0&&(l.label&&n.push(...l.label),n.push(...d))}),$A.jsonStringify(n.map(({id:l})=>l))!==o&&(o=$A.jsonStringify(n.map(({id:l})=>l)),i(n,t))})}}},updateEmojiQuick(t){if(!this.isFocus||!t){this.emojiQuickShow=!1;return}this.emojiTimer&&clearTimeout(this.emojiTimer),this.emojiTimer=setTimeout(i=>{if(this.emojiTimer=null,/<img/i.test(t)){this.emojiQuickShow=!1;return}if(t=t.replace(/&nbsp;/g," ").replace(/<[^>]+>/g,""),t&&t.indexOf(" ")===-1&&t.length>=1&&t.length<=8&&$A.isArray(window.emoticonData)){this.emojiQuickItems=[];const e=$A.mainUrl("images/emoticon");if(window.emoticonData.some(s=>{let a=0;if(s.list.some(o=>{const r=[o.name];if(o.key&&r.push(...`${o.key}`.split(" ")),r.includes(t)&&(this.emojiQuickItems.push(Object.assign(o,{type:"emoticon",asset:`images/emoticon/${s.path}/${o.path}`,name:o.name,src:`${e}/${s.path}/${o.path}`})),++a>=2))return!0}),this.emojiQuickItems.length>=20)return!0}),this.emojiQuickItems.length>0){this.$refs.emojiWrapper.$el.style.maxWidth=`${Math.min(500,this.$refs.inputWrapper.clientWidth)}px`,this.$nextTick(s=>{this.emojiQuickShow=!0,this.$refs.emojiQuickRef.updatePopper()});return}}this.emojiQuickShow=!1},100)},getText(){return this.quill?`${this.quill.getText()}`.replace(/^\s+|\s+$/g,""):""},setText(t){this.quill&&this.quill.setText(t)},setContent(t){this.quill&&this.quill.setContents(this.quill.clipboard.convert({html:t}))},setPasteMode(t){this.pasteClean=t},loadInputDraft(){const{extra_draft_content:t}=this.dialogData;if(this.simpleMode||!t){this.$emit("input","");return}this.pasteClean=!1,this.$emit("input",t),this.$nextTick(i=>this.pasteClean=!0)},onClickEditor(){this.clearSearchKey(),this.updateEmojiQuick(this.value)},clearSearchKey(){this.$parent.$options.name==="DialogWrapper"&&(this.$store.state.messengerSearchKey.dialog!=""||this.$store.state.messengerSearchKey.contacts!="")&&setTimeout(t=>{this.$parent.onActive()},10),this.$store.state.messengerSearchKey={dialog:"",contacts:""}},focus(){this.$nextTick(()=>{this.quill&&(this.quill.setSelection(this.quill.getLength()),this.quill.focus())})},blur(){this.$nextTick(()=>{this.quill&&this.quill.blur()})},clickSend(t,i){var e;if(!this.loading)switch(t){case"down":if(this.touchFocus=(e=this.quill)==null?void 0:e.hasFocus(),this.touchLimitX=!1,this.touchLimitY=!1,this.touchStart=i.type==="touchstart"?i.touches[0]:i,(i.button===void 0||i.button===0)&&this.startRecord())return;i.button===2&&this.onShowMenu();break;case"move":const s=i.type==="touchmove"?i.touches[0]:i;this.touchLimitX=(this.touchStart.clientX-s.clientX)/window.innerWidth>.1,this.touchLimitY=(this.touchStart.clientY-s.clientY)/window.innerHeight>.1;break;case"up":if(this.showMenu||this.stopRecord(this.touchLimitY)||this.touchLimitY||this.touchLimitX)return;this.onSend();break;case"click":this.touchFocus&&(this.quill.blur(),this.quill.focus());break}},onShowMenu(){this.sendClass==="recorder"||!this.sendMenu||(this.showMenu=!0)},onSend(t="auto"){this.emojiTimer&&clearTimeout(this.emojiTimer),this.emojiQuickShow=!1,setTimeout(i=>{this.filterInvalidLine(this.value)!==""&&(this.hidePopover("send"),this.rangeIndex=0,this.clearSearchKey(),t==="auto"&&(t=H(this.value)?"md":""),t==="normal"&&(t=""),t?this.$emit("on-send",null,t):this.$emit("on-send"))},this.changeLoad>0?100:0)},startRecord(){return this.sendClass==="recorder"?(this.$store.dispatch("audioStop",!0),this.recordDuration=0,this.recordState="ready",this.$nextTick(t=>{this.recordRec.open(i=>{this.recordState==="ready"?(this.recordState="ing",this.recordBlob=null,setTimeout(e=>{this.recordRec.start()},300)):this.recordRec.close()},i=>{this.recordState="stop",$A.messageError(i||"\u6253\u5F00\u5F55\u97F3\u5931\u8D25")})}),!0):!1},stopRecord(t){switch(this.recordState){case"ing":return this.recordState="stop",this.recordRec.stop((i,e)=>{this.recordRec.close(),t!==!0&&(e<600?$A.messageWarning("\u8BF4\u8BDD\u65F6\u95F4\u592A\u77ED"):(this.recordBlob=i,this.uploadRecord(e)))},i=>{this.recordRec.close(),$A.messageError(i||"\u5F55\u97F3\u5931\u8D25")}),!0;case"ready":return this.recordState="stop",!0;default:return this.recordState="stop",!1}},hidePopover(t){this.showMenu=!1,this.showMore=!1,t!=="send"&&(this.showEmoji=!1,this.emojiQuickShow=!1)},onClickCover(){this.hidePopover(),this.$nextTick(t=>{var i;(i=this.quill)==null||i.focus()})},uploadRecord(t){if(this.recordBlob===null)return;const i=new FileReader;i.onloadend=()=>{this.$emit("on-record",{type:this.recordBlob.type,base64:i.result,duration:t})},i.readAsDataURL(this.recordBlob)},onEmojiQuick(t){t.type==="online"?(this.$emit("input",""),this.$emit("on-send",`<img src="${t.src}"/>`)):(this.$emit("input",""),this.$emit("on-send",`<img class="emoticon" data-asset="${t.asset}" data-name="${t.name}" src="${t.src}"/>`)),this.emojiQuickShow=!1,this.focus()},onSelectEmoji(t){!this.quill||(t.type==="emoji"?(this.quill.insertText(this.rangeIndex,t.text),this.rangeIndex+=t.text.length,this.windowLandscape&&(this.showEmoji=!1)):t.type==="emoticon"&&(this.$emit("on-send",`<img class="emoticon" data-asset="${t.asset}" data-name="${t.name}" src="${t.src}"/>`),t.asset==="emosearch"&&this.$emit("input",""),this.windowLandscape&&(this.showEmoji=!1)))},onToolbar(t){switch(this.hidePopover(),t){case"user":this.openMenu("@");break;case"task":this.openMenu("#");break;case"meeting":$.Store.set("addMeeting",{type:"create",dialog_id:this.dialogId,userids:[this.userId]});break;case"full":this.onFullInput();break;case"image":case"file":case"call":case"anon":this.$emit("on-more",t);break;case"word-chain":this.$store.state.dialogDroupWordChain={type:"create",dialog_id:this.dialogId};break;case"vote":this.$store.state.dialogGroupVote={type:"create",dialog_id:this.dialogId};break}},onFullInput(){this.disabled||(this.fullInput=!this.fullInput,this.fullInput&&this.$nextTick(t=>{this.fullQuill=new v(this.$refs.editorFull,Object.assign({theme:"bubble",readOnly:!1,placeholder:this.placeholder,modules:{toolbar:this.toolbar,mention:this.quillMention()}},this.options)),this.fullQuill.enable(!0),this.$refs.editorFull.firstChild.innerHTML=this.$refs.editor.firstChild.innerHTML,this.$nextTick(i=>{this.fullQuill.setSelection(this.fullQuill.getLength()),this.fullQuill.focus()})}))},onFullBeforeClose(){return new Promise(t=>{var i;(i=this.$refs.editorFull)!=null&&i.firstChild&&(this.$refs.editor.firstChild.innerHTML=this.$refs.editorFull.firstChild.innerHTML),t()})},setQuote(t,i="reply"){this.dialogId>0&&this.$store.dispatch("saveDialog",{id:this.dialogId,extra_quote_id:t,extra_quote_type:i==="update"?"update":"reply"})},cancelQuote(){if(this.quoteUpdate)this.$emit("input","");else if(this.quoteData&&this.$refs.editor.firstChild.querySelectorAll("img").length===0){const t=document.createElement("div");t.innerHTML=this.$refs.editor.firstChild.innerHTML,t.querySelectorAll("span.mention").forEach(i=>{i.getAttribute("data-id")==this.quoteData.userid&&(i.innerHTML="")}),t.innerText.replace(/\s/g,"")||this.$emit("input","")}this.setQuote(0)},onQuoteUserResult(t){this.dialogData.type==="group"&&(this.quoteUpdate||!this.quoteData||!this.replyMsgAutoMention||t.bot&&!$A.rightExists(t.email,"@bot.system")||this.userId===t.userid||this.quoteData.userid!==t.userid||new RegExp(`<span[^>]+?class="mention"[^>]+?data-id="${t.userid}"[^>]*?>`).test(this.$refs.editor.firstChild.innerHTML)||this.addMention({denotationChar:"@",id:t.userid,value:t.nickname}))},onSpaceInputFocus(){var t;this.selectRange&&((t=this.quill)==null||t.setSelection(this.selectRange.index,this.selectRange.length))},openMenu(t){if(!!this.quill)if(this.value.length===0||this.value.endsWith("<p><br></p>"))this.quill.getModule("mention").openMenu(t);else{let i=this.value.replace(/<[^>]+>/g,"");i.length===0||i.endsWith(" ")?this.quill.getModule("mention").openMenu(t):this.quill.getModule("mention").openMenu(` ${t}`)}},addMention(t){if(!this.quill||!Kt(this.dialogId,this._uid))return;const{index:i}=this.quill.getSelection(!0);this.quill.insertEmbed(i,"mention",t,v.sources.USER),this.quill.insertText(i+1," ",v.sources.USER),this.quill.setSelection(i+2,v.sources.USER)},getProjectId(){let t=null;if(this.dialogId>0){if(t=this.cacheProjects.find(({dialog_id:i})=>i==this.dialogId),t)return t.id;if(t=this.cacheTasks.find(({dialog_id:i})=>i==this.dialogId),t)return t.project_id}else if(this.taskId>0&&(t=this.cacheTasks.find(({id:i})=>i==this.taskId),t))return t.project_id;return 0},getMentionSource(t,i,e){switch(t){case"@":this.mentionMode="user-mention";const s=n=>{this.getMoreUser(i,n.map(l=>l.id)).then(l=>{let d=this.cacheDialogs.filter((c,h)=>c.type=="user"&&c.bot==0&&c.last_at);d.sort((c,h)=>c.last_at>h.last_at?-1:c.last_at<h.last_at?1:0),d=d.filter((c,h)=>h<5),l.forEach(c=>{c.last_at="1990-01-01 00:00:00",d.forEach(h=>{var m;((m=h.dialog_user)==null?void 0:m.userid)==c.id&&(c.last_at=h.last_at)})}),l.sort((c,h)=>c.last_at>h.last_at?-1:c.last_at<h.last_at?1:0),this.userList=n,this.userCache=[],l.length>0?(n.length>2&&this.userCache.push({label:null,list:[{id:0,value:this.$L("\u6240\u6709\u4EBA"),tip:this.$L("\u4EC5\u63D0\u793A\u4F1A\u8BDD\u5185\u6210\u5458")}]}),this.userCache.push({label:[{id:0,value:this.$L("\u4F1A\u8BDD\u5185\u6210\u5458"),disabled:!0}],list:n},{label:[{id:0,value:this.$L("\u4F1A\u8BDD\u4EE5\u5916\u6210\u5458"),disabled:!0}],list:l})):n.length>2?this.userCache.push({label:null,list:[{id:0,value:this.$L("\u6240\u6709\u4EBA"),tip:this.$L("\u63D0\u793A\u6240\u6709\u6210\u5458")}]},{label:[{id:0,value:this.$L("\u4F1A\u8BDD\u5185\u6210\u5458"),disabled:!0}],list:n}):this.userCache.push({label:null,list:n}),e(this.userCache)})};if(this.dialogData.people&&$A.arrayLength(this.userList)!==this.dialogData.people&&(this.userList=null,this.userCache=null),this.userCache!==null&&e(this.userCache),this.userList!==null){s(this.userList);return}const a=[];if(this.dialogId>0)this.$store.dispatch("call",{url:"dialog/user",data:{dialog_id:this.dialogId,getuser:1}}).then(({data:n})=>{this.cacheDialogs.find(({id:l})=>l==this.dialogId)&&this.$store.dispatch("saveDialog",{id:this.dialogId,people:n.length}),n.length>0&&a.push(...n.map(l=>({id:l.userid,value:l.nickname,avatar:l.userimg,online:l.online,bot:l.bot}))),s(a)}).catch(n=>{s(a)});else if(this.taskId>0){const n=this.cacheTasks.find(({id:l})=>l==this.taskId);n&&$A.isArray(n.task_user)&&n.task_user.some(l=>{const d=this.cacheUserBasic.find(({userid:c})=>c==l.userid);d&&a.push({id:d.userid,value:d.nickname,avatar:d.userimg,online:d.online,bot:d.bot})}),s(a)}break;case"#":if(this.mentionMode="task-mention",this.taskList!==null){e(this.taskList);return}const o=n=>{this.taskList=[],n.length>0&&(n=n.map(c=>({id:c.id,value:c.name,tip:c.complete_at?this.$L("\u5DF2\u5B8C\u6210"):null})).splice(0,100),this.taskList.push({label:[{id:0,value:this.$L("\u9879\u76EE\u4EFB\u52A1"),disabled:!0}],list:n}));let l=this.$store.getters.transforTasks(this.$store.getters.dashboardTask.all);l.length>0&&(l=l.sort((c,h)=>$A.Date(c.end_at||"2099-12-31 23:59:59")-$A.Date(h.end_at||"2099-12-31 23:59:59")).splice(0,100),this.taskList.push({label:[{id:0,value:this.$L("\u6211\u7684\u5F85\u5B8C\u6210\u4EFB\u52A1"),disabled:!0}],list:l.map(c=>({id:c.id,value:c.name}))}));let d=this.$store.getters.assistTask;d.length>0&&(d=d.sort((c,h)=>$A.Date(c.end_at||"2099-12-31 23:59:59")-$A.Date(h.end_at||"2099-12-31 23:59:59")).splice(0,100),this.taskList.push({label:[{id:0,value:this.$L("\u6211\u534F\u52A9\u7684\u4EFB\u52A1"),disabled:!0}],list:d.map(c=>({id:c.id,value:c.name}))})),e(this.taskList)},r=this.getProjectId();if(r>0){this.$store.dispatch("getTaskForProject",r).then(n=>{const l=this.cacheTasks.filter(d=>d.archived_at?!1:d.project_id==r&&d.parent_id===0&&!d.archived_at).sort((d,c)=>$A.Date(c.complete_at||"2099-12-31 23:59:59")-$A.Date(d.complete_at||"2099-12-31 23:59:59"));l.length>0?o(l):o([])}).catch(n=>{o([])});return}o([]);break;case"~":if(this.mentionMode="file-mention",$A.isArray(this.fileList[i])){e(this.fileList[i]);return}this.fileTimer&&clearTimeout(this.fileTimer),this.fileTimer=setTimeout(n=>{this.$store.dispatch("searchFiles",i).then(({data:l})=>{this.fileList[i]=[{label:[{id:0,value:this.$L("\u6587\u4EF6\u5206\u4EAB\u67E5\u770B"),disabled:!0}],list:l.filter(d=>d.type!=="folder").map(d=>({id:d.id,value:d.ext?`${d.name}.${d.ext}`:d.name}))}],e(this.fileList[i])}).catch(()=>{e([])})},300);break;default:e([]);break}},getMoreUser(t,i){return new Promise(e=>{const{owner_id:s,type:a}=this.dialogData,o=a==="group"&&[0,this.userId].includes(s);this.taskId>0||o?(this.moreTimer&&clearTimeout(this.moreTimer),this.moreTimer=setTimeout(r=>{this.$store.dispatch("call",{url:"users/search",data:{keys:{key:t},state:1,take:30}}).then(({data:n})=>{const l=n.filter(d=>!i.includes(d.userid));e(l.map(d=>({id:d.userid,value:d.nickname,avatar:d.userimg,online:!!d.online})))}).catch(n=>{e([])})},this.userCache===null?0:600)):e([])})},checkIOSVersion(){let i=(window&&window.navigator&&window.navigator.userAgent).match(/OS ((\d+_?){2,3})\s/i);const s=(i?i[1].replace(/_/g,"."):"unknown").split(".");return+s[0]==11&&+s[1]>=0&&+s[1]<3},handlePaste(t){const i=Array.prototype.slice.call(t.clipboardData.files);i.filter(s=>!$A.leftExists(s.type,"image/")).length>0&&(t.preventDefault(),this.$emit("on-file",i))},filterInvalidLine(t){return(t+"").replace(/^(<p>\s*<\/p>)+|(<p>\s*<\/p>)+$/gi,"").replace(/^(<p><br\/*><\/p>)+|(<p><br\/*><\/p>)+$/gi,"")},updateTools(){var i,e,s,a;this.showEmoji&&((i=this.$refs.emoji)==null||i.updatePopper()),this.showMore&&((e=this.$refs.more)==null||e.updatePopper()),this.showMenu&&((s=this.$refs.menu)==null||s.updatePopper());const t=(a=this.quill)==null?void 0:a.getModule("mention");t.isOpen&&t.setMentionContainerPosition()}}},j={};var Zt=u(Xt,Yt,Jt,!1,te,null,null,null);function te(t){for(let i in j)this[i]=j[i]}var ee=function(){return Zt.exports}(),se=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("Modal",{attrs:{"class-name":"dialog-droup-word-chain","mask-closable":!1,title:t.dialogDroupWordChain.type=="create"?t.$L("\u53D1\u8D77\u63A5\u9F99"):t.$L("\u63A5\u9F99\u7ED3\u679C"),closable:!t.isFullscreen,fullscreen:t.isFullscreen,"footer-hide":t.isFullscreen},scopedSlots:t._u([{key:"header",fn:function(){return[t.isFullscreen?e("div",{staticClass:"chain-modal-header"},[e("div",{staticClass:"chain-modal-close",on:{click:function(s){t.show=!1}}},[t._v(" "+t._s(t.$L("\u53D6\u6D88"))+" ")]),e("div",{staticClass:"chain-modal-title"},[t._v(" "+t._s(t.dialogDroupWordChain.type=="create"?t.$L("\u53D1\u8D77\u63A5\u9F99"):t.$L("\u63A5\u9F99\u7ED3\u679C"))+" ")]),e("div",{staticClass:"chain-modal-submit",class:{disabled:!t.isEdit},on:{click:t.onSend}},[t.loadIng>0?e("div",{staticClass:"submit-loading"},[e("Loading")],1):t._e(),t._v(" "+t._s(t.$L("\u53D1\u9001"))+" ")])]):t._e()]},proxy:!0},{key:"close",fn:function(){return[e("i",{staticClass:"ivu-icon ivu-icon-ios-close"})]},proxy:!0}]),model:{value:t.show,callback:function(s){t.show=s},expression:"show"}},[e("div",{ref:"wordChainBodyRef",staticClass:"word-chain-body"},[t.dialogDroupWordChain.type=="create"?e("div",{staticClass:"source"},[t._v(" "+t._s(t.$L("\u6765\u81EA"))+" "),e("span",[t._v(t._s(t.dialog.name))])]):t._e(),e("div",{staticClass:"initiate"},[e("span",[t._v(t._s(t.$L("\u7531")))]),e("UserAvatar",{attrs:{userid:t.createId,size:22,showName:!0}}),e("span",[t._v(" "+t._s(t.$L("\u53D1\u8D77\uFF0C\u53C2\u4E0E\u63A5\u9F99\u76EE\u524D\u5171"+t.num+"\u4EBA")))])],1),e("div",{staticClass:"textarea"},[e("Input",{ref:"wordChainTextareaRef",attrs:{type:"textarea",autosize:{minRows:3,maxRows:5},disabled:t.dialogDroupWordChain.type!="create",placeholder:t.$L("\u8BF7\u8F93\u5165\u63A5\u9F99\u4E3B\u9898")},model:{value:t.value,callback:function(s){t.value=s},expression:"value"}})],1),e("ul",{ref:"wordChainListRef"},[t._l(t.list,function(s){return s.type=="case"&&(t.dialogDroupWordChain.type=="create"||s.text)?e("li",[e("span",[t._v(t._s(t.$L("\u4F8B")))]),e("Input",{attrs:{placeholder:t.$L("\u53EF\u586B\u5199\u63A5\u9F99\u683C\u5F0F"),disabled:t.dialogDroupWordChain.type!="create"},model:{value:s.text,callback:function(a){t.$set(s,"text",a)},expression:"item.text"}})],1):t._e()}),t._l(t.list.filter(function(s){return s.type!="case"}),function(s,a){return e("li",[e("span",[t._v(t._s(a+1))]),e("Input",{attrs:{disabled:s.userid!=t.userId,placeholder:t.$L("\u8BF7\u8F93\u5165\u63A5\u9F99\u5185\u5BB9")},model:{value:s.text,callback:function(o){t.$set(s,"text",o)},expression:"item.text"}})],1)}),e("li",{staticClass:"add"},[e("i",{staticClass:"taskfont",on:{click:t.onAdd}},[t._v("\uE78C")])])],2)]),e("div",{attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(s){t.show=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.loadIng>0,disabled:!t.isEdit},on:{click:t.onSend}},[t._v(t._s(t.$L("\u53D1\u9001")))])],1)])},ie=[];const ae={name:"DialogDroupWordChain",data(){return{show:!1,createId:0,value:"#"+this.$L("\u63A5\u9F99")+` 
`,list:[],oldData:"",loadIng:0}},computed:{...g(["dialogDroupWordChain","userInfo","dialogMsgs","cacheDialogs"]),isFullscreen({windowWidth:t}){return t<576},num(){var t;return((t=this.list.filter(i=>i.type!="case"))==null?void 0:t.length)||0},allList(){var e;const t=((e=this.dialogDroupWordChain.msgData)==null?void 0:e.msg)||{};let i=JSON.parse(JSON.stringify(t.list||[]));return this.dialogMsgs.filter(s=>{var a;return s.type=="word-chain"&&((a=s.msg)==null?void 0:a.uuid)==t.uuid}).forEach(s=>{(s.msg.list||[]).forEach(a=>{a.type!="case"&&i.map(o=>o.id).indexOf(a.id)==-1&&i.push(a)})}),i.filter(s=>(s.text||"").trim())},isEdit(){return this.oldData!=JSON.stringify(this.list)},dialog(){return this.cacheDialogs.find(t=>t.id==this.dialogDroupWordChain.dialog_id)||{}}},watch:{show(t){t?(this.dialogDroupWordChain.type=="create"&&this.$nextTick(()=>{this.$refs.wordChainTextareaRef.focus()}),this.scrollTo()):(this.value="#"+this.$L("\u63A5\u9F99")+` 
`,this.list=[])},dialogDroupWordChain(t){t.type=="create"&&t.dialog_id&&(this.show=!0,this.createId=this.userId,this.list=[],this.list.push({id:Date.now(),type:"case",userid:this.userId,text:""}),this.list.push({id:Date.now()+1,type:"text",userid:this.userId,text:this.userInfo.nickname})),t.type=="participate"&&t.dialog_id&&t.msgData&&(this.show=!0,this.createId=t.msgData.msg.createid||t.msgData.msg.userid,this.value=t.msgData.msg.text,this.list=this.allList,this.oldData=JSON.stringify(this.list))}},methods:{onAdd(){this.list.push({id:Date.now(),type:"text",userid:this.userId,text:this.userInfo.nickname}),this.scrollTo()},scrollTo(){this.$nextTick(()=>{this.$refs.wordChainListRef.scrollTo(0,99999)})},onSend(){if(!this.isEdit)return;if(!this.value){$A.messageError("\u8BF7\u8F93\u5165\u63A5\u9F99\u4E3B\u9898");return}const t=this.list.map(i=>i.text);if(t.length!=[...new Set(t)].length){$A.modalConfirm({content:"\u91CD\u590D\u5185\u5BB9\u5C06\u4E0D\u518D\u8BA1\u5165\u63A5\u9F99\u7ED3\u679C",cancelText:"\u8FD4\u56DE\u7F16\u8F91",okText:"\u7EE7\u7EED\u53D1\u9001",onOk:()=>{this.send()}});return}this.send()},send(){var i,e;const t=[];this.list.forEach(s=>{(s.text||s.type!="case")&&t.map(a=>a.text).indexOf(s.text)==-1&&t.push(s)}),this.loadIng++,this.$store.dispatch("call",{url:"dialog/msg/wordchain",method:"post",data:{dialog_id:this.dialogDroupWordChain.dialog_id,text:this.value,list:t,uuid:((e=(i=this.dialogDroupWordChain.msgData)==null?void 0:i.msg)==null?void 0:e.uuid)||""}}).then(({data:s})=>{this.show=!1,this.$store.dispatch("saveDialogMsg",s)}).catch(({msg:s})=>{if(s.indexOf("System error")!==-1){$A.modalInfo({title:"\u7248\u672C\u8FC7\u4F4E",content:"\u670D\u52A1\u5668\u7248\u672C\u8FC7\u4F4E\uFF0C\u8BF7\u5347\u7EA7\u670D\u52A1\u5668\u3002"});return}$A.modalError(s)}).finally(s=>{this.loadIng--})}}},F={};var oe=u(ae,se,ie,!1,re,null,null,null);function re(t){for(let i in F)this[i]=F[i]}var ne=function(){return oe.exports}(),le=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("Modal",{attrs:{"class-name":"dialog-droup-word-chain","mask-closable":!1,title:t.dialogGroupVote.type=="create"?t.$L("\u53D1\u8D77\u6295\u7968"):t.$L("\u6295\u7968\u7ED3\u679C"),closable:!t.isFullscreen,fullscreen:t.isFullscreen,"footer-hide":t.isFullscreen},scopedSlots:t._u([{key:"header",fn:function(){return[t.isFullscreen?e("div",{staticClass:"chain-modal-header"},[e("div",{staticClass:"chain-modal-close",on:{click:function(s){t.show=!1}}},[t._v(" "+t._s(t.$L("\u53D6\u6D88"))+" ")]),e("div",{staticClass:"chain-modal-title"},[t._v(" "+t._s(t.dialogGroupVote.type=="create"?t.$L("\u53D1\u8D77\u6295\u7968"):t.$L("\u6295\u7968\u7ED3\u679C"))+" ")]),e("div",{staticClass:"chain-modal-submit",class:{disabled:!t.isEdit},on:{click:t.onSend}},[t.loadIng>0?e("div",{staticClass:"submit-loading"},[e("Loading")],1):t._e(),t._v(" "+t._s(t.$L("\u53D1\u9001"))+" ")])]):t._e()]},proxy:!0},{key:"close",fn:function(){return[e("i",{staticClass:"ivu-icon ivu-icon-ios-close"})]},proxy:!0}]),model:{value:t.show,callback:function(s){t.show=s},expression:"show"}},[e("div",{ref:"wordChainBodyRef",staticClass:"word-chain-body"},[t.dialogGroupVote.type=="create"?e("div",{staticClass:"source"},[t._v(" "+t._s(t.$L("\u6765\u81EA"))+" "),e("span",[t._v(t._s(t.dialog.name))])]):t._e(),e("div",{staticClass:"initiate"},[e("span",[t._v(t._s(t.$L("\u7531")))]),e("UserAvatar",{attrs:{userid:t.createId,size:22,showName:!0,tooltipDisabled:""}}),e("span",[t._v(" "+t._s(t.$L("\u53D1\u8D77")))])],1),e("div",{staticClass:"textarea"},[e("Input",{ref:"wordChainTextareaRef",attrs:{type:"textarea",placeholder:t.$L("\u8BF7\u8F93\u5165\u6295\u7968\u4E3B\u9898"),autosize:{minRows:3,maxRows:5},disabled:t.dialogGroupVote.type!="create"},model:{value:t.value,callback:function(s){t.value=s},expression:"value"}})],1),e("ul",{ref:"wordChainListRef"},[t._l(t.list,function(s,a){return e("li",[e("i",{staticClass:"taskfont",class:{disabled:t.list.length<=2},on:{click:function(o){return t.onDel(a)}}},[t._v("\uE680")]),e("Input",{attrs:{placeholder:t.$L("\u8BF7\u8F93\u5165\u9009\u9879\u5185\u5BB9")},model:{value:s.text,callback:function(o){t.$set(s,"text",o)},expression:"item.text"}})],1)}),e("li",{staticClass:"add"},[e("i",{staticClass:"taskfont",on:{click:t.onAdd}},[t._v("\uE78C")])])],2),t.dialogGroupVote.type=="create"?e("div",{staticClass:"switch-row"},[e("span",{staticClass:"label"},[t._v(t._s(t.$L("\u5141\u8BB8\u591A\u9009")))]),e("iSwitch",{attrs:{"true-value":1,"false-value":0},model:{value:t.multiple,callback:function(s){t.multiple=s},expression:"multiple"}})],1):t._e(),t.dialogGroupVote.type=="create"?e("div",{staticClass:"switch-row"},[e("span",{staticClass:"label"},[t._v(t._s(t.$L("\u533F\u540D\u6295\u7968")))]),e("iSwitch",{attrs:{"true-value":1,"false-value":0},model:{value:t.anonymous,callback:function(s){t.anonymous=s},expression:"anonymous"}})],1):t._e()]),e("div",{attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(s){t.show=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.loadIng>0,disabled:!t.isEdit},on:{click:t.onSend}},[t._v(t._s(t.$L("\u53D1\u9001")))])],1)])},de=[];const ce={name:"DialogGroupVote",data(){return{show:!1,createId:0,value:"",list:[],multiple:0,anonymous:0,oldData:"",loadIng:0}},computed:{...g(["dialogGroupVote","userInfo","dialogMsgs","cacheDialogs"]),isFullscreen({windowWidth:t}){return t<576},allList(){var e;const t=((e=this.dialogGroupVote.msgData)==null?void 0:e.msg)||{};let i=JSON.parse(JSON.stringify(t.list||[]));return this.dialogMsgs.filter(s=>{var a;return s.type=="word-chain"&&((a=s.msg)==null?void 0:a.uuid)==t.uuid}).forEach(s=>{(s.msg.list||[]).forEach(a=>{i.map(o=>o.id).indexOf(a.id)==-1&&i.push(a)})}),i},isEdit(){return this.oldData!=JSON.stringify(this.list)},dialog(){return this.cacheDialogs.find(t=>t.id==this.dialogGroupVote.dialog_id)||{}}},watch:{show(t){t?(this.dialogGroupVote.type=="create"&&this.$nextTick(()=>{this.$refs.wordChainTextareaRef.focus()}),this.scrollTo()):(this.value="",this.list=[])},dialogGroupVote(t){t.type=="create"&&t.dialog_id&&(this.show=!0,this.createId=this.userId,this.list=[{id:Date.now(),text:""},{id:Date.now()+1,text:""}]),t.type=="participate"&&t.dialog_id&&t.msgData&&(this.show=!0,this.createId=t.msgData.msg.userid,this.value=t.msgData.msg.text,this.list=this.allList,this.oldData=JSON.stringify(this.list))}},methods:{onAdd(){this.list.push({id:Date.now(),text:""}),this.scrollTo()},onDel(t){this.list.length>2&&this.list.splice(t,1)},scrollTo(){this.$nextTick(()=>{this.$refs.wordChainListRef.scrollTo(0,99999)})},onSend(){var t,i;if(!!this.isEdit){if(!this.value){$A.messageError("\u8BF7\u8F93\u5165\u6295\u7968\u4E3B\u9898");return}if(this.list.find(e=>!e.text)){$A.messageError("\u8BF7\u8F93\u5165\u9009\u9879\u5185\u5BB9");return}this.loadIng++,this.$store.dispatch("call",{url:"dialog/msg/vote",method:"post",data:{dialog_id:this.dialogGroupVote.dialog_id,text:this.value,list:this.list,uuid:((i=(t=this.dialogGroupVote.msgData)==null?void 0:t.msg)==null?void 0:i.uuid)||"",multiple:this.multiple,anonymous:this.anonymous}}).then(({data:e})=>{this.show=!1,this.$store.dispatch("saveDialogMsg",e)}).catch(({msg:e})=>{if(e.indexOf("System error")!==-1){$A.modalInfo({title:"\u7248\u672C\u8FC7\u4F4E",content:"\u670D\u52A1\u5668\u7248\u672C\u8FC7\u4F4E\uFF0C\u8BF7\u5347\u7EA7\u670D\u52A1\u5668\u3002"});return}$A.modalError(e)}).finally(e=>{this.loadIng--})}}}},R={};var he=u(ce,le,de,!1,ue,null,null,null);function ue(t){for(let i in R)this[i]=R[i]}var pe=function(){return he.exports}(),me=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{staticClass:"dialog-complaint-info"},[e("div",{staticClass:"group-complaint-title"},[t._v(t._s(t.$L("\u533F\u540D\u4E3E\u62A5")))]),e("div",{staticClass:"group-complaint-warp"},[e("div",{staticClass:"group-complaint-title underline required"},[t._v(t._s(t.$L("\u8BF7\u9009\u62E9\u4E3E\u62A5\u7C7B\u578B"))+":")]),e("div",{staticClass:"group-complaint-list"},[e("List",t._l(t.typeList,function(s,a){return e("ListItem",{key:a,class:{active:t.typeId==s.id}},[e("div",{staticClass:"text",on:{click:function(o){return t.onSelectType(s)}}},[t._v(t._s(t.$L(s.label)))]),e("RadioGroup",{model:{value:t.typeId,callback:function(o){t.typeId=o},expression:"typeId"}},[e("Radio",{attrs:{label:s.id,"model-value":t.typeId}},[t._v("\xA0")])],1)],1)}),1)],1),e("div",{staticClass:"group-complaint-title required"},[t._v(t._s(t.$L("\u8BF7\u8F93\u5165\u4E3E\u62A5\u539F\u56E0"))+":")]),e("div",{staticClass:"group-complaint-reason"},[e("Input",{attrs:{type:"textarea",maxlength:"500",autosize:{minRows:4,maxRows:8},placeholder:t.$L("\u8BF7\u8F93\u5165\u586B\u5199\u8BE6\u7EC6\u7684\u4E3E\u62A5\u539F\u56E0\uFF0C\u4EE5\u4F7F\u6211\u4EEC\u66F4\u597D\u7684\u5E2E\u52A9\u4F60\u89E3\u51B3\u95EE\u9898")},model:{value:t.reason,callback:function(s){t.reason=s},expression:"reason"}})],1),e("div",{staticClass:"group-complaint-img"},[e("ImgUpload",{attrs:{num:5,width:512,height:512,whcut:1},model:{value:t.imgs,callback:function(s){t.imgs=s},expression:"imgs"}})],1)]),e("div",{staticClass:"group-info-button"},[e("Button",{attrs:{type:"primary",icon:"md-add"},on:{click:t.onSubmit}},[t._v(t._s(t.$L("\u63D0\u4EA4")))])],1)])},ge=[];const fe={name:"DialogComplaint",components:{ImgUpload:B},props:{dialogId:{type:Number,default:0}},data(){return{typeList:[{id:10,label:"\u8BC8\u9A97\u8BF1\u5BFC\u8F6C\u8D26"},{id:20,label:"\u5F15\u6D41\u4E0B\u8F7D\u5176\u4ED6APP\u4ED8\u8D39"},{id:30,label:"\u6572\u8BC8\u52D2\u7D22"},{id:40,label:"\u7167\u7247\u4E0E\u672C\u4EBA\u4E0D\u4E00\u81F4"},{id:50,label:"\u8272\u60C5\u4F4E\u4FD7"},{id:60,label:"\u9891\u7E41\u5E7F\u544A\u9A9A\u6270"},{id:70,label:"\u5176\u4ED6\u95EE\u9898"}],typeId:0,reason:"",imgs:[]}},methods:{onSelectType(t){this.typeId==t.id?this.typeId=0:this.typeId=t.id},onSubmit(){if(!this.typeId)return $A.modalError("\u8BF7\u9009\u62E9\u4E3E\u62A5\u7C7B\u578B");if(!this.reason)return $A.modalError("\u8BF7\u586B\u5199\u4E3E\u62A5\u539F\u56E0");this.$store.dispatch("call",{url:"complaint/submit",data:{dialog_id:this.dialogId,reason:this.reason,type:this.typeId,imgs:this.imgs}}).then(({data:t})=>{$A.modalSuccess("\u4E3E\u62A5\u6210\u529F"),this.$emit("on-close")}).catch(({msg:t})=>{$A.modalError(t)})}}},V={};var _e=u(fe,me,ge,!1,ve,null,null,null);function ve(t){for(let i in V)this[i]=V[i]}var $e=function(){return _e.exports}(),we=function(){var t=this,i=t.$createElement,e=t._self._c||i;return t.isReady?e("div",{staticClass:"dialog-wrapper",class:t.wrapperClass,on:{drop:function(s){return s.preventDefault(),t.chatPasteDrag(s,"drag")},dragover:function(s){return s.preventDefault(),t.chatDragOver(!0,s)},dragleave:function(s){return s.preventDefault(),t.chatDragOver(!1,s)},touchstart:t.onTouchStart,touchmove:t.onTouchMove,touchend:t.onTouchEnd}},[e("div",{ref:"nav",staticClass:"dialog-nav"},[t._t("head",function(){return[e("div",{staticClass:"nav-wrapper",class:t.navClass},[e("div",{staticClass:"dialog-back",on:{click:t.onBack}},[e("i",{staticClass:"taskfont"},[t._v("\uE676")]),t.msgUnreadOnly?e("div",{staticClass:"back-num"},[t._v(t._s(t.msgUnreadOnly))]):t._e()]),e("div",{staticClass:"dialog-block"},[e("div",{staticClass:"dialog-avatar",on:{click:t.onViewAvatar}},[t.dialogData.type=="group"?[t.dialogData.avatar?e("EAvatar",{staticClass:"img-avatar",attrs:{src:t.dialogData.avatar,size:42}}):t.dialogData.group_type=="department"?e("i",{staticClass:"taskfont icon-avatar department"},[t._v("\uE75C")]):t.dialogData.group_type=="project"?e("i",{staticClass:"taskfont icon-avatar project"},[t._v("\uE6F9")]):t.dialogData.group_type=="task"?e("i",{staticClass:"taskfont icon-avatar task"},[t._v("\uE6F4")]):t.dialogData.group_type=="okr"?e("i",{staticClass:"taskfont icon-avatar task"},[t._v("\uE6F4")]):e("Icon",{staticClass:"icon-avatar",attrs:{type:"ios-people"}})]:t.dialogData.dialog_user?e("div",{staticClass:"user-avatar"},[e("UserAvatarTip",{attrs:{online:t.dialogData.online_state,userid:t.dialogData.dialog_user.userid,size:42},on:{"update:online":function(s){return t.$set(t.dialogData,"online_state",s)}}},[t.dialogData.type==="user"&&t.dialogData.online_state!==!0?e("p",{attrs:{slot:"end"},slot:"end"},[t._v(" "+t._s(t.$L(t.dialogData.online_state))+" ")]):t._e()])],1):e("Icon",{staticClass:"icon-avatar",attrs:{type:"md-person"}})],2),e("div",{staticClass:"dialog-title"},[e("div",{staticClass:"main-title"},[t._l(t.$A.dialogTags(t.dialogData),function(s){return s.color!="success"?[e("Tag",{attrs:{color:s.color,fade:!1}},[t._v(t._s(t.$L(s.text)))])]:t._e()}),e("h2",[t._v(t._s(t.dialogData.name))]),t.peopleNum>0?e("em",{on:{click:function(s){return t.onDialogMenu("groupInfo")}}},[t._v("("+t._s(t.peopleNum)+")")]):t._e(),t.dialogData.bot?e("Tag",{staticClass:"after",attrs:{fade:!1}},[t._v(t._s(t.$L("\u673A\u5668\u4EBA")))]):t._e(),t.dialogData.type==="user"&&t.approvaUserStatus?e("Tag",{staticClass:"after",attrs:{color:"red",fade:!1}},[t._v(t._s(t.$L(t.approvaUserStatus)))]):t._e(),t.dialogData.group_type=="all"?e("Tag",{staticClass:"after pointer",attrs:{fade:!1},on:{"on-click":function(s){return t.onDialogMenu("groupInfo")}}},[t._v(t._s(t.$L("\u5168\u5458")))]):t.dialogData.group_type=="department"?e("Tag",{staticClass:"after pointer",attrs:{fade:!1},on:{"on-click":function(s){return t.onDialogMenu("groupInfo")}}},[t._v(t._s(t.$L("\u90E8\u95E8")))]):t._e(),t.msgLoadIng>0&&t.allMsgs.length>0?e("div",{staticClass:"load"},[e("Loading")],1):t._e()],2),e("ul",{staticClass:"title-desc"},[t.dialogData.type==="user"?e("li",{class:[t.dialogData.online_state===!0?"online":"offline"]},[t._v(" "+t._s(t.$L(t.dialogData.online_state===!0?"\u5728\u7EBF":t.dialogData.online_state))+" ")]):t._e()]),t.tagShow?e("ul",{staticClass:"title-tags scrollbar-hidden"},t._l(t.msgTags,function(s){var a;return e("li",{key:s.type,class:(a={},a[s.type||"msg"]=!0,a.active=t.msgType===s.type,a),on:{click:function(o){return t.onMsgType(s.type)}}},[e("i",{staticClass:"no-dark-content"}),e("span",[t._v(t._s(t.$L(s.label)))])])}),0):t._e()])]),e("EDropdown",{staticClass:"dialog-menu",attrs:{trigger:"click"},on:{command:t.onDialogMenu}},[e("i",{staticClass:"taskfont dialog-menu-icon"},[t._v("\uE6E9")]),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},[e("EDropdownItem",{attrs:{command:"searchMsg"}},[e("div",[t._v(t._s(t.$L("\u641C\u7D22\u6D88\u606F")))])]),t.dialogData.type==="user"?[t.isManageBot?e("EDropdownItem",{attrs:{command:"modifyNormal"}},[e("div",[t._v(t._s(t.$L("\u4FEE\u6539\u8D44\u6599")))])]):t._e(),e("EDropdownItem",{attrs:{command:"openCreate"}},[e("div",[t._v(t._s(t.$L("\u521B\u5EFA\u7FA4\u7EC4")))])]),t.dialogData.bot==0?e("EDropdownItem",{attrs:{command:"report"}},[e("div",[t._v(t._s(t.$L("\u4E3E\u62A5\u6295\u8BC9")))])]):t._e()]:[e("EDropdownItem",{attrs:{command:"groupInfo"}},[e("div",[t._v(t._s(t.$L("\u7FA4\u7EC4\u8BBE\u7F6E")))])]),t.dialogData.owner_id!=t.userId?[t.dialogData.group_type==="all"&&t.userIsAdmin?e("EDropdownItem",{attrs:{command:"modifyAdmin"}},[e("div",[t._v(t._s(t.$L("\u4FEE\u6539\u8D44\u6599")))])]):t._e(),e("EDropdownItem",{attrs:{command:"report"}},[e("div",[t._v(t._s(t.$L("\u4E3E\u62A5\u6295\u8BC9")))])]),e("EDropdownItem",{attrs:{command:"exit"}},[e("div",{staticStyle:{color:"#f00"}},[t._v(t._s(t.$L("\u9000\u51FA\u7FA4\u7EC4")))])])]:t.dialogData.group_type==="user"?[e("EDropdownItem",{attrs:{command:"modifyNormal"}},[e("div",[t._v(t._s(t.$L("\u4FEE\u6539\u8D44\u6599")))])]),e("EDropdownItem",{attrs:{command:"transfer"}},[e("div",[t._v(t._s(t.$L("\u8F6C\u8BA9\u7FA4\u4E3B")))])]),e("EDropdownItem",{attrs:{command:"report"}},[e("div",[t._v(t._s(t.$L("\u4E3E\u62A5\u6295\u8BC9")))])]),e("EDropdownItem",{attrs:{command:"disband"}},[e("div",{staticStyle:{color:"#f00"}},[t._v(t._s(t.$L("\u89E3\u6563\u7FA4\u7EC4")))])])]:t._e()]],2)],1),t.searchShow?e("div",{staticClass:"dialog-search"},[e("div",{staticClass:"search-location"},[e("i",{staticClass:"taskfont",on:{click:function(s){return t.onSearchSwitch("prev")}}},[t._v("\uE702")]),e("i",{staticClass:"taskfont",on:{click:function(s){return t.onSearchSwitch("next")}}},[t._v("\uE705")])]),e("div",{staticClass:"search-input"},[e("div",{staticClass:"search-pre"},[t.searchLoad>0?e("Loading"):e("Icon",{attrs:{type:"ios-search"}})],1),e("Input",{ref:"searchInput",attrs:{placeholder:t.$L("\u641C\u7D22\u6D88\u606F"),clearable:""},on:{"on-keyup":t.onSearchKeyup},model:{value:t.searchKey,callback:function(s){t.searchKey=s},expression:"searchKey"}}),t.searchLoad===0&&t.searchResult.length>0?e("div",{staticClass:"search-total"},[t._v(t._s(t.searchLocation)+"/"+t._s(t.searchResult.length))]):t._e()],1),e("div",{staticClass:"search-cancel",on:{click:function(s){return t.onSearchKeyup(null)}}},[t._v(t._s(t.$L("\u53D6\u6D88")))])]):t._e()],1)]})],2),t.topShow?e("div",{staticClass:"dialog-top-message",on:{click:t.onPosTop}},[e("div",{staticClass:"dialog-top-message-warp"},[t._m(0),e("div",{staticClass:"dialog-top-message-content"},[e("p",{staticClass:"content"},[e("UserAvatar",{attrs:{userid:t.topMsg.userid,showName:"",showIcon:!1}}),t._v(": "),e("span",[t._v(t._s(t.$A.getMsgSimpleDesc(t.topMsg)))])],1),e("p",{staticClass:"personnel"},[t._v(" "+t._s(t.$L("\u7F6E\u9876\u4EBA\u5458"))+" "),e("UserAvatar",{attrs:{userid:t.dialogData.top_userid,showName:"",showIcon:!1}})],1)]),e("div",{staticClass:"dialog-top-message-btn"},[t.topPosLoad>0?e("Loading",{attrs:{type:"pure"}}):e("i",{staticClass:"taskfont"},[t._v("\uEE15")]),e("i",{staticClass:"taskfont",on:{click:function(s){return s.stopPropagation(),t.onCancelTop(t.topMsg)}}},[t._v("\uE6E5")])],1)])]):t._e(),e("div",{ref:"msgs",staticClass:"dialog-msgs"},[t.positionShow&&t.positionMsg?e("div",{staticClass:"dialog-position"},[e("div",{staticClass:"position-label",on:{click:function(s){return t.onPositionMark(t.positionMsg.msg_id)}}},[t.positionLoad>0?e("Icon",{staticClass:"icon-loading",attrs:{type:"ios-loading"}}):e("i",{staticClass:"taskfont"},[t._v("\uE624")]),t._v(" "+t._s(t.positionMsg.label)+" ")],1)]):t._e(),e("VirtualList",{ref:"scroller",staticClass:"dialog-scroller scrollbar-virtual",attrs:{"active-prefix":"item","data-key":"id","data-sources":t.allMsgs,"data-component":t.msgItem,"extra-props":{dialogData:t.dialogData,operateVisible:t.operateVisible,operateItem:t.operateItem,isMyDialog:t.isMyDialog,msgId:t.msgId,unreadOne:t.unreadOne,scrollIng:t.scrollIng,readEnabled:t.readEnabled},"estimate-size":t.dialogData.type=="group"?105:77,keeps:t.dialogMsgKeep,disabled:t.scrollDisabled},on:{activity:t.onActivity,scroll:t.onScroll,range:t.onRange,totop:t.onPrevPage,"on-mention":t.onMention,"on-longpress":t.onLongpress,"on-view-reply":t.onViewReply,"on-view-text":t.onViewText,"on-view-file":t.onViewFile,"on-down-file":t.onDownFile,"on-reply-list":t.onReplyList,"on-error":t.onError,"on-emoji":t.onEmoji,"on-other":t.onOther,"on-show-emoji-user":t.onShowEmojiUser},scopedSlots:t._u([t.isChildComponent?null:{key:"header",fn:function(){return[e("div",{staticClass:"dialog-item head-box"},[t.loadIng>0||t.prevId>0?e("div",{staticClass:"loading",class:{filled:t.allMsgs.length===0}},[t.scrollOffset<100?e("span"):t._e()]):t.allMsgs.length===0?e("div",{staticClass:"describe filled"},[t._v(t._s(t.$L("\u6682\u65E0\u6D88\u606F")))]):t._e()])]},proxy:!0}],null,!0)})],1),e("div",{ref:"footer",staticClass:"dialog-footer",on:{click:t.onActive}},[t.scrollTail>500||t.msgNew>0&&t.allMsgs.length>0?e("div",{directives:[{name:"touchclick",rawName:"v-touchclick",value:t.onToBottom,expression:"onToBottom"}],staticClass:"dialog-goto"},[e("Badge",{attrs:{"overflow-count":999,count:t.msgNew}},[e("i",{staticClass:"taskfont"},[t._v("\uE72B")])])],1):t._e(),e("DialogUpload",{ref:"chatUpload",staticClass:"chat-upload",attrs:{"dialog-id":t.dialogId,maxSize:t.maxSize},on:{"on-progress":function(s){return t.chatFile("progress",s)},"on-success":function(s){return t.chatFile("success",s)},"on-error":function(s){return t.chatFile("error",s)}}}),t.todoShow?e("div",{staticClass:"chat-bottom-menu"},[e("div",{staticClass:"bottom-menu-label"},[t._v(t._s(t.$L("\u5F85\u529E"))+":")]),e("ul",{staticClass:"scrollbar-hidden"},t._l(t.todoList,function(s){return e("li",{on:{click:function(a){return a.stopPropagation(),t.onViewTodo(s)}}},[e("div",{staticClass:"bottom-menu-desc no-dark-content"},[t._v(t._s(t.$A.getMsgSimpleDesc(s.msg_data)))])])}),0)]):t.quickShow?e("div",{staticClass:"chat-bottom-menu"},[e("ul",{staticClass:"scrollbar-hidden"},t._l(t.quickMsgs,function(s){return e("li",{on:{click:function(a){return a.stopPropagation(),t.sendQuick(s)}}},[e("div",{staticClass:"bottom-menu-desc no-dark-content",style:s.style||null},[t._v(t._s(s.label))])])}),0)]):t._e(),t.isMute?e("div",{staticClass:"chat-mute"},[t._v(" "+t._s(t.$L("\u7981\u8A00\u53D1\u8A00"))+" ")]):e("ChatInput",{ref:"input",attrs:{"dialog-id":t.dialogId,"emoji-bottom":t.windowPortrait,maxlength:2e5,placeholder:t.$L("\u8F93\u5165\u6D88\u606F..."),"reply-msg-auto-mention":t.replyMsgAutoMention},on:{"on-focus":t.onEventFocus,"on-blur":t.onEventBlur,"on-more":t.onEventMore,"on-file":t.sendFileMsg,"on-send":t.sendMsg,"on-record":t.sendRecord,"on-record-state":t.onRecordState},model:{value:t.msgText,callback:function(s){t.msgText=s},expression:"msgText"}})],1),e("div",{directives:[{name:"show",rawName:"v-show",value:t.operateVisible,expression:"operateVisible"}],staticClass:"operate-position",style:t.operateStyles},[e("Dropdown",{attrs:{trigger:"custom",placement:"top",visible:t.operateVisible,transferClassName:"dialog-wrapper-operate",transfer:""},on:{"on-clickoutside":function(s){t.operateVisible=!1}}},[e("div",{style:{userSelect:t.operateVisible?"none":"auto",height:t.operateStyles.height}}),e("DropdownMenu",{attrs:{slot:"list"},slot:"list"},[t.operateItem.created_at?[e("DropdownItem",{attrs:{name:"action"}},[e("ul",{staticClass:"operate-action"},[t.msgId===0?e("li",{on:{click:function(s){return t.onOperate("reply")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE6EB")]),e("span",[t._v(t._s(t.$L("\u56DE\u590D")))])]):t._e(),t.operateItem.userid==t.userId&&t.operateItem.type==="text"?e("li",{on:{click:function(s){return t.onOperate("update")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE779")]),e("span",[t._v(t._s(t.$L("\u7F16\u8F91")))])]):t._e(),t.actionPermission(t.operateItem,"voice2text")?e("li",{on:{click:function(s){return t.onOperate("voice2text")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE628")]),e("span",[t._v(t._s(t.$L("\u8F6C\u6587\u5B57")))])]):t._e(),t._l(t.operateCopys,function(s){return e("li",{on:{click:function(a){return t.onOperate("copy",s)}}},[e("i",{staticClass:"taskfont",domProps:{innerHTML:t._s(s.icon)}}),e("span",[t._v(t._s(t.$L(s.label)))])])}),t.actionPermission(t.operateItem,"forward")?e("li",{on:{click:function(s){return t.onOperate("forward")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE638")]),e("span",[t._v(t._s(t.$L("\u8F6C\u53D1")))])]):t._e(),t.operateItem.userid==t.userId?e("li",{on:{click:function(s){return t.onOperate("withdraw")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE637")]),e("span",[t._v(t._s(t.$L("\u64A4\u56DE")))])]):t._e(),t.operateItem.type==="file"?[e("li",{on:{click:function(s){return t.onOperate("view")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE77B")]),e("span",[t._v(t._s(t.$L("\u67E5\u770B")))])]),e("li",{on:{click:function(s){return t.onOperate("down")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE7A8")]),e("span",[t._v(t._s(t.$L("\u4E0B\u8F7D")))])])]:t._e(),e("li",{on:{click:function(s){return t.onOperate("tag")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE61E")]),e("span",[t._v(t._s(t.$L(t.operateItem.tag?"\u53D6\u6D88\u6807\u6CE8":"\u6807\u6CE8")))])]),t.actionPermission(t.operateItem,"newTask")?e("li",{on:{click:function(s){return t.onOperate("newTask")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE7B8")]),e("span",[t._v(t._s(t.$L("\u65B0\u4EFB\u52A1")))])]):t._e(),e("li",{on:{click:function(s){return t.onOperate("todo")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE7B7")]),e("span",[t._v(t._s(t.$L(t.operateItem.todo?"\u53D6\u6D88\u5F85\u529E":"\u8BBE\u5F85\u529E")))])]),e("li",{on:{click:function(s){return t.onOperate("top")}}},[e("i",{staticClass:"taskfont",domProps:{innerHTML:t._s(t.dialogData.top_msg_id==t.operateItem.id?"&#xe7e3;":"&#xe7e6;")}}),e("span",[t._v(t._s(t.$L(t.dialogData.top_msg_id==t.operateItem.id?"\u53D6\u6D88\u7F6E\u9876":"\u7F6E\u9876")))])]),t.msgType!==""?e("li",{on:{click:function(s){return t.onOperate("pos")}}},[e("i",{staticClass:"taskfont"},[t._v("\uEE15")]),e("span",[t._v(t._s(t.$L("\u5B8C\u6574\u5BF9\u8BDD")))])]):t._e()],2)]),e("DropdownItem",{staticClass:"dropdown-emoji",attrs:{name:"emoji"}},[e("ul",{staticClass:"operate-emoji scrollbar-hidden"},[t._l(t.operateEmojis,function(s,a){return e("li",{key:a,staticClass:"no-dark-content",domProps:{innerHTML:t._s(s)},on:{click:function(o){return t.onOperate("emoji",s)}}})}),e("li"),e("li",{staticClass:"more-emoji",on:{click:function(s){return t.onOperate("emoji","more")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE790")])])],2)])]:[e("DropdownItem",{attrs:{name:"action"}},[e("ul",{staticClass:"operate-action cancel"},[e("li",{on:{click:function(s){return t.onOperate("cancel")}}},[e("i",{staticClass:"taskfont"},[t._v("\uE6EB")]),e("span",[t._v(t._s(t.$L("\u53D6\u6D88\u53D1\u9001")))])])])])]],2)],1)],1),t.dialogDrag?e("div",{staticClass:"drag-over",on:{click:function(s){t.dialogDrag=!1}}},[e("div",{staticClass:"drag-text"},[t._v(t._s(t.$L("\u62D6\u52A8\u5230\u8FD9\u91CC\u53D1\u9001")))])]):t._e(),e("Modal",{attrs:{title:t.$L(t.pasteTitle),"cancel-text":t.$L("\u53D6\u6D88"),"ok-text":t.$L("\u53D1\u9001"),"enter-ok":!0,closable:!1,"mask-closable":!1},on:{"on-ok":t.pasteSend},model:{value:t.pasteShow,callback:function(s){t.pasteShow=s},expression:"pasteShow"}},[e("ul",{staticClass:"dialog-wrapper-paste",class:t.pasteClass},t._l(t.pasteItem,function(s){return e("li",[s.type=="image"?e("img",{attrs:{src:s.result}}):e("div",[t._v(t._s(t.$L("\u6587\u4EF6"))+": "+t._s(s.name)+" ("+t._s(t.$A.bytesToSize(s.size))+")")])])}),0)]),e("Modal",{attrs:{title:t.$L("\u4FEE\u6539\u8D44\u6599"),"mask-closable":!1},model:{value:t.modifyShow,callback:function(s){t.modifyShow=s},expression:"modifyShow"}},[e("Form",{attrs:{model:t.modifyData,"label-width":"auto"},nativeOn:{submit:function(s){s.preventDefault()}}},[t.modifyData.system_name?e("Alert",{staticStyle:{"margin-bottom":"18px"},attrs:{type:"error"}},[t._v(t._s(t.$L(`\u6B63\u5728\u4FEE\u6539\u7CFB\u7EDF\u673A\u5668\u4EBA\uFF1A${t.modifyData.system_name}`)))]):t._e(),e("FormItem",{attrs:{prop:"avatar",label:t.$L("\u5934\u50CF")}},[e("ImgUpload",{attrs:{num:1,width:512,height:512,whcut:1},model:{value:t.modifyData.avatar,callback:function(s){t.$set(t.modifyData,"avatar",s)},expression:"modifyData.avatar"}})],1),typeof t.modifyData.name!="undefined"?e("FormItem",{attrs:{prop:"name",label:t.$L("\u540D\u79F0")}},[e("Input",{attrs:{maxlength:20},model:{value:t.modifyData.name,callback:function(s){t.$set(t.modifyData,"name",s)},expression:"modifyData.name"}})],1):t._e(),t.dialogData.bot==t.userId?[typeof t.modifyData.clear_day!="undefined"?e("FormItem",{attrs:{prop:"clear_day",label:t.$L("\u6D88\u606F\u4FDD\u7559")}},[e("Input",{attrs:{maxlength:3,type:"number"},model:{value:t.modifyData.clear_day,callback:function(s){t.$set(t.modifyData,"clear_day",s)},expression:"modifyData.clear_day"}},[e("div",{attrs:{slot:"append"},slot:"append"},[t._v(t._s(t.$L("\u5929")))])])],1):t._e(),typeof t.modifyData.webhook_url!="undefined"?e("FormItem",{attrs:{prop:"webhook_url",label:"Webhook"}},[e("Input",{attrs:{maxlength:255},model:{value:t.modifyData.webhook_url,callback:function(s){t.$set(t.modifyData,"webhook_url",s)},expression:"modifyData.webhook_url"}})],1):t._e()]:t._e()],2),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(s){t.modifyShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.modifyLoad>0},on:{click:t.onModify}},[t._v(t._s(t.$L("\u4FDD\u5B58")))])],1)],1),e("UserSelect",{ref:"forwardSelect",attrs:{"multiple-max":50,title:t.$L("\u8F6C\u53D1"),"before-submit":t.onForwardBefore,"show-select-all":!1,"show-dialog":"",module:""}}),e("Modal",{attrs:{title:`${t.$L("\u8F6C\u53D1\u7ED9")}:`,"class-name":"common-user-select-modal dialog-forward-message-modal","mask-closable":!1,width:"420"},scopedSlots:t._u([{key:"footer",fn:function(){return[e("div",{staticClass:"dialog-wrapper-forward-footer",class:{selected:!t.forwardSource},on:{click:function(s){t.forwardSource=!t.forwardSource}}},[e("Icon",{staticClass:"user-modal-icon",attrs:{type:t.forwardSource?"ios-radio-button-off":"ios-checkmark-circle"}}),t._v(" "+t._s(t.$L("\u4E0D\u663E\u793A\u539F\u53D1\u9001\u8005\u4FE1\u606F"))+" ")],1),e("Button",{attrs:{type:"primary",loading:t.forwardLoad>0},on:{click:t.onForwardAffirm}},[t._v(" "+t._s(t.$L("\u786E\u5B9A"))+" "),t.forwardData.length>0?[t._v("("+t._s(t.forwardData.length)+")")]:t._e()],2)]},proxy:!0}],null,!1,3161245327),model:{value:t.forwardhow,callback:function(s){t.forwardhow=s},expression:"forwardhow"}},[e("div",{staticClass:"user-modal-search"},[e("Scrollbar",{staticClass:"search-selected",attrs:{"enable-x":"","enable-y":!1}},[e("ul",t._l(t.forwardData,function(s){return e("li",{attrs:{"data-id":s.userid}},[s.type=="group"?e("div",{staticClass:"user-modal-avatar"},[s.avatar?e("EAvatar",{staticClass:"img-avatar",attrs:{src:s.avatar,size:32}}):s.group_type=="department"?e("i",{staticClass:"taskfont icon-avatar department"},[t._v("\uE75C")]):s.group_type=="project"?e("i",{staticClass:"taskfont icon-avatar project"},[t._v("\uE6F9")]):s.group_type=="task"?e("i",{staticClass:"taskfont icon-avatar task"},[t._v("\uE6F4")]):s.group_type=="okr"?e("i",{staticClass:"taskfont icon-avatar task"},[t._v("\uE6F4")]):e("Icon",{staticClass:"icon-avatar",attrs:{type:"ios-people"}}),t.forwardData.length==1?e("div",{staticClass:"avatar-name"},[e("span",[t._v(t._s(s.name))])]):t._e()],1):e("UserAvatar",{attrs:{userid:s.userid,size:32,"show-name":t.forwardData.length==1}})],1)}),0)])],1),e("div",{staticClass:"twice-affirm-body-extend"},[e("div",{staticClass:"dialog-wrapper-forward-body"},[e("div",{staticClass:"dialog-wrapper inde-list"},[e("Scrollbar",{attrs:{"class-name":"dialog-scroller"}},[e("DialogItem",{attrs:{source:t.operateItem,simpleView:""},on:{"on-view-text":t.onViewText,"on-view-file":t.onViewFile,"on-down-file":t.onDownFile,"on-emoji":t.onEmoji,"on-other":t.onOther}})],1)],1),e("div",{staticClass:"leave-message"},[t.forwardDialogId>0?e("ChatInput",{attrs:{"dialog-id":t.forwardDialogId,"emoji-bottom":t.windowPortrait,maxlength:2e5,placeholder:t.$L("\u7559\u8A00"),"disabled-record":"","simple-mode":""},model:{value:t.forwardMessage,callback:function(s){t.forwardMessage=s},expression:"forwardMessage"}}):e("Input",{attrs:{type:"textarea",autosize:{minRows:1,maxRows:3},maxlength:2e5,placeholder:t.$L("\u7559\u8A00"),clearable:""},model:{value:t.forwardMessage,callback:function(s){t.forwardMessage=s},expression:"forwardMessage"}})],1)])])]),e("Modal",{attrs:{title:t.$L("\u8BBE\u7F6E\u5F85\u529E"),"mask-closable":!1},model:{value:t.todoSettingShow,callback:function(s){t.todoSettingShow=s},expression:"todoSettingShow"}},[e("Form",{ref:"todoSettingForm",attrs:{model:t.todoSettingData,"label-width":"auto"},nativeOn:{submit:function(s){s.preventDefault()}}},[e("FormItem",{attrs:{prop:"type",label:t.$L("\u5F53\u524D\u4F1A\u8BDD")}},[e("RadioGroup",{on:{"on-change":t.onTypeChange},model:{value:t.todoSettingData.type,callback:function(s){t.$set(t.todoSettingData,"type",s)},expression:"todoSettingData.type"}},[e("Radio",{attrs:{label:"all"}},[t._v(t._s(t.$L("\u6240\u6709\u6210\u5458")))]),e("Radio",{attrs:{label:"user"}},[t._v(t._s(t.$L("\u6307\u5B9A\u6210\u5458")))]),e("Radio",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],attrs:{label:"quick_select"}})],1),e("CheckboxGroup",{on:{"on-change":t.onQuickChange},model:{value:t.todoSettingData.quick_value,callback:function(s){t.$set(t.todoSettingData,"quick_value",s)},expression:"todoSettingData.quick_value"}},t._l(t.todoSettingData.quick_list,function(s){return e("Checkbox",{key:s,attrs:{label:s}},[e("div",{staticClass:"dialog-wrapper-todo"},[e("div",[e("UserAvatar",{attrs:{userid:s,"show-icon":!1,"show-name":!0}}),s==t.userId?e("Tag",[t._v(t._s(t.$L("\u81EA\u5DF1")))]):t._e()],1)])])}),1)],1),t.todoSettingData.type==="user"?e("FormItem",{attrs:{prop:"userids",label:t.$L("\u6307\u5B9A\u6210\u5458")}},[e("UserSelect",{ref:"userSelect",attrs:{"dialog-id":t.dialogId,title:t.$L("\u9009\u62E9\u6307\u5B9A\u6210\u5458")},model:{value:t.todoSettingData.userids,callback:function(s){t.$set(t.todoSettingData,"userids",s)},expression:"todoSettingData.userids"}})],1):t._e()],1),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(s){t.todoSettingShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.todoSettingLoad>0},on:{click:function(s){return t.onTodo("submit")}}},[t._v(t._s(t.$L("\u786E\u5B9A")))])],1)],1),t.todoSpecifyShow?e("UserSelect",{ref:"todoSpecifySelect",attrs:{"dialog-id":t.dialogId,title:t.$L("\u9009\u62E9\u6307\u5B9A\u6210\u5458"),module:"",border:"","before-submit":t.onTodoSpecify},model:{value:t.todoSpecifyData.userids,callback:function(s){t.$set(t.todoSpecifyData,"userids",s)},expression:"todoSpecifyData.userids"}}):t._e(),e("DrawerOverlay",{attrs:{placement:"right",size:400},model:{value:t.groupInfoShow,callback:function(s){t.groupInfoShow=s},expression:"groupInfoShow"}},[t.groupInfoShow?e("DialogGroupInfo",{attrs:{dialogId:t.dialogId},on:{"on-close":function(s){t.groupInfoShow=!1}}}):t._e()],1),e("DrawerOverlay",{attrs:{placement:"right",size:500},model:{value:t.reportShow,callback:function(s){t.reportShow=s},expression:"reportShow"}},[t.reportShow?e("DialogComplaint",{attrs:{dialogId:t.dialogId},on:{"on-close":function(s){t.reportShow=!1}}}):t._e()],1),e("Modal",{attrs:{title:t.$L("\u8F6C\u8BA9\u7FA4\u4E3B\u8EAB\u4EFD"),"mask-closable":!1},model:{value:t.groupTransferShow,callback:function(s){t.groupTransferShow=s},expression:"groupTransferShow"}},[e("Form",{attrs:{model:t.groupTransferData,"label-width":"auto"},nativeOn:{submit:function(s){s.preventDefault()}}},[e("FormItem",{attrs:{prop:"userid",label:t.$L("\u65B0\u7684\u7FA4\u4E3B")}},[e("UserSelect",{attrs:{disabledChoice:t.groupTransferData.disabledChoice,"multiple-max":1,title:t.$L("\u9009\u62E9\u65B0\u7684\u7FA4\u4E3B")},model:{value:t.groupTransferData.userid,callback:function(s){t.$set(t.groupTransferData,"userid",s)},expression:"groupTransferData.userid"}})],1)],1),e("div",{staticClass:"adaption",attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(s){t.groupTransferShow=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary",loading:t.groupTransferLoad>0},on:{click:function(s){return t.onDialogMenu("transferConfirm")}}},[t._v(t._s(t.$L("\u786E\u5B9A\u8F6C\u8BA9")))])],1)],1),e("DrawerOverlay",{attrs:{placement:"right","class-name":"dialog-wrapper-drawer-list",size:500},model:{value:t.replyListShow,callback:function(s){t.replyListShow=s},expression:"replyListShow"}},[t.replyListShow?e("DialogWrapper",{staticClass:"inde-list",attrs:{dialogId:t.dialogId,msgId:t.replyListId,isChildComponent:""}},[e("div",{staticClass:"drawer-title",attrs:{slot:"head"},slot:"head"},[t._v(t._s(t.$L("\u56DE\u590D\u6D88\u606F")))])]):t._e()],1),e("DrawerOverlay",{attrs:{placement:"right",size:400},model:{value:t.respondShow,callback:function(s){t.respondShow=s},expression:"respondShow"}},[t.respondShow?e("DialogRespond",{attrs:{"respond-data":t.respondData},on:{"on-close":function(s){t.respondShow=!1}}}):t._e()],1),e("DrawerOverlay",{attrs:{placement:"right","class-name":"dialog-wrapper-drawer-list",size:500},model:{value:t.todoViewShow,callback:function(s){t.todoViewShow=s},expression:"todoViewShow"}},[e("div",{staticClass:"dialog-wrapper inde-list"},[e("div",{staticClass:"dialog-nav"},[e("div",{staticClass:"drawer-title"},[t._v(t._s(t.$L("\u5F85\u529E\u6D88\u606F")))])]),e("Scrollbar",{attrs:{"class-name":"dialog-scroller"}},[t.todoViewMsg?[e("DialogItem",{attrs:{source:t.todoViewMsg,simpleView:""},on:{"on-view-text":t.onViewText,"on-view-file":t.onViewFile,"on-down-file":t.onDownFile,"on-emoji":t.onEmoji,"on-other":t.onOther}}),e("Button",{staticClass:"original-button",attrs:{icon:"md-exit",type:"text",loading:t.todoViewPosLoad},on:{click:t.onPosTodo}},[t._v(t._s(t.$L("\u56DE\u5230\u539F\u6587")))])]:e("div",{staticClass:"dialog-float-loading"},[e("Loading")],1)],2),e("div",{staticClass:"todo-button"},[e("Button",{attrs:{type:"primary",size:"large",icon:"md-checkbox-outline",loading:t.todoViewLoad,long:""},on:{click:t.onDoneTodo}},[t._v(t._s(t.$L("\u5B8C\u6210")))])],1)],1)]),e("DrawerOverlay",{attrs:{placement:"right",size:600},model:{value:t.approveDetailsShow,callback:function(s){t.approveDetailsShow=s},expression:"approveDetailsShow"}},[t.approveDetailsShow?e("ApproveDetails",{staticStyle:{height:"100%","border-radius":"10px"},attrs:{data:t.approveDetails}}):t._e()],1),e("DialogGroupWordChain"),e("DialogGroupVote")],1):t._e()},ye=[function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{staticClass:"dialog-top-message-font"},[e("i",{staticClass:"taskfont"},[t._v("\uE7E6")])])}];const Ce={name:"DialogWrapper",components:{UserAvatarTip:Z,UserSelect:P,ImgUpload:B,DialogRespond:Pt,DialogItem:b,VirtualList:J,ChatInput:ee,DialogGroupInfo:jt,DrawerOverlay:Q,DialogUpload:It,ApproveDetails:X,DialogGroupWordChain:ne,DialogGroupVote:pe,DialogComplaint:$e},directives:{touchclick:N},props:{dialogId:{type:Number,default:0},msgId:{type:Number,default:0},autoFocus:{type:Boolean,default:!1},location:{type:String,default:""},isChildComponent:{type:Boolean,default:!1},beforeBack:Function},data(){return{loadIng:0,msgItem:b,msgText:"",msgNew:0,msgType:"",msgActivity:!1,msgPrepared:!1,focusLazy:!1,focusTimer:null,allMsgs:[],tempMsgs:[],tempId:$A.randNum(1e9,9999999999),msgLoadIng:0,msgActiveId:0,pasteShow:!1,pasteFile:[],pasteItem:[],searchShow:!1,searchKey:"",searchLoad:0,searchLocation:1,searchResult:[],modifyShow:!1,modifyData:{},modifyLoad:0,forwardhow:!1,forwardData:[],forwardLoad:0,forwardDialogId:0,forwardMessage:"",forwardSource:!0,openId:0,errorId:0,dialogDrag:!1,groupInfoShow:!1,reportShow:!1,groupTransferShow:!1,groupTransferLoad:0,groupTransferData:{userid:[],disabledChoice:[]},operateClient:{x:0,y:0},operateVisible:!1,operatePreventScroll:0,operateCopys:[],operateStyles:{},operateItem:{},recordState:"",wrapperStart:null,scrollTail:0,scrollOffset:0,replyListShow:!1,replyListId:0,respondShow:!1,respondData:{},todoSettingShow:!1,todoSettingLoad:0,todoSettingData:{type:"all",userids:[],quick_value:[]},todoSpecifyShow:!1,todoSpecifyData:{type:"user",userids:[]},todoViewLoad:!1,todoViewPosLoad:!1,todoViewShow:!1,todoViewData:{},todoViewMid:0,todoViewId:0,scrollDisabled:!1,scrollDirection:null,scrollAction:0,scrollTmp:0,scrollIng:0,scrollGroup:null,approveDetails:{id:0},approveDetailsShow:!1,approvaUserStatus:"",observers:[],msgChangeCache:{},unreadOne:0,topPosLoad:0,positionLoad:0,positionShow:!1,preventMoreLoad:!1,preventToBottom:!1,selectedTextStatus:!1,scrollToBottomRefresh:!1,androidKeyboardVisible:!1,replyMsgAutoMention:!1}},mounted(){this.subMsgListener(),this.msgSubscribe=$.Store.subscribe("dialogMsgChange",this.onMsgChange),document.addEventListener("selectionchange",this.onSelectionchange)},beforeDestroy(){this.subMsgListener(!0),this.isChildComponent||(this.$store.dispatch("forgetInDialog",this._uid),this.$store.dispatch("closeDialog",this.dialogId)),this.msgSubscribe&&(this.msgSubscribe.unsubscribe(),this.msgSubscribe=null),this.observers.forEach(({observer:i})=>i.disconnect()),this.observers=[],document.removeEventListener("selectionchange",this.onSelectionchange);const t=this.$refs.scroller;t&&t.virtual.destroy()},computed:{...g(["systemConfig","userIsAdmin","taskId","dialogSearchMsgId","dialogMsgs","dialogTodos","dialogMsgTops","dialogMsgTransfer","dialogMsgKeep","dialogIns","cacheDialogs","wsOpenNum","touchBackInProgress","cacheUserBasic","fileLinks","cacheEmojis","readLoadNum","readTimeout","keyboardType","keyboardHeight","safeAreaBottom"]),...q(["isLoad"]),isReady(){return this.dialogId>0&&this.dialogData.id>0},dialogData(){const t=this.cacheDialogs.find(({id:i})=>i==this.dialogId)||{};return this.unreadOne===0&&(this.unreadOne=t.unread_one||0),t},dialogList(){return this.cacheDialogs.filter(t=>!(t.name===void 0||t.dialog_delete===1)).sort((t,i)=>t.top_at||i.top_at?$A.Date(i.top_at)-$A.Date(t.top_at):t.todo_num>0||i.todo_num>0?i.todo_num-t.todo_num:$A.Date(i.last_at)-$A.Date(t.last_at))},dialogMsgList(){return this.isReady?this.dialogMsgs.filter(t=>t.dialog_id==this.dialogId):[]},tempMsgList(){return this.isReady?this.tempMsgs.filter(t=>t.dialog_id==this.dialogId):[]},allMsgList(){const t=[];if(t.push(...this.dialogMsgList.filter(i=>this.msgFilter(i))),this.msgId>0){const i=this.dialogMsgs.find(e=>e.id==this.msgId);i&&t.unshift(i)}if(this.tempMsgList.length>0){const i=t.map(({id:s})=>s),e=this.tempMsgList.filter(s=>!i.includes(s.id)&&this.msgFilter(s));e.length>0&&t.push(...e)}return t.sort((i,e)=>i.id-e.id)},loadMsg(){return this.isLoad(`msg::${this.dialogId}-${this.msgId}-${this.msgType}`)},prevId(){return this.allMsgs.length>0?$A.runNum(this.allMsgs[0].prev_id):0},peopleNum(){return this.dialogData.type==="group"?$A.runNum(this.dialogData.people):0},pasteTitle(){const{pasteItem:t}=this;let i=t.find(({type:s})=>s=="image"),e=t.find(({type:s})=>s!="image");return i&&e?"\u53D1\u9001\u6587\u4EF6/\u56FE\u7247":i?"\u53D1\u9001\u56FE\u7247":"\u53D1\u9001\u6587\u4EF6"},msgTags({dialogData:t}){const i=[{type:"",label:"\u6D88\u606F"}];return t.has_tag&&i.push({type:"tag",label:"\u6807\u6CE8"}),t.has_todo&&i.push({type:"todo",label:"\u4E8B\u9879"}),t.has_image&&i.push({type:"image",label:"\u56FE\u7247"}),t.has_file&&i.push({type:"file",label:"\u6587\u4EF6"}),t.has_link&&i.push({type:"link",label:"\u94FE\u63A5"}),t.group_type==="project"&&i.push({type:"project",label:"\u6253\u5F00\u9879\u76EE"}),t.group_type==="task"&&i.push({type:"task",label:"\u6253\u5F00\u4EFB\u52A1"}),t.group_type==="okr"&&i.push({type:"okr",label:"\u6253\u5F00OKR"}),i},topMsg(){return this.dialogData.top_msg_id&&this.dialogMsgTops.find(({id:t})=>t==this.dialogData.top_msg_id)},quickMsgs(){return this.dialogData.quick_msgs||[]},todoList(){return this.dialogData.todo_num?this.dialogTodos.filter(t=>!t.done_at&&t.dialog_id==this.dialogId).sort((t,i)=>i.id-t.id):[]},isDefaultSize(){return this.windowScrollY===0&&!this.androidKeyboardVisible},quickShow(){return this.quickMsgs.length>0&&this.isDefaultSize&&this.quoteId===0},todoShow(){return this.todoList.length>0&&this.isDefaultSize&&this.quoteId===0},tagShow(){return this.msgTags.length>1&&this.isDefaultSize&&!this.searchShow},topShow(){return this.topMsg&&this.isDefaultSize&&!this.searchShow&&this.msgType===""},wrapperClass(){return["ready","ing"].includes(this.recordState)?"record-ready":null},navClass(){return{completed:$A.dialogCompleted(this.dialogData),tagged:this.tagShow}},pasteClass(){return this.pasteItem.find(({type:t})=>t!=="image")?["multiple"]:[]},footerPaddingBottom({keyboardType:t,keyboardHeight:i,safeAreaBottom:e,windowScrollY:s,location:a,focusLazy:o}){return s<2&&a&&o&&t==="show"&&i>0&&i<120?i+e+(a==="modal"?15:0):0},msgUnreadOnly(){let t=0;return this.cacheDialogs.some(i=>{t+=$A.getDialogNum(i)}),t<=0?"":(t>999&&(t="999+"),String(t))},isMyDialog(){const{dialogData:t,userId:i}=this;return t.dialog_user&&t.dialog_user.userid==i},isManageBot(){const{dialogData:t,userId:i,userIsAdmin:e}=this;return t.bot?t.bot==i?!0:t.dialog_user&&t.dialog_user.userid==t.bot&&e:!1},isMute(){return this.dialogData.dialog_mute==="close"?!this.userIsAdmin:!1},quoteId(){return this.msgId>0?this.msgId:this.dialogData.extra_quote_id||0},quoteData(){return this.quoteId?this.allMsgs.find(({id:t})=>t===this.quoteId):null},todoViewMsg(){if(this.todoViewMid){const t=this.allMsgs.find(i=>i.id==this.todoViewMid);if(t)return t;if(this.todoViewData.id===this.todoViewMid)return this.todoViewData}return null},positionMsg({msgNew:t,dialogData:i,allMsgs:e}){const{unread:s,unread_one:a,mention:o,mention_ids:r}=i,n=s-t,l=[];return a&&l.push({type:"unread",label:this.$L(`\u672A\u8BFB\u6D88\u606F${n}\u6761`),msg_id:a}),r&&r.length>0&&l.push(...r.map(d=>({type:"mention",label:this.$L("@\u6211\u7684\u6D88\u606F"),msg_id:d}))),n<=0||l.length===0||e.length===0?null:l.find(d=>d.type===(o===0?"unread":"mention"))||l[0]},operateEmojis({cacheEmojis:t}){const i=t.slice(0,3);return Object.values(["\u{1F44C}","\u{1F44D}","\u{1F602}","\u{1F389}","\u2764\uFE0F","\u{1F973}\uFE0F","\u{1F970}","\u{1F625}","\u{1F62D}"]).some(e=>{i.includes(e)||i.push(e)}),i},maxSize({systemConfig:t}){return t!=null&&t.file_upload_limit?t.file_upload_limit*1024:1024e3},readEnabled({msgActivity:t,msgPrepared:i}){return t===0&&i},stickToBottom({windowActive:t,scrollTail:i,preventToBottom:e}){return t&&i<=0&&!e}},watch:{$route:{handler(t){const{name:i,params:e}=t||{};i=="manage-messenger"&&e.dialog_id&&e.open&&["word-chain","vote"].includes(e.open)&&this.$nextTick(s=>{this.$store.state[e.open=="word-chain"?"dialogDroupWordChain":"dialogGroupVote"]={type:"create",dialog_id:e.dialog_id},e.open=""})},immediate:!0},dialogId:{handler(t,i){this.getDialogBase(t),this.$store.dispatch("closeDialog",i),window.localStorage.removeItem("__cache:vote__"),window.localStorage.removeItem("__cache:unfoldWordChain__")},immediate:!0},loadMsg:{handler(t){t?this.loadIng++:setTimeout(i=>{this.loadIng--},300)},immediate:!0},isReady:{handler(t){!t||this.$nextTick(i=>{if(this.$refs.msgs&&!this.observers.find(({key:e})=>e==="scroller")){const e=new ResizeObserver(this.onResizeEvent);e.observe(this.$refs.msgs),this.observers.push({key:"scroller",observer:e})}if(this.$refs.scroller&&(this.scrollGroup=this.$refs.scroller.$el.querySelector('[role="group"]'),this.scrollGroup&&!this.observers.find(({key:e})=>e==="scrollGroup"))){const e=new ResizeObserver(this.onResizeEvent);e.observe(this.scrollGroup),this.observers.push({key:"scrollGroup",observer:e})}})},immediate:!0},msgType(){this.getMsgs({dialog_id:this.dialogId,msg_id:this.msgId,msg_type:this.msgType,clear_before:!0}).catch(t=>{})},searchKey(t){!t||(this.searchLoad++,setTimeout(i=>{this.searchKey===t&&(this.searchLoad++,this.searchResult=[],this.searchLocation=0,this.$store.dispatch("call",{url:"dialog/msg/search",data:{dialog_id:this.dialogId,key:t}}).then(({data:e})=>{this.searchKey===t&&(this.searchResult=e.data,this.searchLocation=this.searchResult.length)}).finally(e=>{this.searchLoad--})),this.searchLoad--},600))},searchLocation(t){if(t===0)return;const i=this.searchResult[t-1];i&&this.onPositionId(i)},dialogSearchMsgId(){this.onSearchMsgId()},dialogMsgTransfer:{handler({time:t,msgFile:i,msgRecord:e,msgText:s,dialogId:a}){t>$A.Time()&&a==this.dialogId&&(this.$store.state.dialogMsgTransfer.time=0,this.$nextTick(()=>{$A.isArray(i)&&i.length>0?this.sendFileMsg(i):$A.isJson(e)&&e.duration>0?this.sendRecord(e):s&&this.sendMsg(s)}))},immediate:!0},wsOpenNum(t){if(t<=1)return;const i=this.allMsgs[this.allMsgs.length-1];if($A(this.$refs.scroller.$el).find(`[data-id="${i.id}"]`).length===0){this.scrollToBottomRefresh=!0;return}this.errorId===this.dialogId?this.getDialogBase(this.dialogId):this.onReGetMsg()},allMsgList(t){if(JSON.stringify(t)==JSON.stringify(this.allMsgs))return;const i=this.allMsgs.length,e=i>0?this.allMsgs[i-1].id:0;if($A.isIos()&&t.length!==i&&this.$refs.scroller){const s=this.$refs.scroller.$el;s.style.visibility="hidden",this.allMsgs=t,this.$nextTick(a=>{s.style.visibility="visible"})}else this.allMsgs=t;this.stickToBottom||(this.msgNew+=t.filter(s=>s.id&&s.id>e&&s.userid!=this.userId&&!s.read_at).length)},"allMsgs.length"(){this.stickToBottom&&this.onToBottom()},windowScrollY(t){$A.isIos()&&!this.$slots.head&&(this.$refs.nav.style.marginTop=`${t}px`)},windowActive(t){if(t&&this.autoFocus){const i=$A.last(this.dialogIns);i&&i.uid===this._uid&&this.inputFocus()}},windowHeight(){this.androidKeyboardVisible=$A.isAndroid()&&$A.eeuiAppKeyboardStatus(),requestAnimationFrame(this.$refs.input.updateTools)},dialogDrag(t){t&&(this.operateVisible=!1)},msgActiveId(t){var i;if(t>0){this.msgActiveId=0;const e=(i=this.$refs.scroller.$el.querySelector(`[data-id="${t}"]`))==null?void 0:i.querySelector(".dialog-head");e&&($A.scrollIntoViewIfNeeded(e),e.classList.add("common-shake"),setTimeout(s=>e.classList.remove("common-shake"),800))}},footerPaddingBottom(t){this.$refs.footer.style.paddingBottom=`${t}px`,requestAnimationFrame(i=>{this.$refs.input.updateTools()})},readLoadNum(){this.positionShow=!0},operateVisible(t){t||document.getSelection().removeAllRanges()}},methods:{getDialogBase(t){!t||(this.msgNew=0,this.msgType="",this.unreadOne=0,this.scrollTail=0,this.scrollOffset=0,this.searchShow=!1,this.positionShow=!1,this.msgPrepared=!1,this.scrollToBottomRefresh=!1,this.replyMsgAutoMention=!1,this.allMsgs=this.allMsgList,this.errorId=0,this.getMsgs({dialog_id:t,msg_id:this.msgId,msg_type:this.msgType}).then(i=>{this.openId=t,this.msgPrepared=!0,setTimeout(e=>{this.onSearchMsgId(),this.positionShow=this.readTimeout===null},100)}).catch(i=>{this.errorId=t}),this.$store.dispatch("saveInDialog",{uid:this._uid,dialog_id:t}),this.autoFocus&&this.inputFocus(),this.getUserApproveStatus())},subMsgListener(t=!1){!$A.isSubElectron||(t?this.$store.dispatch("websocketMsgListener","DialogWrapper"):this.$store.dispatch("websocketMsgListener",{name:"DialogWrapper",callback:i=>{const{type:e,mode:s,data:a}=i;e==="dialog"&&s==="add"&&this.tempMsgs.push(a)}}))},sendMsg(t,i){let e,s="text",a="no",o=!1;if(typeof t=="string"&&t?e=t:(e=this.msgText,o=!0),i==="md"?(e=this.$refs.input.getText(),s="md"):i==="silence"&&(a="yes"),e==""){this.inputFocus();return}if(s==="text"&&(e=e.replace(/<\/span> <\/p>$/,"</span></p>").replace(/(<span\s+class="mention"(.*?)>.*?<\/span>.*?<\/span>.*?<\/span>)(\x20)?/,"$1 ")),this.dialogData.extra_quote_type==="update"){s==="text"&&(e=e.replace(new RegExp(`src=(["'])${$A.mainUrl()}`,"g"),"src=$1{{RemoteURL}}"));const r=this.quoteId;this.$store.dispatch("setLoad",{key:`msg-${r}`,delay:600}),this.cancelQuote(),this.onActive(),this.$store.dispatch("call",{url:"dialog/msg/sendtext",data:{dialog_id:this.dialogId,update_id:r,text:e,text_type:s,silence:a},method:"post",complete:n=>this.$store.dispatch("cancelLoad",`msg-${r}`)}).then(({data:n})=>{this.sendSuccess(n,0,!0),this.onPositionId(r)}).catch(({msg:n})=>{$A.modalError(n)})}else{const r=$A.stringLength(e.replace(/<img[^>]*?>/g,""))>5e3,n={id:this.getTempId(),dialog_id:this.dialogData.id,reply_id:this.quoteId,type:r?"loading":"text",userid:this.userId,msg:{type:s,text:r?"":e,reply_data:this.quoteData}};this.tempMsgs.push(n),this.msgType="",this.cancelQuote(),this.onActive(),this.$nextTick(this.onToBottom),this.$store.dispatch("call",{requestId:n.id,url:"dialog/msg/sendtext",data:{dialog_id:n.dialog_id,reply_id:n.reply_id,text:e,text_type:s,silence:a},method:"post"}).then(({data:l})=>{this.sendSuccess(l,n.id)}).catch(l=>{this.$set(n,"error",!0),this.$set(n,"errorData",{type:"text",mType:i,content:l.msg,msg:e})})}o&&requestAnimationFrame(r=>this.msgText="")},sendRecord(t){const i={id:this.getTempId(),dialog_id:this.dialogData.id,reply_id:this.quoteId,type:"record",userid:this.userId,msg:Object.assign(t,{reply_data:this.quoteData})};this.tempMsgs.push(i),this.msgType="",this.cancelQuote(),this.onActive(),this.$nextTick(this.onToBottom),this.$store.dispatch("call",{requestId:i.id,url:"dialog/msg/sendrecord",data:Object.assign(t,{dialog_id:this.dialogId,reply_id:this.quoteId}),method:"post"}).then(({data:e})=>{this.sendSuccess(e,i.id)}).catch(e=>{this.$set(i,"error",!0),this.$set(i,"errorData",{type:"record",mType:"record",content:e.msg,msg:t})})},sendFileMsg(t){const i=$A.isArray(t)?t:[t];i.length>0&&(this.pasteFile=[],this.pasteItem=[],i.some(e=>{const s={type:$A.getMiddle(e.type,null,"/"),name:e.name,size:e.size,result:null};if(s.type==="image"){const a=new FileReader;a.readAsDataURL(e),a.onload=({target:o})=>{s.result=o.result,this.pasteFile.push(e),this.pasteItem.push(s),this.pasteShow=!0}}else this.pasteFile.push(e),this.pasteItem.push(s),this.pasteShow=!0}))},sendQuick(t){this.sendMsg(`<p><span data-quick-key="${t.key}">${t.label}</span></p>`)},onMsgChange(t){const i=this.allMsgs.find(({type:e,id:s})=>e=="text"&&s==t.id);i&&(typeof this.msgChangeCache[t.id]=="undefined"&&(this.msgChangeCache[t.id]=[],this.msgChangeCache[`${t.id}_load`]=!1),t.type==="append"?this.msgChangeCache[t.id].push(...`${t.text}`.split("").map(e=>({type:"append",text:e}))):t.type==="replace"&&(this.msgChangeCache[t.id]=[{type:"replace",text:t.text}]),this.onMsgOutput(t.id,i.msg))},onMsgOutput(t,i){const e=`${t}_load`,s=this.msgChangeCache[t];if(!(!s||s.length===0)&&this.msgChangeCache[e]!==!0){this.msgChangeCache[e]=!0;try{const a=s.shift();if(!a){this.msgChangeCache[e]=!1;return}const{type:o,text:r}=a,{tail:n}=this.scrollInfo();o==="append"?i.text+=r:o==="replace"&&(i.text=r),this.$nextTick(l=>{if(n<=10&&n!=this.scrollInfo().tail&&(this.operatePreventScroll++,this.$refs.scroller.scrollToBottom(),setTimeout(d=>this.operatePreventScroll--,50)),s.length===0){this.msgChangeCache[e]=!1;return}setTimeout(d=>{this.msgChangeCache[e]=!1,this.onMsgOutput(t,i)},5)})}catch{this.msgChangeCache[e]=!1}}},onSelectionchange(){const t=window.getSelection().type;this.selectedTextStatus=t==="Range"},getTempId(){return this.tempId++},getMsgs(t){return new Promise((i,e)=>{setTimeout(s=>this.msgLoadIng++,2e3),this.$store.dispatch("getDialogMsgs",t).then(i).catch(e).finally(s=>{this.msgLoadIng--})})},msgFilter(t){if(this.msgType){if(this.msgType==="tag"){if(!t.tag)return!1}else if(this.msgType==="todo"){if(!t.todo)return!1}else if(this.msgType==="link"){if(!t.link)return!1}else if(this.msgType!==t.mtype)return!1}return!(this.msgId&&t.reply_id!=this.msgId)},onSearchMsgId(){this.dialogSearchMsgId>0&&this.openId===this.dialogId&&(this.onPositionId(this.dialogSearchMsgId),this.$store.state.dialogSearchMsgId=0)},onPositionId(t,i=0,e=0){return new Promise((s,a)=>{if(t===0){$A.modalError("\u67E5\u770B\u5931\u8D25\uFF1A\u53C2\u6570\u9519\u8BEF"),a();return}if(this.loadMsg||this.msgType!==""){if(this.msgType="",e===0)this.$store.dispatch("showSpinner",600);else if(e>20){this.$store.dispatch("hiddenSpinner"),$A.modalError("\u67E5\u770B\u5931\u8D25\uFF1A\u8BF7\u6C42\u8D85\u65F6"),a();return}e++,setTimeout(n=>{this.onPositionId(t,i,e).then(s).catch(a)},Math.min(800,200*e));return}e>0&&this.$store.dispatch("hiddenSpinner");const o=this.allMsgs.findIndex(n=>n.id===t),r=this.prevId>0?0:-1;o>r?setTimeout(n=>{this.onToIndex(o,t),s()},200):(i>0&&this.$store.dispatch("setLoad",{key:`msg-${i}`,delay:600}),this.getMsgs({dialog_id:this.dialogId,msg_id:this.msgId,msg_type:this.msgType,position_id:t,spinner:2e3,save_before:n=>{this.preventToBottom=!0},save_after:n=>{this.$nextTick(l=>{this.preventToBottom=!1})}}).finally(n=>{const l=this.allMsgs.findIndex(d=>d.id===t);l>-1&&(this.onToIndex(l,t),s()),i>0&&this.$store.dispatch("cancelLoad",`msg-${i}`)}))})},onViewTodo(t){if(this.operateVisible)return;this.todoViewId=t.id,this.todoViewMid=t.msg_id,this.todoViewShow=!0,this.allMsgs.findIndex(e=>e.id===this.todoViewMid)===-1&&this.$store.dispatch("call",{url:"dialog/msg/one",data:{msg_id:this.todoViewMid}}).then(({data:e})=>{this.todoViewData=e})},onCloseTodo(){this.todoViewLoad=!1,this.todoViewShow=!1,this.todoViewData={},this.todoViewMid=0,this.todoViewId=0},onPosTodo(){!this.todoViewMid||(this.todoViewPosLoad=!0,this.onPositionId(this.todoViewMid).then(this.onCloseTodo).finally(t=>{this.todoViewPosLoad=!1}))},onDoneTodo(){!this.todoViewId||this.todoViewLoad||(this.todoViewLoad=!0,this.$store.dispatch("call",{url:"dialog/msg/done",data:{id:this.todoViewId}}).then(({data:t})=>{this.$store.dispatch("saveDialogTodo",{id:this.todoViewId,done_at:$A.formatDate("Y-m-d H:i:s")}),this.$store.dispatch("saveDialog",{id:this.dialogId,todo_num:this.todoList.length}),t.add&&this.sendSuccess(t.add),this.todoList.length===0&&this.$store.dispatch("getDialogTodo",this.dialogId),this.onCloseTodo()}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.todoViewLoad=!1}))},inputFocus(){this.$nextTick(t=>{this.$refs.input&&this.$refs.input.focus()})},onRecordState(t){this.recordState=t},chatPasteDrag(t,i){if(this.dialogDrag=!1,$A.dataHasFolder(i==="drag"?t.dataTransfer:t.clipboardData)){t.preventDefault(),$A.modalWarning(`\u6682\u4E0D\u652F\u6301${i==="drag"?"\u62D6\u62FD":"\u7C98\u8D34"}\u6587\u4EF6\u5939\u3002`);return}const e=i==="drag"?t.dataTransfer.files:t.clipboardData.files,s=Array.prototype.slice.call(e);s.length>0&&(t.preventDefault(),this.sendFileMsg(s))},chatDragOver(t,i){let e=this.__dialog_drag=$A.randomString(8);if(!t)setTimeout(()=>{e===this.__dialog_drag&&(this.dialogDrag=t)},150);else{if(i.dataTransfer.effectAllowed==="move"||Array.prototype.slice.call(i.dataTransfer.files).length===0)return;this.dialogDrag=!0}},onTouchStart(t){if($A.isAndroid()&&$A.eeuiAppKeyboardStatus()&&$A.eeuiAppSetDisabledUserLongClickSelect(500),this.wrapperStart=null,this.selectedTextStatus){this.wrapperStart=window.scrollY;return}if(this.$refs.scroller.$el.contains(t.target))this.wrapperStart=Object.assign(this.scrollInfo(),{clientY:t.touches[0].clientY});else if(this.$refs.input.$refs.editor.contains(t.target)){const i=this.$refs.input.$refs.editor.querySelector(".ql-editor");if(i){const e=i.clientHeight,s=i.scrollTop,a=i.scrollHeight;this.wrapperStart={offset:s,scale:s/(a-e),tail:a-e-s,clientY:t.touches[0].clientY}}}},onTouchMove(t){if(this.footerPaddingBottom>0||this.windowPortrait&&this.windowScrollY>0){if(typeof this.wrapperStart=="number")return;if(this.wrapperStart===null){t.preventDefault();return}this.wrapperStart.clientY>t.touches[0].clientY?this.wrapperStart.tail===0&&t.preventDefault():this.wrapperStart.offset===0&&t.preventDefault()}},onTouchEnd(){typeof this.wrapperStart=="number"&&$A.isIos()&&$A.scrollToView(this.$refs.footer,!1)},pasteSend(){this.__paste_send_index||(this.__paste_send_index=1,setTimeout(()=>{this.__paste_send_index=0},300),this.pasteFile.some(t=>{this.$refs.chatUpload.upload(t)}))},chatFile(t,i){switch(t){case"progress":const e=i.showProgress?Math.max(i.percentage,.01):!1,s=this.tempMsgs.find(({id:o})=>o==i.tempId);if(s){s.msg.percentage=e;return}const a={id:i.tempId,file_uid:i.uid,dialog_id:this.dialogData.id,reply_id:this.quoteId,type:"file",userid:this.userId,msg:Object.assign(i.msg||{},{percentage:e})};this.tempMsgs.push(a),this.msgType="",this.cancelQuote(),this.onActive(),this.$nextTick(this.onToBottom);break;case"error":this.forgetTempMsg(i.tempId);break;case"success":this.sendSuccess(i.data,i.tempId);break}},sendSuccess(t,i=0,e=!1){if($A.isArray(t)){t.some(s=>{this.sendSuccess(s,i)});return}if(i>0){const s=this.tempMsgs.findIndex(({id:a})=>a==i);s>-1&&this.tempMsgs.splice(s,1,t),setTimeout(a=>{this.forgetTempMsg(i),this.forgetTempMsg(t.id)},1e3)}this.$store.dispatch("saveDialog",{id:this.dialogId,hide:0}),this.$store.dispatch("saveDialogMsg",t),e||(this.$store.dispatch("increaseTaskMsgNum",t),this.$store.dispatch("increaseMsgReplyNum",t),this.$store.dispatch("updateDialogLastMsg",t)),this.cancelQuote(),this.onActive()},forgetTempMsg(t){this.tempMsgs=this.tempMsgs.filter(({id:i})=>i!=t)},setQuote(t,i){var e;(e=this.$refs.input)==null||e.setQuote(t,i)},cancelQuote(){var t;(t=this.$refs.input)==null||t.cancelQuote()},onEventFocus(){this.focusTimer&&clearTimeout(this.focusTimer),this.focusLazy=!0,this.$emit("on-focus")},onEventBlur(){this.focusTimer=setTimeout(t=>this.focusLazy=!1,10),this.$emit("on-blur")},onEventMore(t){switch(t){case"image":case"file":this.$refs.chatUpload.handleClick();break;case"call":this.onCallTel();break;case"anon":this.onAnon();break}},onCallTel(){$A.modalConfirm({content:`\u662F\u5426\u62E8\u6253\u7535\u8BDD\u7ED9 ${this.dialogData.name}\uFF1F`,onOk:()=>{this.$store.dispatch("call",{url:"dialog/tel",data:{dialog_id:this.dialogId},spinner:600}).then(({data:t})=>{t.tel&&$A.eeuiAppSendMessage({action:"callTel",tel:t.tel}),t.add&&(this.$store.dispatch("saveDialogMsg",t.add),this.$store.dispatch("updateDialogLastMsg",t.add),this.onActive())}).catch(({msg:t})=>{$A.modalError(t)})}})},onAnon(){if(this.dialogData.type!=="user"||this.dialogData.bot){$A.modalWarning("\u533F\u540D\u6D88\u606F\u4EC5\u5141\u8BB8\u53D1\u9001\u7ED9\u4E2A\u4EBA");return}$A.modalInput({title:"\u53D1\u9001\u533F\u540D\u6D88\u606F",placeholder:"\u533F\u540D\u6D88\u606F\u5C06\u901A\u8FC7\u533F\u540D\u6D88\u606F\uFF08\u673A\u5668\u4EBA\uFF09\u53D1\u9001\u7ED9\u5BF9\u65B9\uFF0C\u4E0D\u4F1A\u8BB0\u5F55\u4F60\u7684\u4EFB\u4F55\u8EAB\u4EFD\u4FE1\u606F",inputProps:{type:"textarea",rows:3,autosize:{minRows:3,maxRows:6},maxlength:2e3},okText:"\u533F\u540D\u53D1\u9001",onOk:t=>t?new Promise((i,e)=>{this.$store.dispatch("call",{url:"dialog/msg/sendanon",data:{userid:this.dialogData.dialog_user.userid,text:t},method:"post"}).then(({msg:s})=>{i(s)}).catch(({msg:s})=>{e(s)})}):"\u8BF7\u8F93\u5165\u6D88\u606F\u5185\u5BB9"})},onResizeEvent(t){t.some(({target:i,contentRect:e})=>{i===this.$refs.msgs?this.onMsgsResize(e):i===this.scrollGroup&&this.onScrollGroupResize(e)})},onMsgsResize({height:t}){if(this.$refs.scroller.$el.style.height=`${t}px`,typeof this.__msgs_height!="undefined"){const i=this.__msgs_height-t;if(i!==0){const{offset:e,tail:s}=this.scrollInfo();s>0&&this.onToOffset(e+i)}}this.__msgs_height=t},onScrollGroupResize(){this.stickToBottom&&this.onToBottom()},onActive(){this.$emit("on-active")},onToBottom(){this.msgNew=0;const t=this.$refs.scroller;t&&(t.scrollToBottom(),requestAnimationFrame(i=>t.scrollToBottom()))},onToIndex(t,i){const e=this.$refs.scroller;if(e){e.stopToBottom();const s=e.$el.querySelector(`[data-id="${i}"]`);s!=null&&s.parentNode.parentNode.classList.contains("item-enter")||(e.scrollToIndex(t,-80),requestAnimationFrame(a=>e.scrollToIndex(t,-80)))}requestAnimationFrame(s=>this.msgActiveId=i)},onToOffset(t,i=!1){const e=this.$refs.scroller;if(e){const s=e.getOffset()>t;e.stopToBottom(),e.scrollToOffset(t),setTimeout(a=>{s||i?e.virtual.handleFront():e.virtual.handleBehind()},10)}},scrollInfo(){const t=this.$refs.scroller;return t?t.scrollInfo():{offset:0,scale:0,tail:0}},openProject(){!this.dialogData.group_info||(this.windowPortrait&&this.$store.dispatch("openDialog",0),this.goForward({name:"manage-project",params:{projectId:this.dialogData.group_info.id}}))},openTask(){!this.dialogData.group_info||(this.taskId>0&&this.$store.dispatch("openDialog",0),this.$store.dispatch("openTask",{id:this.dialogData.group_info.id,deleted_at:this.dialogData.group_info.deleted_at,archived_at:this.dialogData.group_info.archived_at}))},openOkr(){!this.dialogData.link_id||this.$store.dispatch("openOkr",this.dialogData.link_id)},onReGetMsg(){this.scrollToBottomRefresh=!1,this.getMsgs({dialog_id:this.dialogId,msg_id:this.msgId,msg_type:this.msgType}).catch(t=>{})},onPrevPage(){this.prevId!==0&&this.getMsgs({dialog_id:this.dialogId,msg_id:this.msgId,msg_type:this.msgType,prev_id:this.prevId,save_before:t=>this.scrollDisabled=!0,save_after:t=>this.scrollDisabled=!1}).then(({data:t})=>{const i=t.list.map(e=>e.id);this.$nextTick(()=>{const e=this.$refs.scroller,s=i.reduce((a,o)=>({size:(typeof a=="object"?a.size:e.getSize(a))+e.getSize(o)}));this.onToOffset(e.getOffset()+s.size,!0)})}).catch(()=>{})},onDialogMenu(t){var i;switch(t){case"searchMsg":this.searchShow=!0,this.$nextTick(s=>{this.$refs.searchInput.focus()});break;case"openCreate":const e=[this.userId];this.dialogData.dialog_user&&this.userId!=this.dialogData.dialog_user.userid&&e.push(this.dialogData.dialog_user.userid),$.Store.set("createGroup",e);break;case"modifyNormal":this.modifyData={dialog_id:this.dialogData.id,avatar:this.dialogData.avatar,name:this.dialogData.name},this.dialogData.type==="user"&&(this.modifyData=Object.assign(this.modifyData,{userid:this.dialogData.dialog_user.userid,avatar:(i=this.cacheUserBasic.find(s=>s.userid===this.dialogData.dialog_user.userid))==null?void 0:i.userimg,clear_day:0,webhook_url:"",system_name:""}),this.modifyLoad++,this.$store.dispatch("call",{url:"users/bot/info",data:{id:this.dialogData.dialog_user.userid}}).then(({data:s})=>{this.modifyData.clear_day=s.clear_day,this.modifyData.webhook_url=s.webhook_url,this.modifyData.system_name=s.system_name}).finally(()=>{this.modifyLoad--})),this.modifyShow=!0;break;case"modifyAdmin":this.modifyData={dialog_id:this.dialogData.id,avatar:this.dialogData.avatar,admin:1},this.modifyShow=!0;break;case"groupInfo":this.groupInfoShow=!0;break;case"transfer":this.groupTransferData={dialog_id:this.dialogId,userid:[],disabledChoice:[this.userId]},this.groupTransferShow=!0;break;case"transferConfirm":this.onTransferGroup();break;case"disband":this.onDisbandGroup();break;case"exit":this.onExitGroup();break;case"report":this.reportShow=!0;break}},onTransferGroup(){if(this.groupTransferData.userid.length===0){$A.messageError("\u8BF7\u9009\u62E9\u65B0\u7684\u7FA4\u4E3B");return}this.groupTransferLoad++,this.$store.dispatch("call",{url:"dialog/group/transfer",data:{dialog_id:this.dialogId,userid:this.groupTransferData.userid[0]}}).then(({data:t,msg:i})=>{$A.messageSuccess(i),this.$store.dispatch("saveDialog",t)}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.groupTransferLoad--,this.groupTransferShow=!1})},onDisbandGroup(){$A.modalConfirm({content:`\u4F60\u786E\u5B9A\u8981\u89E3\u6563\u3010${this.dialogData.name}\u3011\u7FA4\u7EC4\u5417\uFF1F`,loading:!0,okText:"\u89E3\u6563",onOk:()=>new Promise((t,i)=>{this.$store.dispatch("call",{url:"dialog/group/disband",data:{dialog_id:this.dialogId}}).then(({msg:e})=>{t(e),this.$store.dispatch("forgetDialog",this.dialogId),this.goForward({name:"manage-messenger"})}).catch(({msg:e})=>{i(e)})})})},onExitGroup(){$A.modalConfirm({content:"\u4F60\u786E\u5B9A\u8981\u9000\u51FA\u7FA4\u7EC4\u5417\uFF1F",loading:!0,onOk:()=>new Promise((t,i)=>{this.$store.dispatch("call",{url:"dialog/group/deluser",data:{dialog_id:this.dialogId}}).then(({msg:e})=>{t(e),this.$store.dispatch("forgetDialog",this.dialogId),this.goForward({name:"manage-messenger"})}).catch(({msg:e})=>{i(e)})})})},onModify(){this.modifyData.userid?(this.modifyLoad++,this.$store.dispatch("call",{url:"users/bot/edit",data:{id:this.modifyData.userid,avatar:this.modifyData.avatar,name:this.modifyData.name,clear_day:this.modifyData.clear_day,webhook_url:this.modifyData.webhook_url},method:"post"}).then(({data:t,msg:i})=>{$A.messageSuccess(i),this.$store.dispatch("saveUserBasic",{userid:this.modifyData.userid,nickname:t.name,userimg:t.avatar}),this.$store.dispatch("saveDialog",{id:this.modifyData.dialog_id,name:t.name}),this.modifyShow=!1,this.modifyData={}}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.modifyLoad--})):(this.modifyLoad++,this.$store.dispatch("call",{url:"dialog/group/edit",data:this.modifyData}).then(({data:t,msg:i})=>{$A.messageSuccess(i),this.$store.dispatch("saveDialog",t),this.modifyShow=!1,this.modifyData={}}).catch(({msg:t})=>{$A.modalError(t)}).finally(t=>{this.modifyLoad--}))},onForwardBefore(){return new Promise((t,i)=>{if(this.forwardData=this.$refs.forwardSelect.formatSelect(this.$refs.forwardSelect.selects),this.forwardData.length===0)$A.messageError("\u8BF7\u9009\u62E9\u8F6C\u53D1\u5BF9\u8BDD\u6216\u6210\u5458");else{if(this.forwardDialogId=0,this.forwardData.length===1){const{type:e,userid:s}=this.forwardData[0];e==="group"&&/^d:/.test(s)&&(this.forwardDialogId=parseInt(s.replace(/^d:/,"")))}this.forwardMessage="",this.forwardSource=!0,this.forwardhow=!0}i()})},onForwardAffirm(){const t=this.$refs.forwardSelect.selects;if(t.length===0){$A.messageError("\u8BF7\u9009\u62E9\u8F6C\u53D1\u5BF9\u8BDD\u6216\u6210\u5458");return}const i=t.filter(s=>$A.leftExists(s,"d:")).map(s=>s.replace("d:","")),e=t.filter(s=>!$A.leftExists(s,"d:"));this.forwardLoad++,this.$store.dispatch("call",{url:"dialog/msg/forward",data:{dialogids:i,userids:e,msg_id:this.operateItem.id,show_source:this.forwardSource?1:0,leave_message:this.forwardMessage}}).then(({data:s,msg:a})=>{this.$store.dispatch("saveDialogMsg",s.msgs),this.$store.dispatch("updateDialogLastMsg",s.msgs),$A.messageSuccess(a),this.$refs.forwardSelect.hide(),this.forwardhow=!1}).catch(({msg:s})=>{$A.modalError(s)}).finally(s=>{this.forwardLoad--})},onActivity(t){if(this.msgActivity===!1){t&&(this.msgActivity=1);return}t?this.msgActivity++:this.msgActivity--},onScroll(t){this.operatePreventScroll===0&&(this.operateVisible=!1);const{offset:i,tail:e}=this.scrollInfo();this.scrollOffset=i,this.scrollTail=e,e<=10&&(this.msgNew=0,this.scrollToBottomRefresh&&this.onReGetMsg()),this.scrollAction=t.target.scrollTop,this.scrollDirection=this.scrollTmp<=this.scrollAction?"down":"up",setTimeout(s=>this.scrollTmp=this.scrollAction,0),this.scrollIng++,setTimeout(s=>this.scrollIng--,100)},onRange(t){if(this.preventMoreLoad)return;const i=this.scrollDirection==="down"?"next_id":"prev_id";for(let e=t.start;e<=t.end;e++){if(!this.allMsgs[e])continue;const s=this.allMsgs[e][i];if(!s)continue;const a=this.allMsgs[e+(i==="next_id"?1:-1)];a&&a.id!=s&&(this.preventMoreLoad=!0,this.getMsgs({dialog_id:this.dialogId,msg_id:this.msgId,msg_type:this.msgType,[i]:s}).finally(o=>{this.preventMoreLoad=!1}))}},onBack(){if(!this.beforeBack)return this.handleBack();const t=this.beforeBack();t&&t.then?t.then(()=>{this.handleBack()}):this.handleBack()},handleBack(){const{name:t,params:i}=this.$store.state.routeHistoryLast;t===this.$route.name&&/^\d+$/.test(i.dialogId)?this.goForward({name:this.$route.name}):this.goBack()},onMsgType(t){switch(t){case"project":this.openProject();break;case"task":this.openTask();break;case"okr":this.openOkr();break;default:this.loadMsg?$A.messageWarning("\u6B63\u5728\u52A0\u8F7D\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5..."):this.msgType=t;break}},onMention(t){const i=this.cacheUserBasic.find(({userid:e})=>e==t.userid);i&&this.$refs.input.addMention({denotationChar:"@",id:i.userid,value:i.nickname})},onLongpress({event:t,el:i,msgData:e}){if(this.operateVisible=this.operateItem.id===e.id,this.operateItem=$A.isJson(e)?e:{},this.operateCopys=[],t.target.nodeName==="IMG"&&this.$Electron?this.operateCopys.push({type:"image",icon:"&#xe7cd;",label:"\u590D\u5236\u56FE\u7247",value:$A.thumbRestore(t.target.currentSrc)}):t.target.nodeName==="A"&&(t.target.classList.contains("mention")&&t.target.classList.contains("file")&&this.findOperateFile(this.operateItem.id,t.target.href),this.operateCopys.push({type:"link",icon:"&#xe7cb;",label:"\u590D\u5236\u94FE\u63A5",value:t.target.href})),e.type==="text"){t.target.nodeName==="IMG"&&this.operateCopys.push({type:"imagedown",icon:"&#xe7a8;",label:"\u4E0B\u8F7D\u56FE\u7247",value:$A.thumbRestore(t.target.currentSrc)});const s=this.getSelectedTextInElement(i);if(s.length>0&&this.operateCopys.push({type:"selected",icon:"&#xe7df;",label:"\u590D\u5236\u9009\u62E9",value:s}),e.msg.text.replace(/<[^>]+>/g,"").length>0){let a=this.operateCopys.length>0?"\u590D\u5236\u6587\u672C":"\u590D\u5236";s.length>0&&(a="\u590D\u5236\u5168\u90E8"),this.operateCopys.push({type:"text",icon:"&#xe77f;",label:a,value:""})}}this.$nextTick(()=>{const s=i.getBoundingClientRect(),a=this.$refs.scroller.$el.getBoundingClientRect();let o=s.top+this.windowScrollY,r=s.height;s.top<a.top&&(o=a.top,r-=a.top-s.top),s.bottom>a.bottom&&(r-=s.bottom-a.bottom),this.operateStyles={left:`${t.clientX}px`,top:`${o}px`,height:`${r}px`},this.operateClient={x:t.clientX,y:t.clientY},this.operateVisible=!0})},onOperate(t,i=null){this.operateVisible=!1,this.$nextTick(e=>{switch(t){case"cancel":this.onCancelSend();break;case"reply":this.onReply();break;case"update":this.onUpdate();break;case"voice2text":this.onVoice2text();break;case"copy":this.onCopy(i);break;case"forward":this.$refs.forwardSelect.onSelection();break;case"withdraw":this.onWithdraw();break;case"view":this.onViewFile();break;case"down":this.onDownFile();break;case"tag":this.onTag();break;case"newTask":let s=$A.formatMsgBasic(this.operateItem.msg.text);s=s.replace(/<img[^>]*?src=(["'])(.*?)(_thumb\.jpg)*\1[^>]*?>/g,'<img src="$2">'),s=s.replace(/<li\s+data-list="checked">/g,'<li class="tox-checklist--checked">'),s=s.replace(/<li\s+data-list="unchecked">/g,"<li>"),s=s.replace(/<ol[^>]*>([\s\S]*?)<\/ol>/g,'<ul class="tox-checklist">$1</ul>'),$.Store.set("addTask",{owner:[this.userId],content:s});break;case"todo":this.onTodo();break;case"pos":this.onPositionId(this.operateItem.id);break;case"emoji":i==="more"?Gt().then(this.onEmoji):this.onEmoji(i);break;case"top":this.onTopOperate();break}})},onCancelSend(){$A.modalConfirm({title:"\u53D6\u6D88\u53D1\u9001",content:"\u4F60\u786E\u5B9A\u8981\u53D6\u6D88\u53D1\u9001\u5417\uFF1F",loading:!0,onOk:()=>new Promise((t,i)=>{if(this.operateItem.created_at){i("\u6D88\u606F\u5DF2\u53D1\u9001\uFF0C\u4E0D\u53EF\u53D6\u6D88");return}this.operateItem.type==="file"?this.$refs.chatUpload.cancel(this.operateItem.file_uid)?(this.forgetTempMsg(this.operateItem.id),t()):i("\u53D6\u6D88\u53D1\u9001\u5931\u8D25"):this.$store.dispatch("callCancel",this.operateItem.id).then(()=>{this.forgetTempMsg(this.operateItem.id),t()}).catch(()=>{i("\u53D6\u6D88\u53D1\u9001\u5931\u8D25")})})})},onReply(t){this.replyMsgAutoMention=!0,this.setQuote(this.operateItem.id,t),this.inputFocus()},onUpdate(){const{type:t}=this.operateItem;if(this.onReply(t==="text"?"update":"reply"),t==="text"){let{text:i,type:e}=this.operateItem.msg;this.$refs.input.setPasteMode(!1),e==="md"?this.$refs.input.setText(i):(i.indexOf("mention")>-1&&(i=i.replace(/<a class="mention file" href="([^'"]*)"([^>]*)>~([^>]*)<\/a>/g,'<span class="mention" data-denotation-char="~" data-id="$1" data-value="$3">&#xFEFF;<span contenteditable="false"><span class="ql-mention-denotation-char">~</span>$3</span>&#xFEFF;</span>'),i=i.replace(/<span class="mention ([^'"]*)" data-id="(\d+)">([@#])([^>]*)<\/span>/g,'<span class="mention" data-denotation-char="$3" data-id="$2" data-value="$4">&#xFEFF;<span contenteditable="false"><span class="ql-mention-denotation-char">$3</span>$4</span>&#xFEFF;</span>')),i=i.replace(/<img[^>]*>/gi,s=>s.replace(/(width|height)="\d+"\s*/ig,"")),i=i.replace(/<p><\/p>/g,"<p><br/></p>"),this.msgText=$A.formatMsgBasic(i)),this.$nextTick(s=>this.$refs.input.setPasteMode(!0))}},onVoice2text(){if(!this.actionPermission(this.operateItem,"voice2text"))return;const{id:t}=this.operateItem;this.$store.dispatch("setLoad",`msg-${t}`),this.$store.dispatch("call",{url:"dialog/msg/voice2text",data:{msg_id:t}}).then(({data:i})=>{this.$store.dispatch("saveDialogMsg",i)}).catch(({msg:i})=>{$A.messageError(i)}).finally(i=>{this.$store.dispatch("cancelLoad",`msg-${t}`)})},onCopy(t){if(!$A.isJson(t))return;const{type:i,value:e}=t;switch(i){case"image":this.$Electron&&this.getBase64Image(e).then(a=>{this.$Electron.sendMessage("copyBase64Image",{base64:a})});break;case"imagedown":this.$Electron?this.$Electron.sendMessage("saveImageAt",{params:{},url:e}):this.$store.dispatch("downUrl",{url:e,token:!1});break;case"filepos":this.$store.dispatch("filePos",e);break;case"link":this.copyText(e);break;case"selected":this.copyText(e);break;case"text":const s=$A(this.$refs.scroller.$el).find(`[data-id="${this.operateItem.id}"]`).find(".dialog-content");if(s.length>0){const a=s[0].innerText.replace(/\n\n/g,`
`).replace(/(^\s*)|(\s*$)/g,"");this.copyText(a)}else $A.messageWarning("\u4E0D\u53EF\u590D\u5236\u7684\u5185\u5BB9");break}},onWithdraw(){$A.modalConfirm({content:"\u786E\u5B9A\u64A4\u56DE\u6B64\u4FE1\u606F\u5417\uFF1F",okText:"\u64A4\u56DE",loading:!0,onOk:()=>new Promise((t,i)=>{this.$store.dispatch("call",{url:"dialog/msg/withdraw",data:{msg_id:this.operateItem.id}}).then(()=>{t("\u6D88\u606F\u5DF2\u64A4\u56DE"),this.$store.dispatch("forgetDialogMsg",this.operateItem.id)}).catch(({msg:e})=>{i(e)})})})},onViewReply(t){this.operateVisible||this.onPositionId(t.reply_id,t.msg_id)},onViewText({target:t,clientX:i},e){if(this.operateVisible)return;let s=t;for(;s&&!s.classList.contains("dialog-scroller");){if(s.classList.contains("open-approve-details")){const a=s.getAttribute("data-id");window.innerWidth<426?this.goForward({name:"manage-approve-details",query:{id:s.getAttribute("data-id")}}):(this.approveDetailsShow=!0,this.$nextTick(()=>{this.approveDetails={id:a}}));return}s=s.parentElement}switch(t.nodeName){case"IMG":if(t.classList.contains("browse"))this.onViewPicture(t.currentSrc);else{const o=$A.getTextImagesInfo(e.outerHTML),r=o.findIndex(n=>n.src==t.currentSrc);this.$store.dispatch("previewImage",{index:r,list:o})}break;case"SPAN":t.classList.contains("mention")&&t.classList.contains("task")&&this.$store.dispatch("openTask",$A.runNum(t.getAttribute("data-id"))),t.classList.contains("mention")&&t.classList.contains("okr")&&this.$store.dispatch("openOkr",$A.runNum(t.getAttribute("data-id")));break;case"LI":const a=t.getAttribute("data-list");if(["checked","unchecked"].includes(a)){if(i-t.getBoundingClientRect().x>18)return;let o=e.parentElement;for(;o&&!o.classList.contains("dialog-scroller");){if(o.classList.contains("dialog-view")){const r=o.getAttribute("data-id");if((this.allMsgs.find(d=>d.id==r)||{}).userid!=this.userId)return;const l=[].indexOf.call(e.querySelectorAll(t.tagName),t);a==="checked"?t.setAttribute("data-list","unchecked"):t.setAttribute("data-list","checked"),this.$store.dispatch("setLoad",{key:`msg-${r}`,delay:600}),this.$store.dispatch("call",{url:"dialog/msg/checked",data:{dialog_id:this.dialogId,msg_id:r,index:l,checked:a==="checked"?0:1}}).then(({data:d})=>{this.$store.dispatch("saveDialogMsg",d)}).catch(({msg:d})=>{a==="checked"?t.setAttribute("data-list","checked"):t.setAttribute("data-list","unchecked"),$A.modalError(d)}).finally(d=>{this.$store.dispatch("cancelLoad",`msg-${r}`)});break}o=o.parentElement}}break}},onViewFile(t){if(this.operateVisible)return;$A.isJson(t)||(t=this.operateItem);const{msg:i}=t;if(i.ext==="mp4"){this.$store.dispatch("previewImage",{src:i.path,width:i.width,height:i.height});return}if(["jpg","jpeg","webp","gif","png"].includes(i.ext)){this.onViewPicture(i.path);return}const e=`/single/file/msg/${t.id}`;this.$Electron?this.$store.dispatch("openChildWindow",{name:`file-msg-${t.id}`,path:e,userAgent:"/hideenOfficeTitle/",force:!1,config:{title:`${i.name} (${$A.bytesToSize(i.size)})`,titleFixed:!0,parent:null,width:Math.min(window.screen.availWidth,1440),height:Math.min(window.screen.availHeight,900)},webPreferences:{nodeIntegrationInSubFrames:i.ext==="drawio"}}):this.$isEEUiApp?this.$store.dispatch("openAppChildPage",{pageType:"app",pageTitle:`${i.name} (${$A.bytesToSize(i.size)})`,url:"web.js",params:{titleFixed:!0,allowAccess:!0,url:$A.rightDelete(window.location.href,window.location.hash)+`#${e}`}}):window.open($A.mainUrl(e.substring(1)))},onViewPicture(t){const i=this.allMsgs.filter(a=>a.type==="file"?["jpg","jpeg","webp","gif","png"].includes(a.msg.ext):a.type==="text"?a.msg.text.match(/<img\s+class="browse"[^>]*?>/):!1),e=[];i.some(({type:a,msg:o})=>{a==="file"?e.push({src:o.path,width:o.width,height:o.height}):a==="text"&&e.push(...$A.getTextImagesInfo(o.text))});const s=e.findIndex(({src:a})=>a===t);s>-1?this.$store.dispatch("previewImage",{index:s,list:e}):this.$store.dispatch("previewImage",t)},onDownFile(t){this.operateVisible||($A.isJson(t)||(t=this.operateItem),$A.modalConfirm({title:"\u4E0B\u8F7D\u6587\u4EF6",content:`${t.msg.name} (${$A.bytesToSize(t.msg.size)})`,okText:"\u7ACB\u5373\u4E0B\u8F7D",onOk:()=>{this.$store.dispatch("downUrl",$A.apiUrl(`dialog/msg/download?msg_id=${t.id}`))}}))},onReplyList(t){this.operateVisible||(this.replyListId=t.msg_id,this.replyListShow=!0)},onError(t){if(t.error!==!0)return;const{type:i,mType:e,content:s,msg:a}=t.errorData,o={icon:"error",title:"\u53D1\u9001\u5931\u8D25",content:s,cancelText:"\u53D6\u6D88\u53D1\u9001",onCancel:r=>{this.forgetTempMsg(t.id)}};if(i==="text")o.okText="\u91CD\u65B0\u53D1\u9001",o.onOk=()=>{this.forgetTempMsg(t.id),this.sendMsg(a,e)};else if(i==="record")o.okText="\u91CD\u65B0\u53D1\u9001",o.onOk=()=>{this.forgetTempMsg(t.id),this.sendRecord(a)};else return;$A.modalConfirm(o)},onEmoji(t){$A.isJson(t)||(t={msg_id:this.operateItem.id,symbol:t});const i=this.cacheEmojis.filter(e=>e!==t.symbol);i.unshift(t.symbol),$A.IDBSave("cacheEmojis",this.$store.state.cacheEmojis=i.slice(0,3)),this.$store.dispatch("setLoad",{key:`msg-${t.msg_id}`,delay:600}),this.$store.dispatch("call",{url:"dialog/msg/emoji",data:t}).then(({data:e})=>{this.dialogMsgs.findIndex(a=>a.id==e.id)>-1?this.$store.dispatch("saveDialogMsg",e):this.todoViewData.id===e.id&&(this.todoViewData=Object.assign(this.todoViewData,e))}).catch(({msg:e})=>{$A.messageError(e)}).finally(e=>{this.$store.dispatch("cancelLoad",`msg-${t.msg_id}`)})},onShowEmojiUser(t){this.operateVisible||(this.respondData=t,this.respondShow=!0)},onOther({event:t,data:i}){this.operateVisible||t==="todoAdd"&&(this.todoSpecifyData=Object.assign(this.todoSpecifyData,i),this.todoSpecifyShow=!0,this.$nextTick(e=>{this.$refs.todoSpecifySelect.onSelection()}))},onTag(){if(this.operateVisible)return;const t={msg_id:this.operateItem.id};this.$store.dispatch("setLoad",{key:`msg-${t.msg_id}`,delay:600}),this.$store.dispatch("call",{url:"dialog/msg/tag",data:t}).then(({data:i})=>{this.tagOrTodoSuccess(i)}).catch(({msg:i})=>{$A.messageError(i)}).finally(i=>{this.$store.dispatch("cancelLoad",`msg-${t.msg_id}`)})},onTypeChange(t){t==="user"&&(this.todoSettingData.userids.length===0&&this.todoSettingData.quick_value.length>0&&(this.todoSettingData.userids=this.todoSettingData.quick_value),this.$nextTick(i=>{this.$refs.userSelect.onSelection()})),t!=="quick_select"&&(this.todoSettingData.quick_value=[])},onQuickChange(t){this.todoSettingData.type=t.length===0?"all":"quick_select"},onTodo(t){var i;if(!this.operateVisible)if(t==="submit"){const e=$A.cloneJSON(this.todoSettingData);if(e.type==="quick_select")e.type="user",e.userids=e.quick_value;else if(e.type==="user"&&$A.arrayLength(e.userids)===0){$A.messageWarning("\u9009\u62E9\u6307\u5B9A\u6210\u5458");return}this.todoSettingLoad++,this.onTodoSubmit(e).then(s=>{$A.messageSuccess(s),this.todoSettingShow=!1}).catch(s=>{$A.messageError(s)}).finally(s=>{this.todoSettingLoad--})}else if(this.operateItem.todo)$A.modalConfirm({content:"\u4F60\u786E\u5B9A\u53D6\u6D88\u5F85\u529E\u5417\uFF1F",cancelText:"\u53D6\u6D88",okText:"\u786E\u5B9A",loading:!0,onOk:()=>this.onTodoSubmit({type:"user",userids:[],msg_id:this.operateItem.id})});else{const e={};e[this.userId]=this.userId;const s=(i=this.dialogData.dialog_user)==null?void 0:i.userid;if(s&&s!=this.userId&&!this.dialogData.bot&&(e[s]=s),this.operateItem.type==="text"){const a=/<span class="mention user" data-id="(\d+)">([^<]+)<\/span>/g,o=this.operateItem.msg.text.match(a);o&&o.forEach(r=>{const n=parseInt(r.replace(a,"$1"));n&&n!=this.userId&&(e[n]=n)})}this.todoSettingData={type:"all",userids:[],msg_id:this.operateItem.id,quick_value:[],quick_list:Object.values(e)},this.todoSettingShow=!0}},onTodoSpecify(){return new Promise((t,i)=>{this.onTodoSubmit(this.todoSpecifyData).then(e=>{$A.messageSuccess(e),t()}).catch(e=>{$A.messageError(e),i()})})},onTodoSubmit(t){return new Promise((i,e)=>{this.$store.dispatch("setLoad",{key:`msg-${t.msg_id}`,delay:600}),this.$store.dispatch("call",{method:"post",url:"dialog/msg/todo",data:t}).then(({data:s,msg:a})=>{i(a),this.tagOrTodoSuccess(s),this.onActive()}).catch(({msg:s})=>{e(s)}).finally(s=>{this.$store.dispatch("cancelLoad",`msg-${t.msg_id}`)})})},tagOrTodoSuccess(t){this.$store.dispatch("saveDialogMsg",t.update),t.add&&(this.$store.dispatch("saveDialogMsg",t.add),this.$store.dispatch("updateDialogLastMsg",t.add))},onSearchSwitch(t){if(this.searchResult.length!==0){if(this.searchLocation===1&&this.searchResult.length===1){this.onPositionId(this.searchResult[0]);return}t==="prev"?this.searchLocation<=1?this.searchLocation=this.searchResult.length:this.searchLocation--:this.searchLocation>=this.searchResult.length?this.searchLocation=1:this.searchLocation++}},onSearchKeyup(t){(t===null||t.keyCode===27)&&(this.searchShow=!1,this.searchKey="",this.searchResult=[])},onPositionMark(t){this.positionLoad>0||(this.positionLoad++,this.onPositionId(t).finally(i=>{this.positionLoad--}))},actionPermission(t,i){if(i==="forward"){if(["word-chain","vote"].includes(t.type))return!1;if(t.type==="text")return typeof t.msg.approve_type=="undefined"}else{if(i==="newTask")return t.type==="text"?typeof t.msg.approve_type=="undefined":!1;if(i==="voice2text"&&(t.type!=="record"||t.msg.text||this.isLoad(`msg-${t.id}`)))return!1}return!0},findOperateFile(t,i){const e=this.fileLinks.find(s=>s.link===i);if(e){this.addFileMenu(t,e);return}this.$store.dispatch("searchFiles",{link:i}).then(({data:s})=>{if(s.length===1){const a={link:i,id:s[0].id,pid:s[0].pid};this.fileLinks.push(a),this.addFileMenu(t,a)}}).catch(s=>{})},addFileMenu(t,i){if(this.operateItem.id!=t||this.operateCopys.findIndex(s=>s.type==="filepos")!==-1)return;const e=Math.max(0,this.operateCopys.findIndex(s=>s.type==="link")-1);this.operateCopys.splice(e,0,{type:"filepos",icon:"&#xe6f3;",label:"\u663E\u793A\u6587\u4EF6",value:{folderId:i.pid,fileId:null,shakeId:i.id}})},getBase64Image(t){return new Promise(i=>{let e=document.createElement("CANVAS"),s=e.getContext("2d"),a=new Image;a.crossOrigin="Anonymous",a.onload=()=>{e.height=a.height,e.width=a.width,s.drawImage(a,0,0);let o="png";$A.rightExists(t,"jpg")||$A.rightExists(t,"jpeg")?o="jpeg":$A.rightExists(t,"webp")?o="webp":$A.rightExists(t,"git")&&(o="git"),i(e.toDataURL(`image/${o}`)),e=null},a.src=t})},getSelectedTextInElement(t){let i="";if(window.getSelection){let e=window.getSelection();if(e.rangeCount>0){const s=e.getRangeAt(0);t.contains(s.commonAncestorContainer)&&(i=s.toString())}}return i},onViewAvatar(t){let i=null;t.target.tagName==="IMG"?i=t.target.src:i=$A(t.target).find("img").attr("src"),i&&this.$store.dispatch("previewImage",i)},onTopOperate(){this.operateVisible||(this.operateItem.top_at?this.onCancelTop(this.operateItem):this.onTopSubmit(this.operateItem))},onTopSubmit(t){return new Promise((i,e)=>{this.$store.dispatch("setLoad",{key:`msg-${t.msg_id}`,delay:600}),this.$store.dispatch("call",{url:"dialog/msg/top",data:{msg_id:t.id}}).then(({data:s,msg:a})=>{var o,r,n;if(i(a),this.$store.dispatch("saveDialog",{id:this.dialogId,top_msg_id:((o=s.update)==null?void 0:o.top_msg_id)||0,top_userid:((r=s.update)==null?void 0:r.top_userid)||0}),(n=s.update)!=null&&n.top_msg_id){const l=this.dialogMsgs.findIndex(({id:d})=>d==s.update.top_msg_id);l>-1&&this.$store.dispatch("saveDialogMsgTop",Object.assign({},this.dialogMsgs[l]))}s.add&&(this.$store.dispatch("saveDialogMsg",s.add),this.$store.dispatch("updateDialogLastMsg",s.add),this.onActive())}).catch(({msg:s})=>{e(s)}).finally(s=>{this.$store.dispatch("cancelLoad",`msg-${t.msg_id}`)})})},onPosTop(){!this.topMsg||(this.topPosLoad++,this.onPositionId(this.topMsg.id).finally(t=>{this.topPosLoad--}))},onCancelTop(t){$A.modalConfirm({content:"\u4F60\u786E\u5B9A\u53D6\u6D88\u7F6E\u9876\u5417\uFF1F",cancelText:"\u53D6\u6D88",okText:"\u786E\u5B9A",loading:!0,onOk:()=>this.onTopSubmit(t)})},getUserApproveStatus(){this.approvaUserStatus="",!(this.dialogData.type!=="user"||this.dialogData.bot)&&this.$store.dispatch("call",{url:"approve/user/status",data:{userid:this.dialogData.dialog_user.userid}}).then(({data:t})=>{this.approvaUserStatus=t}).catch(({msg:t})=>{$A.messageError(t)})}}},O={};var De=u(Ce,we,ye,!1,ke,null,null,null);function ke(t){for(let i in O)this[i]=O[i]}var qe=function(){return De.exports}();export{ee as C,qe as D};
