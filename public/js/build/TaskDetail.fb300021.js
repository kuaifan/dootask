import{m as f}from"./vuex.cc7cb26e.js";import{P as k,T as g}from"./ProjectLog.3db4d7fc.js";import{n as l,U as _,T as v}from"./app.fe1cd649.js";import{C as w,D as b}from"./DialogWrapper.ab24beb1.js";import{l as D}from"./le5le-store.d4b5b622.js";import y from"./TEditor.c8f7ff92.js";var C=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("Modal",{staticClass:"task-exist-tips",attrs:{title:t.$L("\u8BA1\u5212\u65F6\u95F4\u51B2\u7A81\u63D0\u793A"),styles:{width:"90%",maxWidth:"550px"}},model:{value:t.show,callback:function(i){t.show=i},expression:"show"}},[e("List",{attrs:{split:!1,size:"small"}},t._l(t.tipsTask,function(i,a){return e("ListItem",{key:a},[e("div",{staticClass:"list-content"},[e("UserAvatar",{attrs:{userid:a,size:28,"show-icon":!0,"show-name":!0}}),t._l(i,function(o,n){return e("div",{key:n,staticClass:"list-task"},[e("div",{staticClass:"list-task-info"},[e("span",[t._v("["+t._s(o.project_name)+"] ")]),e("span",{attrs:{title:o.name}},[t._v(t._s(o.name))])]),e("div",{staticClass:"list-task-date"},[t._v(t._s(t.getCutTime(o)))])])})],2)])}),1),e("div",{attrs:{slot:"footer"},slot:"footer"},[e("Button",{attrs:{type:"default"},on:{click:function(i){t.show=!1}}},[t._v(t._s(t.$L("\u53D6\u6D88")))]),e("Button",{attrs:{type:"primary"},on:{click:t.onAdd}},[t._v(t._s(t.$L("\u5FFD\u7565\u5E76\u7EE7\u7EED")))])],1)],1)},T=[];const x={name:"TaskExistTips",props:{value:{type:Boolean,default:!1}},data(){return{isExist:!1,show:!1,tipsTask:[],loadIng:!1}},methods:{onAdd(){this.$emit("onAdd",{}),this.show=!1},getCutTime(t){let s=$A.dayjs(t.start_at),e=$A.dayjs(t.end_at),i="";return s.format("YYYY/MM/DD")==e.format("YYYY/MM/DD")?i=s.format("YYYY/MM/DD HH:mm")+" ~ "+e.format("HH:mm"):s.year()==e.year()?(i=s.format("YYYY/MM/DD HH:mm")+" ~ "+e.format("MM/DD HH:mm"),i=i.replace(/( 00:00| 23:59)/g,"")):(i=s.format("YYYY/MM/DD HH:mm")+e.format("YYYY/MM/DD HH:mm"),i=i.replace(/( 00:00| 23:59)/g,"")),i},isExistTask({userids:t,timerange:s,taskid:e}){return this.isExist=!1,new Promise(async i=>{if($A.isArray(s)&&(!s[0]||!s[1]))return i(this.isExist),!1;this.$store.dispatch("call",{url:"project/task/easylists",data:{userid:t,timerange:s,taskid:e},method:"get"}).then(({data:a})=>{if(a.data.length>0){this.show=!0;let o={};t.map(n=>{a.data.map(r=>{(r.task_user||[]).map(d=>d.owner?d.userid:0).indexOf(n)!==-1&&(o[n]||(o[n]=[]),o[n].push(r))})}),this.tipsTask=o,this.isExist=!0}i(this.isExist)})})}}},c={};var L=l(x,C,T,!1,A,null,null,null);function A(t){for(let s in c)this[s]=c[s]}var I=function(){return L.exports}(),M=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"task-editor",on:{click:t.onClickWrap,touchstart:t.onTouchstart}},[e("TEditor",{ref:"desc",attrs:{plugins:t.plugins,options:t.options,"option-full":t.optionFull,placeholder:t.placeholder,placeholderFull:t.placeholderFull,readOnly:t.windowTouch,readOnlyFull:!1,readOnlyImagePreview:!1,inline:""},on:{"on-blur":t.onBlur,"on-editor-init":t.onEditorInit,"on-transfer-change":t.onTransferChange},model:{value:t.content,callback:function(i){t.content=i},expression:"content"}}),e("div",{directives:[{name:"show",rawName:"v-show",value:t.operateVisible,expression:"operateVisible"}],staticClass:"task-editor-operate",style:t.operateStyles},[e("Dropdown",{attrs:{trigger:"custom",visible:t.operateVisible,transfer:""},on:{"on-clickoutside":function(i){t.operateVisible=!1}}},[e("div",{style:{userSelect:t.operateVisible?"none":"auto",height:t.operateStyles.height}}),e("DropdownMenu",{attrs:{slot:"list"},slot:"list"},[t.operateMenu.checked?e("DropdownItem",{nativeOn:{click:function(i){return t.onLiPreview.apply(null,arguments)}}},[t._v(t._s(t.$L(t.operateMenu.checked==="checked"?"\u6807\u8BB0\u672A\u9009":"\u6807\u8BB0\u5DF2\u9009")))]):t._e(),t.operateMenu.link?e("DropdownItem",{nativeOn:{click:function(i){return t.onLinkPreview.apply(null,arguments)}}},[t._v(t._s(t.$L("\u6253\u5F00\u94FE\u63A5")))]):t._e(),t.operateMenu.img?e("DropdownItem",{nativeOn:{click:function(i){return t.onImagePreview.apply(null,arguments)}}},[t._v(t._s(t.$L("\u67E5\u770B\u56FE\u7247")))]):t._e(),e("DropdownItem",{nativeOn:{click:function(i){return t.onEditing.apply(null,arguments)}}},[t._v(t._s(t.$L("\u7F16\u8F91\u63CF\u8FF0")))]),e("DropdownItem",{nativeOn:{click:function(i){return t.onHistory.apply(null,arguments)}}},[t._v(t._s(t.$L("\u5386\u53F2\u8BB0\u5F55")))])],1)],1)],1)],1)},S=[];const F={name:"TEditorTask",components:{TEditor:y},props:{value:{default:""},placeholder:{default:""},placeholderFull:{default:""}},data(){return{content:this.value,plugins:["advlist autolink lists checklist link image charmap print preview hr anchor pagebreak","searchreplace visualblocks visualchars code","insertdatetime media nonbreaking save table directionality","emoticons paste codesample","autoresize"],options:{statusbar:!1,menubar:!1,autoresize_bottom_margin:2,min_height:200,max_height:380,contextmenu:"checklist | bold italic underline forecolor backcolor | link | uploadImages imagePreview | history screenload",valid_elements:"a[href|title|target=_blank],em,strong/b,div[align],span[style],a,br,p,img[src|alt|witdh|height],pre[class],code,ol[class],ul[class],li[class]",extended_valid_elements:"a[href|title|target=_blank]",toolbar:!1},optionFull:{menubar:"file edit view",removed_menuitems:"preview,print",contextmenu:"checklist | bold italic underline forecolor backcolor | link | uploadImages imagePreview | screenload",valid_elements:"a[href|title|target=_blank],em,strong/b,div[align],span[style],a,br,p,img[src|alt|witdh|height],pre[class],code,ol[class],ul[class],li[class]",extended_valid_elements:"a[href|title|target=_blank]",toolbar:"uploadImages | checklist | bold italic underline | forecolor backcolor",mobile:{menubar:"file edit view"}},operateStyles:{},operateVisible:!1,operateHiddenTime:0,operateMenu:{target:null,checked:null,link:null,img:null},listener:null}},mounted(){var s;let t=this.$parent.$el.parentNode;for(;t;){if((s=t.classList)!=null&&s.contains(".ivu-modal-wrap")){this.listener=t,t.addEventListener("scroll",this.onTouchstart);break}t=t.parentNode}},beforeDestroy(){var t;(t=this.listener)==null||t.removeEventListener("scroll",this.onTouchstart)},computed:{editor(){return this.$refs.desc.editor}},watch:{value(t){this.content=t},content(t){this.$emit("input",t)},operateVisible(t){t||(this.operateHiddenTime=Date.now())}},methods:{getContent(){return this.$refs.desc.getContent()},updateContent(t){this.content=t},onEditing(){this.$refs.desc.onFull()},onHistory(){this.$emit("on-history")},onBlur(){this.$emit("on-blur")},onEditorInit(t){this.updateTouchContent(),this.updateHistoryContent(t),this.$emit("on-editor-init",t)},onTransferChange(t){t||!this.windowTouch||setTimeout(s=>{this.updateTouchContent(),this.onBlur()},100)},onClickWrap(t){!this.windowTouch||Date.now()-this.operateHiddenTime<300||(t.stopPropagation(),this.operateVisible=!1,this.operateMenu.target=t.target,this.operateMenu.checked=null,t.target.tagName==="LI"&&t.target.parentNode.classList.contains("tox-checklist")&&(this.operateMenu.checked=t.target.classList.contains("tox-checklist--checked")?"checked":"unchecked"),this.operateMenu.link=t.target.tagName==="A"?t.target.href:null,this.operateMenu.img=t.target.tagName==="IMG"?t.target.src:null,this.$nextTick(()=>{const s=this.$el.getBoundingClientRect();this.operateStyles={left:`${t.clientX-s.left}px`,top:`${t.clientY-s.top}px`},this.operateVisible=!0}))},onTouchstart(){!this.windowTouch||(this.operateVisible=!1)},updateTouchContent(){!this.windowTouch||this.$nextTick(t=>{!this.editor||(this.content?(this.editor.bodyElement.removeAttribute("data-mce-placeholder"),this.editor.bodyElement.removeAttribute("aria-placeholder")):(this.editor.bodyElement.setAttribute("data-mce-placeholder",this.placeholder),this.editor.bodyElement.setAttribute("aria-placeholder",this.placeholder)),this.updateTouchLink(0))})},updateTouchLink(t){!this.windowTouch||setTimeout(s=>{!this.editor||(this.editor.bodyElement.querySelectorAll("a").forEach(e=>{e.__dataMceClick!==!0&&(e.__dataMceClick=!0,e.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),this.onClickWrap(i)}))}),t<300&&this.updateTouchLink(t+100))},t)},updateHistoryContent(t){t.ui.registry.addMenuItem("history",{icon:"insert-time",text:this.$L("\u5386\u53F2\u8BB0\u5F55"),onAction:()=>{this.onHistory()}})},onLiPreview(){!this.operateMenu.checked||(this.operateMenu.checked==="checked"?this.operateMenu.target.classList.remove("tox-checklist--checked"):this.operateMenu.target.classList.add("tox-checklist--checked"),this.$emit("on-blur","force"))},onLinkPreview(){this.operateMenu.link&&window.open(this.operateMenu.link)},onImagePreview(){const t=this.$refs.desc.getValueImages();if(t.length===0){$A.messageWarning("\u6CA1\u6709\u53EF\u9884\u89C8\u7684\u56FE\u7247");return}let s=Math.max(0,t.findIndex(e=>e.src===this.operateMenu.img));this.$store.dispatch("previewImage",{index:s,list:t})}}},h={};var E=l(F,M,S,!1,O,"151827a2",null,null);function O(t){for(let s in h)this[s]=h[s]}var H=function(){return E.exports}(),j=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("Upload",{ref:"upload",attrs:{name:"files",action:"",multiple:"",format:t.uploadFormat,"show-upload-list":!1,"max-size":t.maxSize,"on-format-error":t.handleFormatError,"on-exceeded-size":t.handleMaxSize,"before-upload":t.handleBeforeUpload}})},Y=[];const P={name:"TaskUpload",props:{maxSize:{type:Number,default:1024e3}},data(){return{uploadFormat:["jpg","jpeg","webp","png","gif","doc","docx","xls","xlsx","ppt","pptx","txt","esp","pdf","rar","zip","gz","ai","avi","bmp","cdr","eps","mov","mp3","mp4","pr","psd","svg","tif"]}},methods:{handleFormatError(t){$A.modalWarning({title:"\u6587\u4EF6\u683C\u5F0F\u4E0D\u6B63\u786E",content:"\u6587\u4EF6 "+t.name+" \u683C\u5F0F\u4E0D\u6B63\u786E\uFF0C\u4EC5\u652F\u6301\u53D1\u9001\uFF1A"+this.uploadFormat.join(",")})},handleMaxSize(t){$A.modalWarning({title:"\u8D85\u51FA\u6587\u4EF6\u5927\u5C0F\u9650\u5236",content:"\u6587\u4EF6 "+t.name+" \u592A\u5927\uFF0C\u4E0D\u80FD\u53D1\u9001\u8D85\u8FC7"+$A.bytesToSize(this.maxSize*1024)+"\u3002"})},handleBeforeUpload(t){return this.$emit("on-select-file",t),!1},handleClick(){this.$refs.upload.handleClick()}}},u={};var z=l(P,j,Y,!1,N,null,null,null);function N(t){for(let s in u)this[s]=u[s]}var U=function(){return z.exports}(),R=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"task-content-history"},[e("Table",{attrs:{"max-height":t.windowHeight-180,columns:t.columns,data:t.list,loading:t.loadIng>0,"no-data-text":t.$L(t.noText),"highlight-row":"",stripe:""}}),t.total>t.pageSize?e("Page",{attrs:{total:t.total,current:t.page,"page-size":t.pageSize,disabled:t.loadIng>0,simple:!0},on:{"on-change":t.setPage,"on-page-size-change":t.setPageSize}}):t._e()],1)},B=[];const V={name:"TaskContentHistory",props:{taskId:{type:Number,default:0},taskName:{type:String,default:""}},data(){return{loadIng:0,columns:[{title:this.$L("\u65E5\u671F"),key:"created_at",width:168},{title:this.$L("\u63CF\u8FF0"),key:"desc",ellipsis:!0,minWidth:150,render:(t,{row:s})=>t("span",s.desc||"-")},{title:this.$L("\u521B\u5EFA\u4EBA"),width:120,render:(t,{row:s})=>s.userid?t("UserAvatar",{props:{showName:!0,size:22,userid:s.userid}}):t("div","-")},{title:this.$L("\u64CD\u4F5C"),align:"center",width:100,render:(t,{index:s,row:e,column:i})=>s===0&&this.page===1?t("div","-"):t("TableAction",{props:{column:i,menu:[{label:this.$L("\u67E5\u770B"),action:"preview"}]},on:{action:a=>{this.onAction(a,e)}}})}],list:[],page:1,pageSize:10,total:0,noText:""}},mounted(){},watch:{taskId:{handler(t){t&&this.setPage(1)},immediate:!0}},methods:{getLists(){this.taskId!==0&&(this.loadIng++,this.$store.dispatch("call",{url:"project/task/content_history",data:{task_id:this.taskId,page:Math.max(this.page,1),pagesize:Math.max($A.runNum(this.pageSize),10)}}).then(({data:t})=>{this.page=t.current_page,this.total=t.total,this.list=t.data,this.noText="\u6CA1\u6709\u76F8\u5173\u7684\u6570\u636E"}).catch(()=>{this.noText="\u6570\u636E\u52A0\u8F7D\u5931\u8D25"}).finally(t=>{this.loadIng--}))},setPage(t){this.page=t,this.getLists()},setPageSize(t){this.page=1,this.pageSize=t,this.getLists()},onAction(t,s){switch(t){case"preview":const e=(this.taskName||`ID: ${this.taskId}`)+` [${s.created_at}]`,i=`/single/task/content/${this.taskId}?history_id=${s.id}&history_title=${e}`;this.$Electron?this.$store.dispatch("openChildWindow",{name:`task-content-${this.taskId}-${s.id}`,path:i,force:!1,config:{title:e,titleFixed:!0,parent:null,width:Math.min(window.screen.availWidth,1440),height:Math.min(window.screen.availHeight,900)}}):this.$isEEUiApp?this.$store.dispatch("openAppChildPage",{pageType:"app",pageTitle:e,url:"web.js",params:{titleFixed:!0,allowAccess:!0,url:$A.rightDelete(window.location.href,window.location.hash)+`#${i}`}}):window.open($A.mainUrl(i.substring(1)));break}}}},m={};var W=l(V,R,B,!1,K,"43d23896",null,null);function K(t){for(let s in m)this[s]=m[s]}var q=function(){return W.exports}(),J=function(){var t=this,s=t.$createElement,e=t._self._c||s;return t.ready&&t.taskDetail.parent_id>0?e("li",[e("div",{staticClass:"subtask-icon"},[e("TaskMenu",{ref:`taskMenu_${t.taskDetail.id}`,attrs:{disabled:t.taskId===0,task:t.taskDetail,"load-status":t.taskDetail.loading===!0},on:{"on-update":t.getLogLists}})],1),t.taskDetail.flow_item_name?e("div",{staticClass:"subtask-flow"},[e("span",{class:t.taskDetail.flow_item_status,on:{click:function(i){return i.stopPropagation(),t.openMenu(i,t.taskDetail)}}},[t._v(t._s(t.taskDetail.flow_item_name))])]):t._e(),e("div",{staticClass:"subtask-name"},[e("Input",{ref:"name",attrs:{type:"textarea",rows:1,autosize:{minRows:1,maxRows:8},maxlength:255,enterkeyhint:"done"},on:{"on-blur":function(i){return t.updateBlur("name")},"on-keydown":t.onNameKeydown},model:{value:t.taskDetail.name,callback:function(i){t.$set(t.taskDetail,"name",i)},expression:"taskDetail.name"}})],1),e("DatePicker",{staticClass:"subtask-time",attrs:{open:t.timeOpen,options:t.timeOptions,format:"yyyy/MM/dd HH:mm",type:"datetimerange",placement:"bottom-end",transfer:""},on:{"on-open-change":t.timeChange,"on-change":t.taskTimeChange,"on-clear":t.timeClear,"on-ok":t.timeOk},model:{value:t.timeValue,callback:function(i){t.timeValue=i},expression:"timeValue"}},[!t.taskDetail.complete_at&&t.taskDetail.end_at&&t.taskDetail.end_at!=t.mainEndAt?e("div",{class:["time",t.taskDetail.today?"today":"",t.taskDetail.overdue?"overdue":""],on:{click:t.openTime}},[t._v(" "+t._s(t.expiresFormat(t.taskDetail.end_at))+" ")]):e("Icon",{staticClass:"clock",attrs:{type:"ios-clock-outline"},on:{click:t.openTime}})],1),e("UserSelect",{staticClass:"subtask-avatar",attrs:{"multiple-max":10,"avatar-size":20,title:t.$L("\u4FEE\u6539\u8D1F\u8D23\u4EBA"),"add-icon":!1,"project-id":t.taskDetail.project_id,"before-submit":t.onOwner},model:{value:t.ownerData.owner_userid,callback:function(i){t.$set(t.ownerData,"owner_userid",i)},expression:"ownerData.owner_userid"}})],1):t.ready?e("div",{class:{"task-detail":!0,"open-dialog":t.hasOpenDialog,completed:t.taskDetail.complete_at},style:t.taskDetailStyle},[e("div",{directives:[{name:"show",rawName:"v-show",value:t.taskDetail.id>0,expression:"taskDetail.id > 0"}],staticClass:"task-info"},[e("div",{staticClass:"head"},[e("TaskMenu",{ref:`taskMenu_${t.taskDetail.id}`,staticClass:"icon",attrs:{disabled:t.taskId===0,task:t.taskDetail,size:"medium","color-show":!1},on:{"on-update":t.getLogLists}}),t.taskDetail.flow_item_name?e("div",{staticClass:"flow"},[e("span",{class:t.taskDetail.flow_item_status,on:{click:function(i){return i.stopPropagation(),t.openMenu(i,t.taskDetail)}}},[t._v(t._s(t.taskDetail.flow_item_name))])]):t._e(),t.taskDetail.archived_at?e("div",{staticClass:"flow"},[e("span",{staticClass:"archived",on:{click:function(i){return i.stopPropagation(),t.openMenu(i,t.taskDetail)}}},[t._v(t._s(t.$L("\u5DF2\u5F52\u6863")))])]):t._e(),e("div",{staticClass:"nav"},[t.projectName?e("p",[e("span",[t._v(t._s(t.projectName))])]):t._e(),t.columnName?e("p",[e("span",[t._v(t._s(t.columnName))])]):t._e(),t.taskDetail.id?e("p",[e("span",[t._v(t._s(t.taskDetail.id))])]):t._e()]),e("div",{staticClass:"function"},[t.getOwner.length===0?e("EPopover",{attrs:{placement:"bottom"},model:{value:t.receiveShow,callback:function(i){t.receiveShow=i},expression:"receiveShow"}},[e("div",{staticClass:"task-detail-receive"},[e("div",{staticClass:"receive-title"},[e("Icon",{attrs:{type:"ios-help-circle"}}),t._v(" "+t._s(t.$L("\u786E\u8BA4\u8BA1\u5212\u65F6\u95F4\u9886\u53D6\u4EFB\u52A1"))+" ")],1),e("div",{staticClass:"receive-time"},[e("DatePicker",{attrs:{options:t.timeOptions,format:"yyyy/MM/dd HH:mm",type:"datetimerange",placeholder:t.$L("\u8BF7\u8BBE\u7F6E\u8BA1\u5212\u65F6\u95F4"),clearable:!1,editable:!1},on:{"on-change":t.taskTimeChange},model:{value:t.timeValue,callback:function(i){t.timeValue=i},expression:"timeValue"}})],1),e("div",{staticClass:"receive-bottom"},[e("Button",{attrs:{size:"small",type:"text"},on:{click:function(i){t.receiveShow=!1}}},[t._v("\u53D6\u6D88")]),e("Button",{attrs:{loading:t.ownerLoad>0,size:"small",type:"primary"},on:{click:function(i){return t.onOwner(!0)}}},[t._v("\u786E\u5B9A")])],1)]),e("Button",{staticClass:"pick",attrs:{slot:"reference",loading:t.ownerLoad>0,type:"primary"},slot:"reference"},[t._v(t._s(t.$L("\u6211\u8981\u9886\u53D6\u4EFB\u52A1")))])],1):t._e(),t.$Electron?e("ETooltip",{attrs:{disabled:t.$isEEUiApp||t.windowTouch,content:t.$L("\u65B0\u7A97\u53E3\u6253\u5F00")}},[e("i",{staticClass:"taskfont open",on:{click:t.openNewWin}},[t._v("\uE776")])]):t._e(),e("div",{staticClass:"menu"},[e("TaskMenu",{attrs:{disabled:t.taskId===0,task:t.taskDetail,icon:"ios-more","completed-icon":"ios-more",size:"medium","color-show":!1},on:{"on-update":t.getLogLists}})],1)],1)],1),e("Scrollbar",{ref:"scroller",staticClass:"scroller"},[e("div",{staticClass:"title"},[e("Input",{ref:"name",attrs:{type:"textarea",rows:1,autosize:{minRows:1,maxRows:8},maxlength:255,enterkeyhint:"done"},on:{"on-blur":function(i){return t.updateBlur("name")},"on-keydown":t.onNameKeydown},model:{value:t.taskDetail.name,callback:function(i){t.$set(t.taskDetail,"name",i)},expression:"taskDetail.name"}})],1),e("TEditorTask",{ref:"desc",staticClass:"desc",attrs:{value:t.taskContent,placeholder:t.$L("\u8BE6\u7EC6\u63CF\u8FF0...")},on:{"on-history":t.onHistory,"on-blur":function(i){return t.updateBlur("content",i)}}}),e("Form",{staticClass:"items",attrs:{"label-position":"left","label-width":"auto"},nativeOn:{submit:function(i){i.preventDefault()}}},[t.taskDetail.p_name?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6EC")]),t._v(t._s(t.$L("\u4F18\u5148\u7EA7"))+" ")]),e("ul",{staticClass:"item-content"},[e("li",[e("EDropdown",{ref:"priority",attrs:{trigger:"click",placement:"bottom"},on:{command:function(i){return t.updateData("priority",i)}}},[e("TaskPriority",{attrs:{backgroundColor:t.taskDetail.p_color}},[t._v(t._s(t.taskDetail.p_name))]),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},t._l(t.taskPriority,function(i,a){return e("EDropdownItem",{key:a,attrs:{command:i}},[e("i",{staticClass:"taskfont",style:{color:i.color},domProps:{innerHTML:t._s(t.taskDetail.p_name==i.name?"&#xe61d;":"&#xe61c;")}}),t._v(" "+t._s(i.name)+" ")])}),1)],1)],1)])]):t._e(),t.getOwner.length>0?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6E4")]),t._v(t._s(t.$L("\u8D1F\u8D23\u4EBA"))+" ")]),e("UserSelect",{staticClass:"item-content user",attrs:{"multiple-max":10,"avatar-size":28,title:t.$L("\u4FEE\u6539\u8D1F\u8D23\u4EBA"),"project-id":t.taskDetail.project_id,"add-icon":!1,"before-submit":t.onOwner},model:{value:t.ownerData.owner_userid,callback:function(i){t.$set(t.ownerData,"owner_userid",i)},expression:"ownerData.owner_userid"}})],1):t._e(),t.getAssist.length>0||t.assistForce?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE63F")]),t._v(t._s(t.$L("\u534F\u52A9\u4EBA\u5458"))+" ")]),e("UserSelect",{ref:"assist",staticClass:"item-content user",attrs:{"multiple-max":10,"avatar-size":28,title:t.$L(t.getAssist.length>0?"\u4FEE\u6539\u534F\u52A9\u4EBA\u5458":"\u6DFB\u52A0\u534F\u52A9\u4EBA\u5458"),"project-id":t.taskDetail.project_id,"disabled-choice":t.assistData.disabled,"add-icon":!1,"before-submit":t.onAssist},model:{value:t.assistData.assist_userid,callback:function(i){t.$set(t.assistData,"assist_userid",i)},expression:"assistData.assist_userid"}})],1):t._e(),t.taskDetail.visibility>1||t.visibleForce||t.visibleKeep?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE77B")]),e("span",{staticClass:"visibility-text color",on:{click:t.showCisibleDropdown}},[t._v(t._s(t.$L("\u53EF\u89C1\u6027"))+" "),e("i",{staticClass:"taskfont"},[t._v("\uE740")])])]),e("div",{staticClass:"item-content user"},[t.taskDetail.visibility==1||t.taskDetail.visibility==2?e("span",{ref:"visibilityText",staticClass:"visibility-text",on:{click:t.showCisibleDropdown}},[t._v(t._s(t.taskDetail.visibility==1?t.$L("\u9879\u76EE\u4EBA\u5458\u53EF\u89C1"):t.$L("\u4EFB\u52A1\u4EBA\u5458\u53EF\u89C1")))]):e("UserSelect",{ref:"visibleUserSelectRef",attrs:{"avatar-size":28,title:t.$L("\u9009\u62E9\u6307\u5B9A\u4EBA\u5458"),"project-id":t.taskDetail.project_id,"add-icon":!1},on:{"on-show-change":t.visibleUserSelectShowChange},model:{value:t.taskDetail.visibility_appointor,callback:function(i){t.$set(t.taskDetail,"visibility_appointor",i)},expression:"taskDetail.visibility_appointor"}})],1)]):t._e(),t.taskDetail.end_at||t.timeForce?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6E8")]),t.taskDetail.end_at?e("span",{staticClass:"visibility-text color",on:{click:t.showAtDropdown}},[t._v(t._s(t.$L("\u622A\u6B62\u65F6\u95F4")))]):e("span",{staticClass:"visibility-text color",on:{click:function(i){t.timeOpen=!0}}},[t._v(t._s(t.$L("\u622A\u6B62\u65F6\u95F4")))])]),e("ul",{staticClass:"item-content"},[e("li",[e("DatePicker",{attrs:{disabled:"",open:t.timeOpen,options:t.timeOptions,format:"yyyy/MM/dd HH:mm",type:"datetimerange",transfer:""},on:{"on-open-change":t.timeChange,"on-change":t.taskTimeChange,"on-clear":t.timeClear,"on-ok":t.timeOk},model:{value:t.timeValue,callback:function(i){t.timeValue=i},expression:"timeValue"}},[e("div",{staticClass:"picker-time"},[t.taskDetail.end_at?e("div",{staticClass:"time",on:{click:t.showAtDropdown}},[t._v(t._s(t.taskDetail.end_at?t.cutTime:"--"))]):e("div",{staticClass:"time",on:{click:function(i){t.timeOpen=!0}}},[t._v(t._s(t.taskDetail.end_at?t.cutTime:"--"))]),!t.taskDetail.complete_at&&t.taskDetail.end_at?[t.within24Hours(t.taskDetail.end_at)?e("Tag",{attrs:{color:t.tagColor(t.taskDetail)}},[e("i",{staticClass:"taskfont"},[t._v("\uE71D")]),t._v(t._s(t.expiresFormat(t.taskDetail.end_at))+" ")]):t._e(),t.taskDetail.overdue?e("Tag",{attrs:{color:"red"}},[t._v(t._s(t.$L("\u8D85\u671F\u672A\u5B8C\u6210")))]):t._e()]:t._e()],2)])],1)])]):t._e(),t.taskDetail.loop&&t.taskDetail.loop!="never"||t.loopForce?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE93F")]),t._v(t._s(t.$L("\u91CD\u590D\u5468\u671F"))+" ")]),e("ul",{staticClass:"item-content"},[e("li",[e("EDropdown",{ref:"loop",attrs:{trigger:"click",placement:"bottom"},on:{command:function(i){return t.updateData("loop",i)}}},[e("ETooltip",{attrs:{disabled:t.$isEEUiApp||t.windowTouch||!t.taskDetail.loop_at,content:`${t.$L("\u4E0B\u4E2A\u5468\u671F")}: ${t.taskDetail.loop_at}`,placement:"right"}},[e("span",[t._v(t._s(t.$L(t.loopLabel(t.taskDetail.loop))))])]),e("EDropdownMenu",{staticClass:"task-detail-loop",attrs:{slot:"dropdown"},slot:"dropdown"},t._l(t.loops,function(i){return e("EDropdownItem",{key:i.key,attrs:{command:i.key}},[t._v(" "+t._s(t.$L(i.label))+" ")])}),1)],1)],1)])]):t._e(),t.fileList.length>0?e("FormItem",[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6E6")]),t._v(t._s(t.$L("\u9644\u4EF6"))+" ")]),e("ul",{staticClass:"item-content file"},[t.taskDetail.file_num>50?e("li",{staticClass:"tip"},[t._v(t._s(t.$L(`\u5171${t.taskDetail.file_num}\u4E2A\u6587\u4EF6\uFF0C\u4EC5\u663E\u793A\u6700\u65B050\u4E2A`)))]):t._e(),t._l(t.fileList,function(i){return e("li",{on:{click:function(a){return t.showFileDropdown(i,a)}}},[i.id?e("img",{staticClass:"file-ext",attrs:{src:i.thumb}}):e("Loading",{staticClass:"file-load"}),e("div",{staticClass:"file-name"},[t._v(t._s(i.name))]),e("div",{staticClass:"file-size"},[t._v(t._s(t.$A.bytesToSize(i.size)))])],1)})],2),e("ul",{staticClass:"item-content"},[e("li",[e("div",{staticClass:"add-button",on:{click:function(i){return t.onUploadClick(!0)}}},[e("i",{staticClass:"taskfont"},[t._v("\uE6F2")]),e("span",[t._v(t._s(t.$L("\u6DFB\u52A0\u9644\u4EF6")))])])])])]):t._e(),t.subList.length>0||t.addsubForce?e("FormItem",{attrs:{className:"item-subtask"}},[e("div",{staticClass:"item-label",attrs:{slot:"label"},slot:"label"},[e("i",{staticClass:"taskfont"},[t._v("\uE6F0")]),t._v(t._s(t.$L("\u5B50\u4EFB\u52A1"))+" ")]),e("ul",{staticClass:"item-content subtask"},t._l(t.subList,function(i,a){return e("TaskDetail",{key:a,ref:`subTask_${i.id}`,refInFor:!0,attrs:{"task-id":i.id,"open-task":i,"main-end-at":t.taskDetail.end_at,"can-update-blur":t.canUpdateBlur}})}),1),e("ul",{class:["item-content",t.subList.length===0?"nosub":""]},[e("li",[t.addsubShow?e("Input",{ref:"addsub",staticClass:"add-input",class:{loading:t.addsubLoad>0},attrs:{placeholder:t.$L("+ \u8F93\u5165\u5B50\u4EFB\u52A1\uFF0C\u56DE\u8F66\u6DFB\u52A0\u5B50\u4EFB\u52A1"),icon:t.addsubLoad>0?"ios-loading":"",enterkeyhint:"done"},on:{"on-blur":t.addsubChackClose,"on-keydown":t.addsubKeydown},model:{value:t.addsubName,callback:function(i){t.addsubName=i},expression:"addsubName"}}):e("div",{staticClass:"add-button",on:{click:t.addsubOpen}},[e("i",{staticClass:"taskfont"},[t._v("\uE6F2")]),e("span",[t._v(t._s(t.$L("\u6DFB\u52A0\u5B50\u4EFB\u52A1")))])])],1)])]):t._e()],1),t.menuList.length>0?e("div",{staticClass:"add"},[e("EDropdown",{attrs:{trigger:"click",placement:"bottom"},on:{command:t.dropAdd}},[e("div",{staticClass:"add-button"},[e("i",{staticClass:"taskfont"},[t._v("\uE6F2")]),e("span",[t._v(t._s(t.$L("\u6DFB\u52A0")))]),e("em",[t._v(t._s(t.menuText))])]),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},t._l(t.menuList,function(i,a){return e("EDropdownItem",{key:a,attrs:{command:i.command}},[e("div",{staticClass:"item"},[e("i",{staticClass:"taskfont",domProps:{innerHTML:t._s(i.icon)}}),t._v(t._s(t.$L(i.name))+" ")])])}),1)],1)],1):t._e(),e("EDropdown",{ref:"eDropdownRef",staticClass:"calculate-dropdown",attrs:{trigger:"click",placement:"bottom"},on:{command:t.dropVisible}},[e("div",{staticClass:"calculate-content"}),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},[e("EDropdownItem",{attrs:{command:1}},[e("div",{staticClass:"task-menu-icon"},[t.taskDetail.visibility==1?e("Icon",{staticClass:"completed",attrs:{type:"md-checkmark-circle"}}):e("Icon",{staticClass:"uncomplete",attrs:{type:"md-radio-button-off"}}),t._v(" "+t._s(t.$L("\u9879\u76EE\u4EBA\u5458"))+" ")],1)]),e("EDropdownItem",{attrs:{command:2}},[e("div",{staticClass:"task-menu-icon"},[t.taskDetail.visibility==2?e("Icon",{staticClass:"completed",attrs:{type:"md-checkmark-circle"}}):e("Icon",{staticClass:"uncomplete",attrs:{type:"md-radio-button-off"}}),t._v(" "+t._s(t.$L("\u4EFB\u52A1\u4EBA\u5458"))+" ")],1)]),e("EDropdownItem",{attrs:{command:3}},[e("div",{staticClass:"task-menu-icon"},[t.taskDetail.visibility==3?e("Icon",{staticClass:"completed",attrs:{type:"md-checkmark-circle"}}):e("Icon",{staticClass:"uncomplete",attrs:{type:"md-radio-button-off"}}),t._v(" "+t._s(t.$L("\u6307\u5B9A\u6210\u5458"))+" ")],1)])],1)],1),e("EDropdown",{ref:"eDeadlineRef",staticClass:"calculate-dropdown",attrs:{trigger:"click",placement:"bottom"},on:{command:t.dropDeadline}},[e("div",{staticClass:"calculate-content"}),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},[e("EDropdownItem",{attrs:{command:1}},[t._v(" "+t._s(t.$L("\u4EFB\u52A1\u5EF6\u671F"))+" ")]),e("EDropdownItem",{attrs:{command:2}},[t._v(" "+t._s(t.$L("\u4FEE\u6539\u65F6\u95F4"))+" ")])],1)],1),e("EDropdown",{ref:"eFileRef",staticClass:"calculate-dropdown",attrs:{trigger:"click",placement:"bottom"},on:{command:t.dropFile}},[e("div",{staticClass:"calculate-content"}),e("EDropdownMenu",{attrs:{slot:"dropdown"},slot:"dropdown"},[e("EDropdownItem",{attrs:{command:1}},[t._v(" "+t._s(t.$L("\u67E5\u770B\u9644\u4EF6"))+" ")]),e("EDropdownItem",{attrs:{command:2}},[t._v(" "+t._s(t.$L("\u4E0B\u8F7D\u9644\u4EF6"))+" ")]),e("EDropdownItem",{staticClass:"task-calc-warn-text",attrs:{command:3}},[t._v(" "+t._s(t.$L("\u5220\u9664\u9644\u4EF6"))+" ")])],1)],1)],1),e("TaskUpload",{ref:"upload",staticClass:"upload",on:{"on-select-file":t.onSelectFile}})],1),e("div",{directives:[{name:"show",rawName:"v-show",value:t.taskDetail.id>0,expression:"taskDetail.id > 0"}],staticClass:"task-dialog",style:t.dialogStyle},[t.hasOpenDialog?[t.taskId>0?e("DialogWrapper",{ref:"dialog",attrs:{"dialog-id":t.taskDetail.dialog_id}},[e("div",{staticClass:"head",attrs:{slot:"head"},slot:"head"},[e("Icon",{staticClass:"icon",attrs:{type:"ios-chatbubbles-outline"}}),e("div",{staticClass:"nav"},[e("p",{class:{active:t.navActive=="dialog"},on:{click:function(i){t.navActive="dialog"}}},[t._v(t._s(t.$L("\u804A\u5929")))]),e("p",{class:{active:t.navActive=="log"},on:{click:function(i){t.navActive="log"}}},[t._v(t._s(t.$L("\u52A8\u6001")))]),t.navActive=="log"?e("div",{staticClass:"refresh"},[t.logLoadIng?e("Loading"):e("Icon",{attrs:{type:"ios-refresh"},on:{click:t.getLogLists}})],1):t._e()])],1)]):t._e(),t.navActive=="log"&&t.taskId>0?e("ProjectLog",{ref:"log",attrs:{"task-id":t.taskDetail.id},on:{"on-load-change":t.logLoadChange}}):t._e()]:e("div",[e("div",{staticClass:"head"},[e("Icon",{staticClass:"icon",attrs:{type:"ios-chatbubbles-outline"}}),e("div",{staticClass:"nav"},[e("p",{class:{active:t.navActive=="dialog"},on:{click:function(i){t.navActive="dialog"}}},[t._v(t._s(t.$L("\u804A\u5929")))]),e("p",{class:{active:t.navActive=="log"},on:{click:function(i){t.navActive="log"}}},[t._v(t._s(t.$L("\u52A8\u6001")))]),t.navActive=="log"?e("div",{staticClass:"refresh"},[t.logLoadIng?e("Loading"):e("Icon",{attrs:{type:"ios-refresh"},on:{click:t.getLogLists}})],1):t._e()]),e("div",{staticClass:"menu"},[t.navActive=="dialog"&&t.taskDetail.msg_num>0?e("div",{staticClass:"menu-item",on:{click:function(i){return i.stopPropagation(),t.onSend("open")}}},[t.openLoad>0?e("div",{staticClass:"menu-load"},[e("Loading")],1):t._e(),t._v(" "+t._s(t.$L("\u4EFB\u52A1\u804A\u5929"))+" "),e("em",[t._v("("+t._s(t.taskDetail.msg_num>999?"999+":t.taskDetail.msg_num)+")")]),e("i",{staticClass:"taskfont"},[t._v("\uE703")])]):t._e()])],1),t.navActive=="log"&&t.taskId>0?e("ProjectLog",{ref:"log",attrs:{"task-id":t.taskDetail.id,"show-load":!1},on:{"on-load-change":t.logLoadChange}}):e("div",{staticClass:"no-dialog",on:{drop:function(i){return i.preventDefault(),t.taskPasteDrag(i,"drag")},dragover:function(i){return i.preventDefault(),t.taskDragOver(!0,i)},dragleave:function(i){return i.preventDefault(),t.taskDragOver(!1,i)}}},[e("div",{staticClass:"no-tip"},[t._v(t._s(t.$L("\u6682\u65E0\u6D88\u606F")))]),e("div",{staticClass:"no-input"},[e("ChatInput",{ref:"chatInput",attrs:{"task-id":t.taskId,loading:t.sendLoad>0,maxlength:2e5,placeholder:t.$L("\u8F93\u5165\u6D88\u606F..."),"send-menu":!1},on:{"on-more":t.onEventMore,"on-file":t.onSelectFile,"on-record":t.onRecord,"on-send":t.onSend},model:{value:t.msgText,callback:function(i){t.msgText=i},expression:"msgText"}})],1),t.dialogDrag?e("div",{staticClass:"drag-over",on:{click:function(i){t.dialogDrag=!1}}},[e("div",{staticClass:"drag-text"},[t._v(t._s(t.$L("\u62D6\u52A8\u5230\u8FD9\u91CC\u53D1\u9001")))])]):t._e()])],1)],2),t.taskDetail.id?t._e():e("div",{staticClass:"task-load"},[e("Loading")],1),e("TaskExistTips",{ref:"taskExistTipsRef",on:{onAdd:function(i){return t.updateData("times",t.updateParams)}}}),e("Modal",{attrs:{title:t.$L("\u4EFB\u52A1\u5EF6\u671F"),"mask-closable":!1,styles:{width:"90%",maxWidth:"450px"}},model:{value:t.delayTaskShow,callback:function(i){t.delayTaskShow=i},expression:"delayTaskShow"}},[e("Form",{ref:"formDelayTaskRef",attrs:{model:t.delayTaskForm,rules:t.delayTaskRule,"label-position":"left","label-width":"auto"},nativeOn:{submit:function(i){i.preventDefault()}}},[e("FormItem",{attrs:{label:t.$L("\u5EF6\u671F\u65F6\u957F"),prop:"time"}},[e("Input",{attrs:{type:"number",placeholder:t.$L("\u8BF7\u8F93\u5165\u65F6\u957F")},scopedSlots:t._u([{key:"append",fn:function(){return[e("Select",{staticStyle:{width:"auto"},model:{value:t.delayTaskForm.type,callback:function(i){t.$set(t.delayTaskForm,"type",i)},expression:"delayTaskForm.type"}},[e("Option",{attrs:{value:"hour"}},[t._v(t._s(t.$L("\u5C0F\u65F6")))]),e("Option",{attrs:{value:"day"}},[t._v(t._s(t.$L("\u5929")))])],1)]},proxy:!0}]),model:{value:t.delayTaskForm.time,callback:function(i){t.$set(t.delayTaskForm,"time",i)},expression:"delayTaskForm.time"}})],1),e("FormItem",{attrs:{label:t.$L("\u5EF6\u671F\u5907\u6CE8"),prop:"remark"}},[e("Input",{attrs:{type:"textarea",placeholder:t.$L("\u8BF7\u8F93\u5165\u4FEE\u6539\u5907\u6CE8")},model:{value:t.delayTaskForm.remark,callback:function(i){t.$set(t.delayTaskForm,"remark",i)},expression:"delayTaskForm.remark"}})],1)],1),e("div",{attrs:{slot:"footer"},slot:"footer"},[e("Button",{on:{click:function(i){t.delayTaskShow=!1}}},[t._v(t._s(t.$L("\u5173\u95ED")))]),e("Button",{attrs:{type:"primary",loading:t.delayTaskLoading},on:{click:t.onDelay}},[t._v(t._s(t.$L("\u786E\u5B9A")))])],1)],1),e("Modal",{attrs:{title:t.$L("\u4EFB\u52A1\u63CF\u8FF0\u5386\u53F2\u8BB0\u5F55"),"mask-closable":!1,styles:{width:"90%",maxWidth:"700px"}},model:{value:t.historyShow,callback:function(i){t.historyShow=i},expression:"historyShow"}},[t.historyShow?e("TaskContentHistory",{attrs:{"task-id":t.taskDetail.id,"task-name":t.taskDetail.name}}):t._e(),e("div",{attrs:{slot:"footer"},slot:"footer"},[e("Button",{on:{click:function(i){t.historyShow=!1}}},[t._v(t._s(t.$L("\u5173\u95ED")))])],1)],1)],1):t._e()},G=[];const X={name:"TaskDetail",components:{TaskContentHistory:q,TEditorTask:H,UserSelect:_,TaskExistTips:I,ChatInput:w,TaskMenu:v,ProjectLog:k,DialogWrapper:b,TaskUpload:U,TaskPriority:g},props:{taskId:{type:Number,default:0},openTask:{type:Object,default:()=>({})},mainEndAt:{default:null},canUpdateBlur:{type:Boolean,default:!0},modalMode:{type:Boolean,default:!1}},data(){return{ready:!1,taskDetail:{},ownerData:{},ownerLoad:0,receiveShow:!1,assistForce:!1,assistData:{},assistLoad:0,visibleForce:!1,addsubForce:!1,addsubShow:!1,addsubName:"",addsubLoad:0,timeForce:!1,timeOpen:!1,timeValue:[],timeOptions:{shortcuts:$A.timeOptionShortcuts()},loopForce:!1,nowTime:$A.dayjs().unix(),nowInterval:null,msgText:"",msgFile:[],msgRecord:{},navActive:"dialog",logLoadIng:!1,sendLoad:0,openLoad:0,dialogDrag:!1,imageAttachment:!0,receiveTaskSubscribe:null,loops:[{key:"never",label:"\u4ECE\u4E0D"},{key:"day",label:"\u6BCF\u5929"},{key:"weekdays",label:"\u6BCF\u4E2A\u5DE5\u4F5C\u65E5"},{key:"week",label:"\u6BCF\u5468"},{key:"twoweeks",label:"\u6BCF\u4E24\u5468"},{key:"month",label:"\u6BCF\u6708"},{key:"year",label:"\u6BCF\u5E74"},{key:"custom",label:"\u81EA\u5B9A\u4E49"}],updateParams:{},delayTaskShow:!1,delayTaskLoading:!1,delayTaskForm:{type:"hour",time:"24",remark:""},delayTaskRule:{time:[{required:!0,message:this.$L("\u8BF7\u8F93\u5165\u65F6\u957F"),trigger:"blur"}],remark:[{required:!0,message:this.$L("\u8BF7\u8F93\u5165\u5907\u6CE8"),trigger:"blur"}]},historyShow:!1}},created(){const t=$A.getObject(this.$route.query,"navActive");["dialog","log"].includes(t)&&(this.navActive=t),$A.IDBJson("delayTaskForm").then(s=>{s.type&&this.$set(this.delayTaskForm,"type",s.type),s.time&&this.$set(this.delayTaskForm,"time",s.time)})},mounted(){this.nowInterval=setInterval(()=>{this.nowTime=$A.dayjs().unix()},1e3),this.receiveTaskSubscribe=D.Store.subscribe("receiveTask",()=>{this.receiveShow=!0})},destroyed(){clearInterval(this.nowInterval),this.receiveTaskSubscribe&&(this.receiveTaskSubscribe.unsubscribe(),this.receiveTaskSubscribe=null)},computed:{...f(["systemConfig","cacheProjects","cacheColumns","cacheTasks","taskContents","taskFiles","taskPriority","dialogId"]),projectName(){if(!this.taskDetail.project_id)return"";if(this.taskDetail.project_name)return this.taskDetail.project_name;const t=this.cacheProjects.find(({id:s})=>s==this.taskDetail.project_id);return t?t.name:""},columnName(){if(!this.taskDetail.column_id)return"";if(this.taskDetail.column_name)return this.taskDetail.column_name;const t=this.cacheColumns.find(({id:s})=>s==this.taskDetail.column_id);return t?t.name:""},taskContent(){if(!this.taskId)return"";let t=this.taskContents.find(({task_id:s})=>s==this.taskId);return t?t.content:""},fileList(){return this.taskId?this.taskFiles.filter(({task_id:t})=>t==this.taskId).sort((t,s)=>s.id-t.id):[]},subList(){return this.taskId?this.cacheTasks.filter(t=>t.parent_id==this.taskId).sort((t,s)=>t.id-s.id):[]},hasOpenDialog(){return this.taskDetail.dialog_id>0&&this.windowLandscape},dialogStyle(){const{windowHeight:t,hasOpenDialog:s}=this,e=Math.min(1100,t);if(!e)return{};if(!s)return{};const i=e>900?200:70;return{minHeight:e-i-48+"px"}},taskDetailStyle(){const{modalMode:t,windowHeight:s,hasOpenDialog:e}=this,i=Math.min(1100,s);if(t&&e){const a=i>900?200:70;return{maxHeight:i-a-30+"px"}}return{}},cutTime(){const{taskDetail:t}=this;let s=$A.dayjs(t.start_at),e=$A.dayjs(t.end_at),i="";return s.format("YYYY/MM/DD")==e.format("YYYY/MM/DD")?i=s.format("YYYY/MM/DD HH:mm")+" ~ "+e.format("HH:mm"):s.year()==e.year()?(i=s.format("YYYY/MM/DD HH:mm")+" ~ "+e.format("MM/DD HH:mm"),i=i.replace(/( 00:00| 23:59)/g,"")):(i=s.format("YYYY/MM/DD HH:mm")+e.format("YYYY/MM/DD HH:mm"),i=i.replace(/( 00:00| 23:59)/g,"")),i},getOwner(){const{taskDetail:t}=this;return $A.isArray(t.task_user)?t.task_user.filter(({owner:s})=>s===1).sort((s,e)=>s.id-e.id):[]},getAssist(){const{taskDetail:t}=this;return $A.isArray(t.task_user)?t.task_user.filter(({owner:s})=>s===0).sort((s,e)=>s.id-e.id):[]},menuList(){const{taskDetail:t}=this,s=[];return t.p_name||s.push({command:"priority",icon:"&#xe6ec;",name:"\u4F18\u5148\u7EA7"}),$A.isArray(t.task_user)&&t.task_user.find(({owner:e})=>e===0)||s.push({command:"assist",icon:"&#xe63f;",name:"\u534F\u52A9\u4EBA\u5458"}),t.visibility<=1&&!this.visibleKeep&&s.push({command:"visible",icon:"&#xe77b;",name:"\u53EF\u89C1\u6027"}),t.end_at||s.push({command:"times",icon:"&#xe6e8;",name:"\u622A\u6B62\u65F6\u95F4"}),(!t.loop||t.loop=="never")&&s.push({command:"loop",icon:"&#xe93f;",name:"\u91CD\u590D\u5468\u671F"}),this.fileList.length==0&&s.push({command:"file",icon:"&#xe6e6;",name:"\u9644\u4EF6"}),this.subList.length==0&&s.push({command:"subtask",icon:"&#xe6f0;",name:"\u5B50\u4EFB\u52A1"}),s},menuText(){const{menuList:t}=this;let s="";return t.length>0&&t.forEach((e,i)=>{i>0&&(s+=" / "),s+=this.$L(e.name)}),s},visibleKeep(){return this.systemConfig.task_visible==="open"}},watch:{openTask:{handler(t){this.taskDetail=$A.cloneJSON(t),this.__openTask&&clearTimeout(this.__openTask),this.__openTask=setTimeout(s=>{var e;return(e=this.$refs.name)==null?void 0:e.resizeTextarea()},100)},immediate:!0,deep:!0},taskId:{handler(t){t>0?this.ready=!0:(this.windowPortrait&&$A.onBlur(),this.timeOpen=!1,this.timeForce=!1,this.loopForce=!1,this.assistForce=!1,this.visibleForce=!1,this.addsubForce=!1,this.receiveShow=!1,this.$refs.chatInput&&this.$refs.chatInput.hidePopover())},immediate:!0},getOwner:{handler(t){const s=t.map(({userid:e})=>e);this.$set(this.taskDetail,"owner_userid",s),this.$set(this.ownerData,"owner_userid",s),this.$set(this.assistData,"disabled",t.map(({userid:e})=>e).filter(e=>e!=this.userId))},immediate:!0},getAssist:{handler(t){const s=t.map(({userid:e})=>e);this.$set(this.taskDetail,"assist_userid",s),this.$set(this.assistData,"assist_userid",s)},immediate:!0},receiveShow(t){t&&(this.timeValue=this.taskDetail.end_at?[this.taskDetail.start_at,this.taskDetail.end_at]:[])},"taskDetail.visibility_appointor":{handler(t){(t==null?void 0:t.filter(s=>s).length)>0&&(this.taskDetail.visibility=3,this.updateVisible())},immediate:!0}},methods:{within24Hours(t){return $A.dayjs(t).unix()-this.nowTime<86400},expiresFormat(t){return $A.countDownFormat(this.nowTime,t)},tagColor(t){return t.overdue?"red":t.today?"orange":"blue"},loopLabel(t){const s=this.loops.find(e=>e.key===t);return s?s.label:t?`\u6BCF${t}\u5929`:"\u4ECE\u4E0D"},onNameKeydown(t){t.keyCode===13&&(t.shiftKey||(t.preventDefault(),this.updateData("name")))},checkUpdate(t){let s=!1;if(this.openTask.name!=this.taskDetail.name)if(s=!0,t===!0)this.updateData("name");else return t===!1&&this.$refs.name.focus(),!0;if(this.$refs.desc&&this.$refs.desc.getContent()!=this.taskContent)if(s=!0,t===!0)this.updateData("content");else return t===!1&&this.$refs.desc.focus(),!0;if(this.addsubShow&&this.addsubName)if(s=!0,t===!0)this.onAddsub();else return t===!1&&this.$refs.addsub.focus(),!0;return this.subList.some(({id:e})=>{this.$refs[`subTask_${e}`][0].checkUpdate(t)&&(s=!0)}),s},onHistory(){this.historyShow=!0},updateBlur(t,s){this.canUpdateBlur&&this.updateData(t,s)},updateData(t,s){let e=null;switch(t){case"priority":this.$set(this.taskDetail,"p_level",s.priority),this.$set(this.taskDetail,"p_name",s.name),this.$set(this.taskDetail,"p_color",s.color),t=["p_level","p_name","p_color"];break;case"times":if(this.taskDetail.start_at&&(Math.abs($A.dayjs(this.taskDetail.start_at).unix()-$A.dayjs(s.start_at).unix())>60||Math.abs($A.dayjs(this.taskDetail.end_at).unix()-$A.dayjs(s.end_at).unix())>60)&&typeof s.desc=="undefined"){$A.modalInput({title:`\u4FEE\u6539${this.taskDetail.parent_id>0?"\u5B50\u4EFB\u52A1":"\u4EFB\u52A1"}\u65F6\u95F4`,placeholder:"\u8BF7\u8F93\u5165\u4FEE\u6539\u5907\u6CE8",okText:"\u786E\u5B9A",onOk:o=>o?(this.updateParams=Object.assign(s,{desc:o}),this.updateData("times",this.updateParams),!1):"\u8BF7\u8F93\u5165\u4FEE\u6539\u5907\u6CE8"});return}if(typeof s.existTips=="undefined"&&(this.updateParams=Object.assign(s,{existTips:!0}),s.start_at&&s.end_at&&this.$refs.taskExistTipsRef)){this.$refs.taskExistTipsRef.isExistTask({taskid:this.taskDetail.id,userids:this.taskDetail.owner_userid,timerange:[s.start_at,s.end_at]}).then(o=>{o||this.updateData("times",this.updateParams)});return}this.$set(this.taskDetail,"times",[s.start_at,s.end_at,s.desc]);break;case"loop":if(s==="custom"){this.customLoop();return}this.$set(this.taskDetail,"loop",s);break;case"content":const a=this.$refs.desc.getContent();if(a==this.taskContent.replace(/\s+original-(width|height)="[^"]*"/g,""))return;if(!this.windowTouch||s==="force"){this.updateData("contentSave",{content:a});return}$A.modalConfirm({title:"\u6E29\u99A8\u63D0\u793A",content:"\u662F\u5426\u4FDD\u5B58\u7F16\u8F91\u5185\u5BB9\uFF1F",onOk:()=>{this.updateData("contentSave",{content:a})},onCancel:()=>{this.$refs.desc.updateContent(this.taskContent)}});return;case"contentSave":this.$set(this.taskDetail,"content",s.content),t="content",e=()=>{this.$store.dispatch("saveTaskContent",{task_id:this.taskId,content:s.content})};break}let i={task_id:this.taskDetail.id};($A.isArray(t)?t:[t]).forEach(a=>{let o=this.taskDetail[a],n=this.openTask[a];$A.jsonStringify(o)!=$A.jsonStringify(n)&&(i[a]=o)}),!(Object.keys(i).length<=1)&&this.$store.dispatch("taskUpdate",i).then(({msg:a})=>{$A.messageSuccess(a),typeof e=="function"&&e()}).catch(({msg:a})=>{$A.modalError(a)})},customLoop(){let t=this.taskDetail.loop||1;$A.Modal.confirm({render:s=>s("div",[s("div",{style:{fontSize:"16px",fontWeight:"500",marginBottom:"20px"}},this.$L("\u91CD\u590D\u5468\u671F")),s("Input",{style:{width:"160px",margin:"0 auto"},props:{type:"number",value:t,maxlength:3},on:{input:e=>{t=$.runNum(e)}}},[s("span",{slot:"prepend"},this.$L("\u6BCF")),s("span",{slot:"append"},this.$L("\u5929"))])]),onOk:s=>{this.$Modal.remove(),t>0&&this.updateData("loop",t)},loading:!0,okText:this.$L("\u786E\u5B9A"),cancelText:this.$L("\u53D6\u6D88")})},async taskTimeChange(){const t=$A.newDateString(this.timeValue,"YYYY-MM-DD HH:mm");$A.rightExists(t[0],"00:00")&&$A.rightExists(t[1],"23:59")&&(this.timeValue=await this.$store.dispatch("taskDefaultTime",t))},async onOwner(t){let s={task_id:this.taskDetail.id,owner:this.ownerData.owner_userid};if(t===!0){if(this.getOwner.length>0){this.receiveShow=!1,$A.messageError("\u4EFB\u52A1\u5DF2\u88AB\u9886\u53D6");return}const e=$A.newDateString(this.timeValue,"YYYY-MM-DD HH:mm");if(!(e[0]&&e[1])){$A.messageError("\u8BF7\u8BBE\u7F6E\u8BA1\u5212\u65F6\u95F4");return}s.times=e,s.owner=this.ownerData.owner_userid=[this.userId]}if($A.jsonStringify(this.taskDetail.owner_userid)!==$A.jsonStringify(this.ownerData.owner_userid))return $A.count(s.owner)==0&&(s.owner=""),this.ownerLoad++,new Promise((e,i)=>{this.$store.dispatch("taskUpdate",s).then(({msg:a})=>{$A.messageSuccess(a),this.ownerLoad--,this.receiveShow=!1,this.$store.dispatch("getTaskOne",this.taskDetail.id).catch(()=>{}),e()}).catch(({msg:a})=>{$A.modalError(a),this.ownerLoad--,this.receiveShow=!1,i()})})},onAssist(){if($A.jsonStringify(this.taskDetail.assist_userid)!==$A.jsonStringify(this.assistData.assist_userid))return new Promise((t,s)=>{this.getOwner.find(({userid:e})=>e===this.userId)&&this.assistData.assist_userid.find(e=>e===this.userId)?$A.modalConfirm({content:"\u4F60\u5F53\u524D\u662F\u8D1F\u8D23\u4EBA\uFF0C\u786E\u5B9A\u8981\u8F6C\u4E3A\u534F\u52A9\u4EBA\u5458\u5417\uFF1F",cancelText:"\u53D6\u6D88",okText:"\u786E\u5B9A",onOk:()=>{this.onAssistConfirm().then(t).catch(s)},onCancel:()=>{s()}}):this.onAssistConfirm().then(t).catch(s)})},onAssistConfirm(){return new Promise((t,s)=>{let e=this.assistData.assist_userid;e.length===0&&(e=!1),this.assistLoad++,this.$store.dispatch("taskUpdate",{task_id:this.taskDetail.id,assist:e}).then(({msg:i})=>{$A.messageSuccess(i),this.assistLoad--,this.$store.dispatch("getTaskOne",this.taskDetail.id).catch(()=>{}),t()}).catch(({msg:i})=>{$A.modalError(i),this.assistLoad--,s()})})},openTime(){this.timeOpen=!this.timeOpen,this.timeOpen&&(this.timeValue=this.taskDetail.end_at?[this.taskDetail.start_at,this.taskDetail.end_at]:[])},timeChange(t){t||(this.timeOpen=!1)},timeClear(){this.updateData("times",{start_at:!1,end_at:!1}),this.timeOpen=!1},timeOk(){const t=$A.newDateString(this.timeValue,"YYYY-MM-DD HH:mm");this.updateData("times",{start_at:t[0],end_at:t[1]}),this.timeOpen=!1},addsubOpen(){this.addsubShow=!0,this.$nextTick(()=>{this.$refs.addsub.focus()})},addsubChackClose(){this.addsubName==""&&(this.addsubShow=!1)},addsubKeydown(t){if(t.keyCode===13){if(t.shiftKey||this.addsubLoad>0)return;t.preventDefault(),this.onAddsub()}},onAddsub(){if(this.addsubName==""){$A.messageError("\u4EFB\u52A1\u63CF\u8FF0\u4E0D\u80FD\u4E3A\u7A7A");return}this.addsubLoad++,this.$store.dispatch("taskAddSub",{task_id:this.taskDetail.id,name:this.addsubName}).then(({msg:t})=>{$A.messageSuccess(t),this.addsubLoad--,this.addsubName=""}).catch(({msg:t})=>{$A.modalError(t),this.addsubLoad--})},getLogLists(){this.navActive=="log"&&this.$refs.log.getLists(!0)},logLoadChange(t){this.logLoadIng=t},dropAdd(t){switch(t){case"priority":this.$set(this.taskDetail,"p_name",this.$L("\u672A\u8BBE\u7F6E")),this.$nextTick(()=>{this.$refs.priority.show()});break;case"assist":this.assistForce=!0,this.$nextTick(()=>{this.$refs.assist.onSelection()});break;case"visible":this.visibleForce=!0,this.$nextTick(()=>{this.showCisibleDropdown(null)});break;case"times":this.timeForce=!0,this.$nextTick(()=>{this.openTime()});break;case"loop":this.loopForce=!0,this.$nextTick(()=>{this.$refs.loop.show()});break;case"file":this.onUploadClick(!0);break;case"subtask":this.addsubForce=!0,this.$nextTick(()=>{this.addsubOpen()});break}},onEventMore(t){["image","file"].includes(t)&&this.onUploadClick(!1)},onUploadClick(t){this.imageAttachment=!!t,this.$refs.upload.handleClick()},msgDialog(t=null,s=!1){this.sendLoad>0||this.openLoad>0||(s===!0?this.openLoad++:this.sendLoad++,this.$store.dispatch("call",{url:"project/task/dialog",data:{task_id:this.taskDetail.id}}).then(({data:e})=>{this.$store.dispatch("saveTask",{id:e.id,dialog_id:e.dialog_id}),this.$store.dispatch("saveDialog",e.dialog_data),$A.isSubElectron?this.resizeDialog().then(()=>{this.sendDialogMsg(t)}):this.$nextTick(()=>{if(this.windowPortrait){$A.onBlur();const i={time:$A.dayjs().unix()+10,msgRecord:this.msgRecord,msgFile:this.msgFile,msgText:typeof t=="string"&&t?t:this.msgText,dialogId:e.dialog_id};this.msgRecord={},this.msgFile=[],this.msgText="",this.$nextTick(a=>{this.dialogId>0&&this.$store.dispatch("openTask",0),this.$store.dispatch("openDialog",e.dialog_id).then(o=>{this.$store.state.dialogMsgTransfer=i})})}else this.sendDialogMsg(t)})}).catch(({msg:e})=>{$A.modalError(e)}).finally(e=>{s===!0?this.openLoad--:this.sendLoad--}))},sendDialogMsg(t=null){this.msgFile.length>0?this.$refs.dialog.sendFileMsg(this.msgFile.map(s=>Object.assign(s,{ajaxExtraData:{image_attachment:this.imageAttachment?1:0}}))):this.msgText?this.$refs.dialog.sendMsg(this.msgText):typeof t=="string"&&t&&this.$refs.dialog.sendMsg(t),this.msgFile=[],this.msgText=""},taskPasteDrag(t,s){if(this.dialogDrag=!1,$A.dataHasFolder(s==="drag"?t.dataTransfer:t.clipboardData)){t.preventDefault(),$A.modalWarning(`\u6682\u4E0D\u652F\u6301${s==="drag"?"\u62D6\u62FD":"\u7C98\u8D34"}\u6587\u4EF6\u5939\u3002`);return}const e=s==="drag"?t.dataTransfer.files:t.clipboardData.files;this.msgFile=Array.prototype.slice.call(e),this.msgFile.length>0&&(t.preventDefault(),this.msgDialog())},taskDragOver(t,s){let e=this.__dialogDrag=$A.randomString(8);if(!t)setTimeout(()=>{e===this.__dialogDrag&&(this.dialogDrag=t)},150);else{if(s.dataTransfer.effectAllowed==="move")return;this.dialogDrag=!0}},onSelectFile(t){this.msgFile=$A.isArray(t)?t:[t],this.msgDialog()},onRecord(t){this.msgRecord=t,this.msgDialog()},onSend(t){this.$refs.chatInput&&this.$refs.chatInput.hidePopover(),t==="open"?this.msgDialog(null,!0):this.msgDialog(t)},deleteFile(t){this.$set(t,"_show_menu",!1),this.$store.dispatch("forgetTaskFile",t.id),this.$store.dispatch("call",{url:"project/task/filedelete",data:{file_id:t.id}}).catch(({msg:s})=>{$A.modalError(s),this.$store.dispatch("getTaskFiles",this.taskDetail.id)})},openMenu(t,s){const e=this.$refs[`taskMenu_${s.id}`];e&&e.handleClick(t)},openNewWin(){let t={title:this.taskDetail.name,titleFixed:!0,parent:null,width:Math.min(window.screen.availWidth,this.$el.clientWidth+72),height:Math.min(window.screen.availHeight,this.$el.clientHeight+72),minWidth:600,minHeight:450};this.hasOpenDialog&&(t.minWidth=800,t.minHeight=600),this.$store.dispatch("openChildWindow",{name:`task-${this.taskDetail.id}`,path:`/single/task/${this.taskDetail.id}?navActive=${this.navActive}`,force:!1,config:t}),this.$store.dispatch("openTask",0)},resizeDialog(){return new Promise(t=>{this.$Electron.sendMessage("windowSize",{width:Math.max(1100,this.windowWidth),height:Math.max(720,this.windowHeight),minWidth:800,minHeight:600,autoZoom:!0});let s=0,e=setInterval(()=>{s++,(this.$refs.dialog||s>20)&&(clearInterval(e),this.$refs.dialog&&t())},100)})},viewFile(t){if(["jpg","jpeg","webp","gif","png"].includes(t.ext)){const e=this.fileList.filter(a=>["jpg","jpeg","webp","gif","png"].includes(a.ext)),i=e.findIndex(a=>a.id===t.id);i>-1?this.$store.dispatch("previewImage",{index:i,list:e.map(a=>({src:a.path,width:a.width,height:a.height}))}):this.$store.dispatch("previewImage",{index:0,list:[{src:t.path,width:t.width,height:t.height}]});return}const s=`/single/file/task/${t.id}`;this.$Electron?this.$store.dispatch("openChildWindow",{name:`file-task-${t.id}`,path:s,userAgent:"/hideenOfficeTitle/",force:!1,config:{title:`${t.name} (${$A.bytesToSize(t.size)})`,titleFixed:!0,parent:null,width:Math.min(window.screen.availWidth,1440),height:Math.min(window.screen.availHeight,900)},webPreferences:{nodeIntegrationInSubFrames:t.ext==="drawio"}}):this.$isEEUiApp?this.$store.dispatch("openAppChildPage",{pageType:"app",pageTitle:`${t.name} (${$A.bytesToSize(t.size)})`,url:"web.js",params:{titleFixed:!0,allowAccess:!0,url:$A.rightDelete(window.location.href,window.location.hash)+`#${s}`}}):window.open($A.mainUrl(s.substring(1)))},downFile(t){$A.modalConfirm({title:"\u4E0B\u8F7D\u6587\u4EF6",content:`${t.name} (${$A.bytesToSize(t.size)})`,okText:"\u7ACB\u5373\u4E0B\u8F7D",onOk:()=>{this.$store.dispatch("downUrl",$A.apiUrl(`project/task/filedown?file_id=${t.id}`))}})},showDropdown(t,s){const e=this.$refs.scroller.$el.getBoundingClientRect(),i=t.$el;i.style.top=s.top-e.top+"px",i.style.left=s.left-e.left+"px",i.style.width=s.width+"px",i.style.height=s.height+"px",t.visible&&t.hide(),setTimeout(()=>{t.show()},0)},showCisibleDropdown(t){var e;let s=null;t===null?s=(e=this.$refs.visibilityText)==null?void 0:e.getBoundingClientRect():s=t.target.getBoundingClientRect(),s!==null&&this.showDropdown(this.$refs.eDropdownRef,s)},showAtDropdown({target:t}){this.timeOpen=!1,this.showDropdown(this.$refs.eDeadlineRef,t.getBoundingClientRect())},visibleUserSelectShowChange(t){if(!t&&this.taskDetail.visibility_appointor.filter(s=>s).length==0){let s=this.taskDetail.old_visibility;this.taskDetail.visibility=s>2?1:s||1,this.taskDetail.visibility<3&&this.updateVisible()}},dropVisible(t){switch(t){case 1:case 2:this.taskDetail.visibility=t,this.updateVisible();break;case 3:this.taskDetail.old_visibility=this.taskDetail.visibility,this.taskDetail.visibility=t,this.$nextTick(()=>{this.$refs.visibleUserSelectRef.onSelection()});break}},dropDeadline(t){switch(t){case 1:this.delayTaskShow=!0;break;case 2:this.openTime();break}},onDelay(){this.$refs.formDelayTaskRef.validate(t=>{if(!t)return;this.delayTaskLoading=!0;let s=$A.dayjs(this.taskDetail.end_at);this.delayTaskForm.type==="day"?s=s.add(this.delayTaskForm.time,"day"):s=s.add(this.delayTaskForm.time,"hour"),this.$store.dispatch("taskUpdate",{task_id:this.taskDetail.id,times:[this.taskDetail.start_at,s.format("YYYY-MM-DD HH:mm:ss"),this.delayTaskForm.remark]}).then(({msg:e})=>{$A.messageSuccess(e),this.delayTaskLoading=!1,this.delayTaskShow=!1,this.delayTaskForm.remark="",this.$store.dispatch("getTaskOne",this.taskDetail.id).catch(()=>{}),$A.IDBSet("delayTaskForm",this.delayTaskForm)}).catch(({msg:e})=>{$A.modalError(e),this.delayTaskLoading=!1})})},showFileDropdown(t,{target:s}){this.operationFile=t,this.showDropdown(this.$refs.eFileRef,s.getBoundingClientRect())},dropFile(t){switch(t){case 1:this.viewFile(this.operationFile);break;case 2:this.downFile(this.operationFile);break;case 3:$A.modalConfirm({title:"\u5220\u9664\u6587\u4EF6",content:`\u4F60\u786E\u5B9A\u8981\u5220\u9664\u6587\u4EF6\u3010${this.operationFile.name}\u3011\u5417\uFF1F`,onOk:()=>{this.deleteFile(this.operationFile)}});break}},updateVisible(){this.updateData(["visibility","visibility_appointor"])}}},p={};var Z=l(X,J,G,!1,Q,null,null,null);function Q(t){for(let s in p)this[s]=p[s]}var nt=function(){return Z.exports}();export{H as T,I as a,nt as b};
